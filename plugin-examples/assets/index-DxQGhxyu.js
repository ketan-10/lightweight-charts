(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();function Hi(s){s.borderColor!==void 0&&(s.borderUpColor=s.borderColor,s.borderDownColor=s.borderColor),s.wickColor!==void 0&&(s.wickUpColor=s.wickColor,s.wickDownColor=s.wickColor)}var O=(s=>(s[s.Disabled=0]="Disabled",s[s.Continuous=1]="Continuous",s[s.OnDataUpdate=2]="OnDataUpdate",s))(O||{});function Ni(s){if(s>=1)return 0;let e=0;for(;e<8;e++){const t=Math.round(s);if(Math.abs(t-s)<1e-8)return e;s=s*10}return e}var hi=(s=>(s[s.LastPriceAndPercentageValue=0]="LastPriceAndPercentageValue",s[s.LastValueAccordingToScale=1]="LastValueAccordingToScale",s))(hi||{}),ut=(s=>(s[s.LastBar=0]="LastBar",s[s.LastVisible=1]="LastVisible",s))(ut||{}),W=(s=>(s[s.Simple=0]="Simple",s[s.WithSteps=1]="WithSteps",s[s.Curved=2]="Curved",s))(W||{}),z=(s=>(s[s.Solid=0]="Solid",s[s.Dotted=1]="Dotted",s[s.Dashed=2]="Dashed",s[s.LargeDashed=3]="LargeDashed",s[s.SparseDotted=4]="SparseDotted",s))(z||{});function j(s,e){const i={0:[],1:[s.lineWidth,s.lineWidth],2:[2*s.lineWidth,2*s.lineWidth],3:[6*s.lineWidth,6*s.lineWidth],4:[s.lineWidth,4*s.lineWidth]}[e];s.setLineDash(i)}function ci(s,e,t,i){s.beginPath();const r=s.lineWidth%2?.5:0;s.moveTo(t,e+r),s.lineTo(i,e+r),s.stroke()}function Ui(s,e,t,i){s.beginPath();const r=s.lineWidth%2?.5:0;s.moveTo(e+r,t),s.lineTo(e+r,i),s.stroke()}function Yi(s,e){s.save(),s.lineWidth%2&&s.translate(.5,.5),e(),s.restore()}const Xi={color:"#2196f3"},di={title:"",visible:!0,lastValueVisible:!0,priceLineVisible:!0,priceLineSource:ut.LastBar,priceLineWidth:1,priceLineColor:"",priceLineStyle:z.Dashed,baseLineVisible:!0,baseLineWidth:1,baseLineColor:"#B2B5BE",baseLineStyle:z.Solid,priceFormat:{type:"price",precision:2,minMove:.01}};function k(s,e){if(!s)throw new Error("Assertion failed"+(e?": "+e:""))}function V(s){if(s===void 0)throw new Error("Value is undefined");return s}function m(s){if(s===null)throw new Error("Value is null");return s}function X(s){return m(V(s))}class T{constructor(){this._listeners=[]}subscribe(e,t,i){const r={callback:e,linkedObject:t,singleshot:i===!0};this._listeners.push(r)}unsubscribe(e){const t=this._listeners.findIndex(i=>e===i.callback);t>-1&&this._listeners.splice(t,1)}unsubscribeAll(e){this._listeners=this._listeners.filter(t=>t.linkedObject!==e)}fire(e,t,i){const r=[...this._listeners];this._listeners=this._listeners.filter(n=>!n.singleshot),r.forEach(n=>n.callback(e,t,i))}hasListeners(){return this._listeners.length>0}destroy(){this._listeners=[]}}function A(s,...e){for(const t of e)for(const i in t)t[i]===void 0||!Object.prototype.hasOwnProperty.call(t,i)||["__proto__","constructor","prototype"].includes(i)||(typeof t[i]!="object"||s[i]===void 0||Array.isArray(t[i])?s[i]=t[i]:A(s[i],t[i]));return s}function se(s){return typeof s=="number"&&isFinite(s)}function me(s){return typeof s=="number"&&s%1===0}function Se(s){return typeof s=="string"}function Ce(s){return typeof s=="boolean"}function F(s){const e=s;if(!e||typeof e!="object")return e;let t;Array.isArray(e)?t=[]:t={};let i,r;for(i in e)e.hasOwnProperty(i)&&(r=e[i],r&&typeof r=="object"?t[i]=F(r):t[i]=r);return t}function Gi(s){return s!==null}function ot(s){return s===null?void 0:s}const ui="-apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif";function Be(s,e,t){return t!==void 0?t=`${t} `:t="",e===void 0&&(e=ui),`${t}${s}px ${e}`}class $i{constructor(e){this._rendererOptions={borderSize:1,tickLength:5,fontSize:NaN,font:"",fontFamily:"",color:"",paneBackgroundColor:"",paddingBottom:0,paddingInner:0,paddingOuter:0,paddingTop:0,baselineOffset:0},this._chartModel=e}options(){const e=this._rendererOptions,t=this._fontSize(),i=this._fontFamily();return(e.fontSize!==t||e.fontFamily!==i)&&(e.fontSize=t,e.fontFamily=i,e.font=Be(t,i),e.paddingTop=2.5/12*t,e.paddingBottom=e.paddingTop,e.paddingInner=t/12*e.tickLength,e.paddingOuter=t/12*e.tickLength,e.baselineOffset=0),e.color=this._textColor(),e.paneBackgroundColor=this._paneBackgroundColor(),this._rendererOptions}_textColor(){return this._chartModel.options().layout.textColor}_paneBackgroundColor(){return this._chartModel.backgroundTopColor()}_fontSize(){return this._chartModel.options().layout.fontSize}_fontFamily(){return this._chartModel.options().layout.fontFamily}}function Ye(s){return s<0?0:s>255?255:Math.round(s)||0}function ji(s){return s<=0||s>1?Math.min(Math.max(s,0),1):Math.round(s*1e4)/1e4}function Mt(s){return .199*s[0]+.687*s[1]+.114*s[2]}function Ki(s){const e=document.createElement("div");e.style.display="none",document.body.appendChild(e),e.style.color=s;const t=window.getComputedStyle(e).color;return document.body.removeChild(e),t}class qi{constructor(e,t){this._rgbaCache=new Map,this._customParsers=e,t&&(this._rgbaCache=t)}applyAlpha(e,t){if(e==="transparent")return e;const i=this._parseColor(e),r=i[3];return`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${t*r})`}generateContrastColors(e){const t=this._parseColor(e);return{background:`rgb(${t[0]}, ${t[1]}, ${t[2]})`,foreground:Mt(t)>160?"black":"white"}}colorStringToGrayscale(e){return Mt(this._parseColor(e))}gradientColorAtPercent(e,t,i){const[r,n,o,a]=this._parseColor(e),[l,h,c,d]=this._parseColor(t),u=[Ye(r+i*(l-r)),Ye(n+i*(h-n)),Ye(o+i*(c-o)),ji(a+i*(d-a))];return`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${u[3]})`}_parseColor(e){const t=this._rgbaCache.get(e);if(t)return t;const r=Ki(e).match(/^rgba?\s*\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)$/);if(!r){if(this._customParsers.length)for(const o of this._customParsers){const a=o(e);if(a)return this._rgbaCache.set(e,a),a}throw new Error(`Failed to parse color: ${e}`)}const n=[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),r[4]?parseFloat(r[4]):1];return this._rgbaCache.set(e,n),n}}class _t{constructor(){this._renderers=[]}setRenderers(e){this._renderers=e}draw(e,t,i){this._renderers.forEach(r=>{r.draw(e,t,i)})}}class Q{draw(e,t,i){e.useBitmapCoordinateSpace(r=>this._drawImpl(r,t,i))}}class Zi extends Q{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}_drawImpl({context:e,horizontalPixelRatio:t,verticalPixelRatio:i}){if(this._data===null||this._data.visibleRange===null)return;const r=this._data.visibleRange,n=this._data,a=Math.max(1,Math.floor(t))%2/2,l=h=>{e.beginPath();for(let c=r.to-1;c>=r.from;--c){const d=n.items[c],u=Math.round(d.x*t)+a,_=d.y*i,p=h*i+a;e.moveTo(u,_),e.arc(u,_,p,0,Math.PI*2)}e.fill()};n.lineWidth>0&&(e.fillStyle=n.backColor,l(n.radius+n.lineWidth)),e.fillStyle=n.lineColor,l(n.radius)}}function Qi(){return{items:[{x:0,y:0,time:0,price:0}],lineColor:"",backColor:"",radius:0,lineWidth:0,visibleRange:null}}const Ji={from:0,to:1};class es{constructor(e,t,i){this._compositeRenderer=new _t,this._markersRenderers=[],this._markersData=[],this._invalidated=!0,this._chartModel=e,this._crosshair=t,this._pane=i,this._compositeRenderer.setRenderers(this._markersRenderers)}update(e){this._createMarkerRenderersIfNeeded(),this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._compositeRenderer}_createMarkerRenderersIfNeeded(){const e=this._pane.orderedSources();e.length!==this._markersRenderers.length&&(this._markersData=e.map(Qi),this._markersRenderers=this._markersData.map(t=>{const i=new Zi;return i.setData(t),i}),this._compositeRenderer.setRenderers(this._markersRenderers))}_updateImpl(){const e=this._crosshair.options().mode===N.Hidden||!this._crosshair.visible(),t=this._pane.orderedSeries(),i=this._crosshair.appliedIndex(),r=this._chartModel.timeScale();this._createMarkerRenderersIfNeeded(),t.forEach((n,o)=>{const a=this._markersData[o],l=n.markerDataAtIndex(i),h=n.firstValue();if(e||l===null||!n.visible()||h===null){a.visibleRange=null;return}a.lineColor=l.backgroundColor,a.radius=l.radius,a.lineWidth=l.borderWidth,a.items[0].price=l.price,a.items[0].y=n.priceScale().priceToCoordinate(l.price,h.value),a.backColor=l.borderColor??this._chartModel.backgroundColorAtYPercentFromTop(a.items[0].y/n.priceScale().height()),a.items[0].time=i,a.items[0].x=r.indexToCoordinate(i),a.visibleRange=Ji})}}class ts extends Q{constructor(e){super(),this._data=e}_drawImpl({context:e,bitmapSize:t,horizontalPixelRatio:i,verticalPixelRatio:r}){if(this._data===null)return;const n=this._data.vertLine.visible,o=this._data.horzLine.visible;if(!n&&!o)return;const a=Math.round(this._data.x*i),l=Math.round(this._data.y*r);e.lineCap="butt",n&&a>=0&&(e.lineWidth=Math.floor(this._data.vertLine.lineWidth*i),e.strokeStyle=this._data.vertLine.color,e.fillStyle=this._data.vertLine.color,j(e,this._data.vertLine.lineStyle),Ui(e,a,0,t.height)),o&&l>=0&&(e.lineWidth=Math.floor(this._data.horzLine.lineWidth*r),e.strokeStyle=this._data.horzLine.color,e.fillStyle=this._data.horzLine.color,j(e,this._data.horzLine.lineStyle),ci(e,l,0,t.width))}}class is{constructor(e,t){this._invalidated=!0,this._rendererData={vertLine:{lineWidth:1,lineStyle:0,color:"",visible:!1},horzLine:{lineWidth:1,lineStyle:0,color:"",visible:!1},x:0,y:0},this._renderer=new ts(this._rendererData),this._source=e,this._pane=t}update(){this._invalidated=!0}renderer(e){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){const e=this._source.visible(),t=this._pane.model().options().crosshair,i=this._rendererData;if(t.mode===N.Hidden){i.horzLine.visible=!1,i.vertLine.visible=!1;return}i.horzLine.visible=e&&this._source.horzLineVisible(this._pane),i.vertLine.visible=e&&this._source.vertLineVisible(),i.horzLine.lineWidth=t.horzLine.width,i.horzLine.lineStyle=t.horzLine.style,i.horzLine.color=t.horzLine.color,i.vertLine.lineWidth=t.vertLine.width,i.vertLine.lineStyle=t.vertLine.style,i.vertLine.color=t.vertLine.color,i.x=this._source.appliedX(),i.y=this._source.appliedY()}}function So(s,e,t,i,r,n){s.fillRect(e+n,t,i-n*2,n),s.fillRect(e+n,t+r-n,i-n*2,n),s.fillRect(e,t,n,r),s.fillRect(e+i-n,t,n,r)}function Le(s,e,t,i,r,n){s.save(),s.globalCompositeOperation="copy",s.fillStyle=n,s.fillRect(e,t,i,r),s.restore()}function ss(s,e){return s.map(t=>t===0?t:t+e)}function kt(s,e,t,i,r,n){if(s.beginPath(),s.roundRect){s.roundRect(e,t,i,r,n);return}s.lineTo(e+i-n[1],t),n[1]!==0&&s.arcTo(e+i,t,e+i,t+n[1],n[1]),s.lineTo(e+i,t+r-n[2]),n[2]!==0&&s.arcTo(e+i,t+r,e+i-n[2],t+r,n[2]),s.lineTo(e+n[3],t+r),n[3]!==0&&s.arcTo(e,t+r,e,t+r-n[3],n[3]),s.lineTo(e,t+n[0]),n[0]!==0&&s.arcTo(e,t,e+n[0],t,n[0])}function Bt(s,e,t,i,r,n,o=0,a=[0,0,0,0],l=""){if(s.save(),!o||!l||l===n){kt(s,e,t,i,r,a),s.fillStyle=n,s.fill(),s.restore();return}const h=o/2,c=ss(a,-h);kt(s,e+h,t+h,i-o,r-o,c),n!=="transparent"&&(s.fillStyle=n,s.fill()),l!=="transparent"&&(s.lineWidth=o,s.strokeStyle=l,s.closePath(),s.stroke()),s.restore()}function _i(s,e,t,i,r,n,o){s.save(),s.globalCompositeOperation="copy";const a=s.createLinearGradient(0,0,0,r);a.addColorStop(0,n),a.addColorStop(1,o),s.fillStyle=a,s.fillRect(e,t,i,r),s.restore()}class Et{constructor(e,t){this.setData(e,t)}setData(e,t){this._data=e,this._commonData=t}height(e,t){return this._data.visible?e.fontSize+e.paddingTop+e.paddingBottom:0}draw(e,t,i,r){if(!this._data.visible||this._data.text.length===0)return;const n=this._data.color,o=this._commonData.background,a=e.useBitmapCoordinateSpace(l=>{const h=l.context;h.font=t.font;const c=this._calculateGeometry(l,t,i,r),d=c.bitmap;return c.alignRight?Bt(h,d.xOutside,d.yTop,d.totalWidth,d.totalHeight,o,d.horzBorder,[d.radius,0,0,d.radius],o):Bt(h,d.xInside,d.yTop,d.totalWidth,d.totalHeight,o,d.horzBorder,[0,d.radius,d.radius,0],o),this._data.tickVisible&&(h.fillStyle=n,h.fillRect(d.xInside,d.yMid,d.xTick-d.xInside,d.tickHeight)),this._data.borderVisible&&(h.fillStyle=t.paneBackgroundColor,h.fillRect(c.alignRight?d.right-d.horzBorder:0,d.yTop,d.horzBorder,d.yBottom-d.yTop)),c});e.useMediaCoordinateSpace(({context:l})=>{const h=a.media;l.font=t.font,l.textAlign=a.alignRight?"right":"left",l.textBaseline="middle",l.fillStyle=n,l.fillText(this._data.text,h.xText,(h.yTop+h.yBottom)/2+h.textMidCorrection)})}_calculateGeometry(e,t,i,r){const{context:n,bitmapSize:o,mediaSize:a,horizontalPixelRatio:l,verticalPixelRatio:h}=e,c=this._data.tickVisible||!this._data.moveTextToInvisibleTick?t.tickLength:0,d=this._data.separatorVisible?t.borderSize:0,u=t.paddingTop+this._commonData.additionalPaddingTop,_=t.paddingBottom+this._commonData.additionalPaddingBottom,p=t.paddingInner,f=t.paddingOuter,g=this._data.text,S=t.fontSize,v=i.yMidCorrection(n,g),y=Math.ceil(i.measureText(n,g)),w=S+u+_,B=t.borderSize+p+f+y+c,oe=Math.max(1,Math.floor(h));let I=Math.round(w*h);I%2!==oe%2&&(I+=1);const ae=d>0?Math.max(1,Math.floor(d*l)):0,le=Math.round(B*l),ve=Math.round(c*l),Fi=this._commonData.fixedCoordinate??this._commonData.coordinate,yt=Math.round(Fi*h)-Math.floor(h*.5),Fe=Math.floor(yt+oe/2-I/2),xt=Fe+I,be=r==="right",Tt=be?a.width-d:d,he=be?o.width-ae:ae;let He,Ne,Ue;return be?(He=he-le,Ne=he-ve,Ue=Tt-c-p-d):(He=he+le,Ne=he+ve,Ue=Tt+c+p),{alignRight:be,bitmap:{yTop:Fe,yMid:yt,yBottom:xt,totalWidth:le,totalHeight:I,radius:2*l,horzBorder:ae,xOutside:He,xInside:he,xTick:Ne,tickHeight:oe,right:o.width},media:{yTop:Fe/h,yBottom:xt/h,xText:Ue,textMidCorrection:v}}}}class ze{constructor(e){this._commonRendererData={coordinate:0,background:"#000",additionalPaddingBottom:0,additionalPaddingTop:0},this._axisRendererData={text:"",visible:!1,tickVisible:!0,moveTextToInvisibleTick:!1,borderColor:"",color:"#FFF",borderVisible:!1,separatorVisible:!1},this._paneRendererData={text:"",visible:!1,tickVisible:!1,moveTextToInvisibleTick:!0,borderColor:"",color:"#FFF",borderVisible:!0,separatorVisible:!0},this._invalidated=!0,this._axisRenderer=new(e||Et)(this._axisRendererData,this._commonRendererData),this._paneRenderer=new(e||Et)(this._paneRendererData,this._commonRendererData)}text(){return this._updateRendererDataIfNeeded(),this._axisRendererData.text}coordinate(){return this._updateRendererDataIfNeeded(),this._commonRendererData.coordinate}update(){this._invalidated=!0}height(e,t=!1){return Math.max(this._axisRenderer.height(e,t),this._paneRenderer.height(e,t))}getFixedCoordinate(){return this._commonRendererData.fixedCoordinate||0}setFixedCoordinate(e){this._commonRendererData.fixedCoordinate=e}isVisible(){return this._updateRendererDataIfNeeded(),this._axisRendererData.visible||this._paneRendererData.visible}isAxisLabelVisible(){return this._updateRendererDataIfNeeded(),this._axisRendererData.visible}renderer(e){return this._updateRendererDataIfNeeded(),this._axisRendererData.tickVisible=this._axisRendererData.tickVisible&&e.options().ticksVisible,this._paneRendererData.tickVisible=this._paneRendererData.tickVisible&&e.options().ticksVisible,this._axisRenderer.setData(this._axisRendererData,this._commonRendererData),this._paneRenderer.setData(this._paneRendererData,this._commonRendererData),this._axisRenderer}paneRenderer(){return this._updateRendererDataIfNeeded(),this._axisRenderer.setData(this._axisRendererData,this._commonRendererData),this._paneRenderer.setData(this._paneRendererData,this._commonRendererData),this._paneRenderer}_updateRendererDataIfNeeded(){this._invalidated&&(this._axisRendererData.tickVisible=!0,this._paneRendererData.tickVisible=!1,this._updateRendererData(this._axisRendererData,this._paneRendererData,this._commonRendererData))}}class rs extends ze{constructor(e,t,i){super(),this._source=e,this._priceScale=t,this._valueProvider=i}_updateRendererData(e,t,i){if(e.visible=!1,this._source.options().mode===N.Hidden)return;const r=this._source.options().horzLine;if(!r.labelVisible)return;const n=this._priceScale.firstValue();if(!this._source.visible()||this._priceScale.isEmpty()||n===null)return;const o=this._priceScale.colorParser().generateContrastColors(r.labelBackgroundColor);i.background=o.background,e.color=o.foreground;const a=2/12*this._priceScale.fontSize();i.additionalPaddingTop=a,i.additionalPaddingBottom=a;const l=this._valueProvider(this._priceScale);i.coordinate=l.coordinate,e.text=this._priceScale.formatPrice(l.price,n),e.visible=!0}}const ns=/[1-9]/g,os=2;class pi{constructor(){this._data=null}setData(e){this._data=e}draw(e,t){if(this._data===null||this._data.visible===!1||this._data.text.length===0)return;const i=e.useMediaCoordinateSpace(({context:_})=>(_.font=t.font,Math.round(t.widthCache.measureText(_,m(this._data).text,ns))));if(i<=0)return;const r=t.paddingHorizontal,n=i+2*r,o=n/2,a=this._data.width;let l=this._data.coordinate,h=Math.floor(l-o)+.5;h<0?(l=l+Math.abs(0-h),h=Math.floor(l-o)+.5):h+n>a&&(l=l-Math.abs(a-(h+n)),h=Math.floor(l-o)+.5);const c=h+n,d=0,u=Math.ceil(d+t.borderSize+t.tickLength+t.paddingTop+t.fontSize+t.paddingBottom);e.useBitmapCoordinateSpace(({context:_,horizontalPixelRatio:p,verticalPixelRatio:f})=>{const g=m(this._data);_.fillStyle=g.background;const S=Math.round(h*p),v=Math.round(d*f),y=Math.round(c*p),w=Math.round(u*f),B=Math.round(os*p);if(_.beginPath(),_.moveTo(S,v),_.lineTo(S,w-B),_.arcTo(S,w,S+B,w,B),_.lineTo(y-B,w),_.arcTo(y,w,y,w-B,B),_.lineTo(y,v),_.fill(),g.tickVisible){const oe=Math.round(g.coordinate*p),I=v,ae=Math.round((I+t.tickLength)*f);_.fillStyle=g.color;const le=Math.max(1,Math.floor(p)),ve=Math.floor(p*.5);_.fillRect(oe-ve,I,le,ae-I)}}),e.useMediaCoordinateSpace(({context:_})=>{const p=m(this._data),f=d+t.borderSize+t.tickLength+t.paddingTop+t.fontSize/2;_.font=t.font,_.textAlign="left",_.textBaseline="middle",_.fillStyle=p.color;const g=t.widthCache.yMidCorrection(_,"Apr0");_.translate(h+r,f+g),_.fillText(p.text,0,0)})}}class as{constructor(e,t,i){this._invalidated=!0,this._renderer=new pi,this._rendererData={visible:!1,background:"#4c525e",color:"white",text:"",width:0,coordinate:NaN,tickVisible:!0},this._crosshair=e,this._model=t,this._valueProvider=i}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer.setData(this._rendererData),this._renderer}_updateImpl(){const e=this._rendererData;if(e.visible=!1,this._crosshair.options().mode===N.Hidden)return;const t=this._crosshair.options().vertLine;if(!t.labelVisible)return;const i=this._model.timeScale();if(i.isEmpty())return;e.width=i.width();const r=this._valueProvider();if(r===null)return;e.coordinate=r.coordinate;const n=i.indexToTimeScalePoint(this._crosshair.appliedIndex());e.text=i.formatDateTime(m(n)),e.visible=!0;const o=this._model.colorParser().generateContrastColors(t.labelBackgroundColor);e.background=o.background,e.color=o.foreground,e.tickVisible=i.options().ticksVisible}}class mi{constructor(){this._priceScale=null,this._zorder=0}zorder(){return this._zorder}setZorder(e){this._zorder=e}priceScale(){return this._priceScale}setPriceScale(e){this._priceScale=e}labelPaneViews(e){return[]}timeAxisViews(){return[]}visible(){return!0}}var N=(s=>(s[s.Normal=0]="Normal",s[s.Magnet=1]="Magnet",s[s.Hidden=2]="Hidden",s[s.MagnetOHLC=3]="MagnetOHLC",s))(N||{});class ls extends mi{constructor(e,t){super(),this._pane=null,this._price=NaN,this._index=0,this._visible=!1,this._priceAxisViews=new Map,this._subscribed=!1,this._crosshairPaneViewCache=new WeakMap,this._markersPaneViewCache=new WeakMap,this._x=NaN,this._y=NaN,this._originX=NaN,this._originY=NaN,this._model=e,this._options=t;const i=(o,a)=>l=>{const h=a(),c=o();if(l===m(this._pane).defaultPriceScale())return{price:c,coordinate:h};{const d=m(l.firstValue());return{price:l.coordinateToPrice(h,d),coordinate:h}}},r=(o,a)=>()=>{const l=this._model.timeScale().indexToTime(o()),h=a();return!l||!Number.isFinite(h)?null:{time:l,coordinate:h}};this._currentPosPriceProvider=i(()=>this._price,()=>this._y);const n=r(()=>this._index,()=>this.appliedX());this._timeAxisView=new as(this,e,n)}options(){return this._options}saveOriginCoord(e,t){this._originX=e,this._originY=t}clearOriginCoord(){this._originX=NaN,this._originY=NaN}originCoordX(){return this._originX}originCoordY(){return this._originY}setPosition(e,t,i){this._subscribed||(this._subscribed=!0),this._visible=!0,this._tryToUpdateViews(e,t,i)}appliedIndex(){return this._index}appliedX(){return this._x}appliedY(){return this._y}visible(){return this._visible}clearPosition(){this._visible=!1,this._setIndexToLastSeriesBarIndex(),this._price=NaN,this._x=NaN,this._y=NaN,this._pane=null,this.clearOriginCoord(),this.updateAllViews()}paneViews(e){let t=this._crosshairPaneViewCache.get(e);t||(t=new is(this,e),this._crosshairPaneViewCache.set(e,t));let i=this._markersPaneViewCache.get(e);return i||(i=new es(this._model,this,e),this._markersPaneViewCache.set(e,i)),[t,i]}horzLineVisible(e){return e===this._pane&&this._options.horzLine.visible}vertLineVisible(){return this._options.vertLine.visible}priceAxisViews(e,t){(!this._visible||this._pane!==e)&&this._priceAxisViews.clear();const i=[];return this._pane===e&&i.push(this._createPriceAxisViewOnDemand(this._priceAxisViews,t,this._currentPosPriceProvider)),i}timeAxisViews(){return this._visible?[this._timeAxisView]:[]}pane(){return this._pane}updateAllViews(){this._model.panes().forEach(e=>{var t,i;(t=this._crosshairPaneViewCache.get(e))==null||t.update(),(i=this._markersPaneViewCache.get(e))==null||i.update()}),this._priceAxisViews.forEach(e=>e.update()),this._timeAxisView.update()}_priceScaleByPane(e){return e&&!e.defaultPriceScale().isEmpty()?e.defaultPriceScale():null}_tryToUpdateViews(e,t,i){this._tryToUpdateData(e,t,i)&&this.updateAllViews()}_tryToUpdateData(e,t,i){const r=this._x,n=this._y,o=this._price,a=this._index,l=this._pane,h=this._priceScaleByPane(i);this._index=e,this._x=isNaN(e)?NaN:this._model.timeScale().indexToCoordinate(e),this._pane=i;const c=h!==null?h.firstValue():null;return h!==null&&c!==null?(this._price=t,this._y=h.priceToCoordinate(t,c)):(this._price=NaN,this._y=NaN),r!==this._x||n!==this._y||a!==this._index||o!==this._price||l!==this._pane}_setIndexToLastSeriesBarIndex(){const e=this._model.serieses().map(i=>i.bars().lastIndex()).filter(Gi),t=e.length===0?null:Math.max(...e);this._index=t!==null?t:NaN}_createPriceAxisViewOnDemand(e,t,i){let r=e.get(t);return r===void 0&&(r=new rs(this,t,i),e.set(t,r)),r}}var L=(s=>(s.Left="left",s.Right="right",s))(L||{});function De(s){return s==="left"||s==="right"}var x=(s=>(s[s.None=0]="None",s[s.Cursor=1]="Cursor",s[s.Light=2]="Light",s[s.Full=3]="Full",s))(x||{});function hs(s,e){if(s===void 0)return e;const t=Math.max(s.level,e.level),i=s.autoScale||e.autoScale;return{level:t,autoScale:i}}var Y=(s=>(s[s.FitContent=0]="FitContent",s[s.ApplyRange=1]="ApplyRange",s[s.ApplyBarSpacing=2]="ApplyBarSpacing",s[s.ApplyRightOffset=3]="ApplyRightOffset",s[s.Reset=4]="Reset",s[s.Animation=5]="Animation",s[s.StopAnimation=6]="StopAnimation",s))(Y||{});class M{constructor(e){this._invalidatedPanes=new Map,this._timeScaleInvalidations=[],this._globalLevel=e}invalidatePane(e,t){const i=this._invalidatedPanes.get(e),r=hs(i,t);this._invalidatedPanes.set(e,r)}fullInvalidation(){return this._globalLevel}invalidateForPane(e){const t=this._invalidatedPanes.get(e);return t===void 0?{level:this._globalLevel}:{level:Math.max(this._globalLevel,t.level),autoScale:t.autoScale}}setFitContent(){this.stopTimeScaleAnimation(),this._timeScaleInvalidations=[{type:0}]}applyRange(e){this.stopTimeScaleAnimation(),this._timeScaleInvalidations=[{type:1,value:e}]}setTimeScaleAnimation(e){this._removeTimeScaleAnimation(),this._timeScaleInvalidations.push({type:5,value:e})}stopTimeScaleAnimation(){this._removeTimeScaleAnimation(),this._timeScaleInvalidations.push({type:6})}resetTimeScale(){this.stopTimeScaleAnimation(),this._timeScaleInvalidations=[{type:4}]}setBarSpacing(e){this.stopTimeScaleAnimation(),this._timeScaleInvalidations.push({type:2,value:e})}setRightOffset(e){this.stopTimeScaleAnimation(),this._timeScaleInvalidations.push({type:3,value:e})}timeScaleInvalidations(){return this._timeScaleInvalidations}merge(e){for(const t of e._timeScaleInvalidations)this._applyTimeScaleInvalidation(t);this._globalLevel=Math.max(this._globalLevel,e._globalLevel),e._invalidatedPanes.forEach((t,i)=>{this.invalidatePane(i,t)})}static light(){return new M(2)}static full(){return new M(3)}_applyTimeScaleInvalidation(e){switch(e.type){case 0:this.setFitContent();break;case 1:this.applyRange(e.value);break;case 2:this.setBarSpacing(e.value);break;case 3:this.setRightOffset(e.value);break;case 4:this.resetTimeScale();break;case 5:this.setTimeScaleAnimation(e.value);break;case 6:this._removeTimeScaleAnimation()}}_removeTimeScaleAnimation(){const e=this._timeScaleInvalidations.findIndex(t=>t.type===5);e!==-1&&this._timeScaleInvalidations.splice(e,1)}}var pt=(s=>(s.Solid="solid",s.VerticalGradient="gradient",s))(pt||{}),C=(s=>(s[s.Open=0]="Open",s[s.High=1]="High",s[s.Low=2]="Low",s[s.Close=3]="Close",s))(C||{});class fi{formatTickmarks(e){return e.map(t=>this.format(t))}}const Rt={decimalSign:"."};function H(s,e){if(!se(s))return"n/a";if(!me(e))throw new TypeError("invalid length");if(e<0||e>16)throw new TypeError("invalid length");return e===0?s.toString():("0000000000000000"+s.toString()).slice(-e)}class Ie extends fi{constructor(e,t){if(super(),t||(t=1),(!se(e)||!me(e))&&(e=100),e<0)throw new TypeError("invalid base");this._priceScale=e,this._minMove=t,this._calculateDecimal()}format(e){const t=e<0?"âˆ’":"";return e=Math.abs(e),t+this._formatAsDecimal(e)}_calculateDecimal(){if(this._fractionalLength=0,this._priceScale>0&&this._minMove>0){let e=this._priceScale;for(;e>1;)e/=10,this._fractionalLength++}}_formatAsDecimal(e){const t=this._priceScale/this._minMove;let i=Math.floor(e),r="";const n=this._fractionalLength!==void 0?this._fractionalLength:NaN;if(t>1){let o=+(Math.round(e*t)-i*t).toFixed(this._fractionalLength);o>=t&&(o-=t,i+=1),r=Rt.decimalSign+H(+o.toFixed(this._fractionalLength)*this._minMove,n)}else i=Math.round(i*t)/t,n>0&&(r=Rt.decimalSign+H(0,n));return i.toFixed(0)+r}}class gi extends Ie{constructor(e=100){super(e)}format(e){return`${super.format(e)}%`}}class cs extends fi{constructor(e){super(),this._precision=e}format(e){let t="";return e<0&&(t="-",e=-e),e<995?t+this._formatNumber(e):e<999995?t+this._formatNumber(e/1e3)+"K":e<999999995?(e=1e3*Math.round(e/1e3),t+this._formatNumber(e/1e6)+"M"):(e=1e6*Math.round(e/1e6),t+this._formatNumber(e/1e9)+"B")}_formatNumber(e){let t;const i=Math.pow(10,this._precision);return e=Math.round(e*i)/i,e>=1e-15&&e<1?t=e.toFixed(this._precision).replace(/\.?0+$/,""):t=String(e),t.replace(/(\.[1-9]*)0+$/,(r,n)=>n)}}const ds=/[2-9]/g;class Ee{constructor(e=50){this._actualSize=0,this._usageTick=1,this._oldestTick=1,this._tick2Labels={},this._cache=new Map,this._maxSize=e}reset(){this._actualSize=0,this._cache.clear(),this._usageTick=1,this._oldestTick=1,this._tick2Labels={}}measureText(e,t,i){return this._getMetrics(e,t,i).width}yMidCorrection(e,t,i){const r=this._getMetrics(e,t,i);return((r.actualBoundingBoxAscent||0)-(r.actualBoundingBoxDescent||0))/2}_getMetrics(e,t,i){const r=i||ds,n=String(t).replace(r,"0");if(this._cache.has(n))return V(this._cache.get(n)).metrics;if(this._actualSize===this._maxSize){const a=this._tick2Labels[this._oldestTick];delete this._tick2Labels[this._oldestTick],this._cache.delete(a),this._oldestTick++,this._actualSize--}e.save(),e.textBaseline="middle";const o=e.measureText(n);return e.restore(),o.width===0&&t.length||(this._cache.set(n,{metrics:o,tick:this._usageTick}),this._tick2Labels[this._usageTick]=n,this._actualSize++,this._usageTick++),o}}class us{constructor(e){this._priceAxisViewRenderer=null,this._rendererOptions=null,this._align="right",this._textWidthCache=e}setParams(e,t,i){this._priceAxisViewRenderer=e,this._rendererOptions=t,this._align=i}draw(e){this._rendererOptions===null||this._priceAxisViewRenderer===null||this._priceAxisViewRenderer.draw(e,this._rendererOptions,this._textWidthCache,this._align)}}class Si{constructor(e,t,i){this._priceAxisView=e,this._textWidthCache=new Ee(50),this._dataSource=t,this._chartModel=i,this._fontSize=-1,this._renderer=new us(this._textWidthCache)}renderer(){const e=this._chartModel.paneForSource(this._dataSource);if(e===null)return null;const t=e.isOverlay(this._dataSource)?e.defaultVisiblePriceScale():this._dataSource.priceScale();if(t===null)return null;const i=e.priceScalePosition(t);if(i==="overlay")return null;const r=this._chartModel.priceAxisRendererOptions();return r.fontSize!==this._fontSize&&(this._fontSize=r.fontSize,this._textWidthCache.reset()),this._renderer.setParams(this._priceAxisView.paneRenderer(),r,i),this._renderer}}function Vt(s,e,t,i){const r=Number.isFinite(e),n=Number.isFinite(t);return r&&n?s(e,t):!r&&!n?i:r?e:t}class E{constructor(e,t){this._minValue=e,this._maxValue=t}equals(e){return e===null?!1:this._minValue===e._minValue&&this._maxValue===e._maxValue}clone(){return new E(this._minValue,this._maxValue)}minValue(){return this._minValue}maxValue(){return this._maxValue}length(){return this._maxValue-this._minValue}isEmpty(){return this._maxValue===this._minValue||Number.isNaN(this._maxValue)||Number.isNaN(this._minValue)}merge(e){return e===null?this:new E(Vt(Math.min,this.minValue(),e.minValue(),-1/0),Vt(Math.max,this.maxValue(),e.maxValue(),1/0))}scaleAroundCenter(e){if(!se(e)||this._maxValue-this._minValue===0)return;const i=(this._maxValue+this._minValue)*.5;let r=this._maxValue-i,n=this._minValue-i;r*=e,n*=e,this._maxValue=i+r,this._minValue=i+n}shift(e){se(e)&&(this._maxValue+=e,this._minValue+=e)}toRaw(){return{minValue:this._minValue,maxValue:this._maxValue}}static fromRaw(e){return e===null?null:new E(e.minValue,e.maxValue)}}const Xe={logicalOffset:4,coordOffset:1e-4};function _s(s,e){return e<0&&(s=-s),s/100*e+e}function ee(s,e){const t=100*(s-e)/e;return e<0?-t:t}function ps(s,e){const t=ee(s.minValue(),e),i=ee(s.maxValue(),e);return new E(t,i)}function ms(s,e){return s-=100,e<0&&(s=-s),s/100*e+e}function _e(s,e){const t=100*(s-e)/e+100;return e<0?-t:t}function fs(s,e){const t=_e(s.minValue(),e),i=_e(s.maxValue(),e);return new E(t,i)}function Re(s,e){const t=Math.abs(s);if(t<1e-15)return 0;const i=Math.log10(t+e.coordOffset)+e.logicalOffset;return s<0?-i:i}function fe(s,e){const t=Math.abs(s);if(t<1e-15)return 0;const i=Math.pow(10,t-e.logicalOffset)-e.coordOffset;return s<0?-i:i}function ce(s,e){if(s===null)return null;const t=Re(s.minValue(),e),i=Re(s.maxValue(),e);return new E(t,i)}function gs(s,e){if(s===null)return!1;const t=fe(s.minValue(),e),i=fe(s.maxValue(),e);return isFinite(t)&&isFinite(i)}function ue(s,e){if(s===null)return null;const t=fe(s.minValue(),e),i=fe(s.maxValue(),e);return new E(t,i)}function Ge(s){if(s===null)return Xe;const e=Math.abs(s.maxValue()-s.minValue());if(e>=1||e<1e-15)return Xe;const t=Math.ceil(Math.abs(Math.log10(e))),i=Xe.logicalOffset+t,r=1/Math.pow(10,i);return{logicalOffset:i,coordOffset:r}}function Ss(s,e){return s.logicalOffset===e.logicalOffset&&s.coordOffset===e.coordOffset}function te(s,e,t){return Math.min(Math.max(s,e),t)}function vs(s){if(s<0)return!1;if(s>1e18)return!0;for(let e=s;e>1;e/=10)if(e%10!==0)return!1;return!0}function Pe(s,e,t){return e-s<=t}function bs(s,e,t){return Math.abs(s-e)<t}function Cs(s){if(s.length<1)throw Error("array is empty");let e=s[0];for(let t=1;t<s.length;++t)s[t]<e&&(e=s[t]);return e}class $e{constructor(e,t){if(this._base=e,this._integralDividers=t,vs(this._base))this._fractionalDividers=[2,2.5,2];else{this._fractionalDividers=[];for(let i=this._base;i!==1;){if(i%2===0)this._fractionalDividers.push(2),i/=2;else if(i%5===0)this._fractionalDividers.push(2,2.5),i/=5;else throw new Error("unexpected base");if(this._fractionalDividers.length>100)throw new Error("something wrong with base")}}}tickSpan(e,t,i){const r=this._base===0?0:1/this._base;let n=Math.pow(10,Math.max(0,Math.ceil(Math.log10(e-t)))),o=0,a=this._integralDividers[0];for(;;){const l=Pe(n,r,1e-14)&&n>r+1e-14,h=Pe(n,i*a,1e-14),c=Pe(n,1,1e-14);if(!(l&&h&&c))break;n/=a,a=this._integralDividers[++o%this._integralDividers.length]}if(n<=r+1e-14&&(n=r),n=Math.max(1,n),this._fractionalDividers.length>0&&bs(n,1,1e-14))for(o=0,a=this._fractionalDividers[0];Pe(n,i*a,1e-14)&&n>r+1e-14;)n/=a,a=this._fractionalDividers[++o%this._fractionalDividers.length];return n}}const Ps=2.5;class At{constructor(e,t,i,r){this._marks=[],this._priceScale=e,this._base=t,this._coordinateToLogicalFunc=i,this._logicalToCoordinateFunc=r}tickSpan(e,t){if(e<t)throw new Error("high < low");const i=this._priceScale.height(),r=this._tickMarkHeight(),n=(e-t)*r/i,o=new $e(this._base,[2,2.5,2]),a=new $e(this._base,[2,2,2.5]),l=new $e(this._base,[2.5,2,2]),h=[];return h.push(o.tickSpan(e,t,n),a.tickSpan(e,t,n),l.tickSpan(e,t,n)),Cs(h)}rebuildTickMarks(){const e=this._priceScale,t=e.firstValue();if(t===null){this._marks=[];return}const i=e.height(),r=this._coordinateToLogicalFunc(i-1,t),n=this._coordinateToLogicalFunc(0,t),o=this._priceScale.options().entireTextOnly?this._fontHeight()/2:0,a=o,l=i-1-o,h=Math.max(r,n),c=Math.min(r,n);if(h===c){this._marks=[];return}const d=this.tickSpan(h,c);if(this._updateMarks(t,d,h,c,a,l),e.hasVisibleEdgeMarks()&&this._shouldApplyEdgeMarks(d,c,h)){const p=this._priceScale.getEdgeMarksPadding();this._applyEdgeMarks(t,d,a,l,p,p*2)}const u=this._marks.map(p=>p.logical),_=this._priceScale.formatLogicalTickmarks(u);for(let p=0;p<this._marks.length;p++)this._marks[p].label=_[p]}marks(){return this._marks}_fontHeight(){return this._priceScale.fontSize()}_tickMarkHeight(){return Math.ceil(this._fontHeight()*Ps)}_updateMarks(e,t,i,r,n,o){const a=this._marks,l=this._priceScale;let h=i%t;h+=h<0?t:0;const c=i>=r?1:-1;let d=null,u=0;for(let _=i-h;_>r;_-=t){const p=this._logicalToCoordinateFunc(_,e,!0);d!==null&&Math.abs(p-d)<this._tickMarkHeight()||p<n||p>o||(u<a.length?(a[u].coord=p,a[u].label=l.formatLogical(_),a[u].logical=_):a.push({coord:p,label:l.formatLogical(_),logical:_}),u++,d=p,l.isLog()&&(t=this.tickSpan(_*c,r)))}a.length=u}_applyEdgeMarks(e,t,i,r,n,o){const a=this._marks,l=this._computeBoundaryPriceMark(e,i,n,o),h=this._computeBoundaryPriceMark(e,r,-o,-n),c=this._logicalToCoordinateFunc(0,e,!0)-this._logicalToCoordinateFunc(t,e,!0);a.length>0&&a[0].coord-l.coord<c/2&&a.shift(),a.length>0&&h.coord-a[a.length-1].coord<c/2&&a.pop(),a.unshift(l),a.push(h)}_computeBoundaryPriceMark(e,t,i,r){const n=(i+r)/2,o=this._coordinateToLogicalFunc(t+i,e),a=this._coordinateToLogicalFunc(t+r,e),l=Math.min(o,a),h=Math.max(o,a),c=Math.max(.1,this.tickSpan(h,l)),d=this._coordinateToLogicalFunc(t+n,e),u=d-d%c,_=this._logicalToCoordinateFunc(u,e,!0);return{label:this._priceScale.formatLogical(u),coord:_,logical:u}}_shouldApplyEdgeMarks(e,t,i){let r=X(this._priceScale.priceRange());return this._priceScale.isLog()&&(r=ue(r,this._priceScale.getLogFormula())),r.minValue()-t<e&&i-r.maxValue()<e}}function vi(s){return s.slice().sort((e,t)=>m(e.zorder())-m(t.zorder()))}var Ve=(s=>(s[s.Normal=0]="Normal",s[s.Logarithmic=1]="Logarithmic",s[s.Percentage=2]="Percentage",s[s.IndexedTo100=3]="IndexedTo100",s))(Ve||{});const Lt=new gi,zt=new Ie(100,1);class ws{constructor(e,t,i,r,n){this._height=0,this._internalHeightCache=null,this._priceRange=null,this._priceRangeSnapshot=null,this._invalidatedForRange={isValid:!1,visibleBars:null},this._isCustomPriceRange=!1,this._marginAbove=0,this._marginBelow=0,this._onMarksChanged=new T,this._modeChanged=new T,this._dataSources=[],this._formatterSource=null,this._cachedOrderedSources=null,this._marksCache=null,this._scaleStartPoint=null,this._scrollStartPoint=null,this._formatter=zt,this._logFormula=Ge(null),this._id=e,this._options=t,this._layoutOptions=i,this._localizationOptions=r,this._colorParser=n,this._markBuilder=new At(this,100,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this))}id(){return this._id}options(){return this._options}applyOptions(e){if(A(this._options,e),this.updateFormatter(),e.mode!==void 0&&this.setMode({mode:e.mode}),e.scaleMargins!==void 0){const t=V(e.scaleMargins.top),i=V(e.scaleMargins.bottom);if(t<0||t>1)throw new Error(`Invalid top margin - expect value between 0 and 1, given=${t}`);if(i<0||i>1)throw new Error(`Invalid bottom margin - expect value between 0 and 1, given=${i}`);if(t+i>1)throw new Error(`Invalid margins - sum of margins must be less than 1, given=${t+i}`);this._invalidateInternalHeightCache(),this._marksCache=null}}isAutoScale(){return this._options.autoScale}isCustomPriceRange(){return this._isCustomPriceRange}isLog(){return this._options.mode===1}isPercentage(){return this._options.mode===2}isIndexedTo100(){return this._options.mode===3}getLogFormula(){return this._logFormula}mode(){return{autoScale:this._options.autoScale,isInverted:this._options.invertScale,mode:this._options.mode}}setMode(e){const t=this.mode();let i=null;e.autoScale!==void 0&&(this._options.autoScale=e.autoScale),e.mode!==void 0&&(this._options.mode=e.mode,(e.mode===2||e.mode===3)&&(this._options.autoScale=!0),this._invalidatedForRange.isValid=!1),t.mode===1&&e.mode!==t.mode&&(gs(this._priceRange,this._logFormula)?(i=ue(this._priceRange,this._logFormula),i!==null&&this.setPriceRange(i)):this._options.autoScale=!0),e.mode===1&&e.mode!==t.mode&&(i=ce(this._priceRange,this._logFormula),i!==null&&this.setPriceRange(i));const r=t.mode!==this._options.mode;r&&(t.mode===2||this.isPercentage())&&this.updateFormatter(),r&&(t.mode===3||this.isIndexedTo100())&&this.updateFormatter(),e.isInverted!==void 0&&t.isInverted!==e.isInverted&&(this._options.invertScale=e.isInverted,this._onIsInvertedChanged()),this._modeChanged.fire(t,this.mode())}modeChanged(){return this._modeChanged}fontSize(){return this._layoutOptions.fontSize}height(){return this._height}setHeight(e){this._height!==e&&(this._height=e,this._invalidateInternalHeightCache(),this._marksCache=null)}internalHeight(){if(this._internalHeightCache)return this._internalHeightCache;const e=this.height()-this._topMarginPx()-this._bottomMarginPx();return this._internalHeightCache=e,e}priceRange(){return this._makeSureItIsValid(),this._priceRange}setPriceRange(e,t){const i=this._priceRange;!t&&!(i===null&&e!==null)&&(i===null||i.equals(e))||(this._marksCache=null,this._priceRange=e)}setCustomPriceRange(e){this.setPriceRange(e),this._toggleCustomPriceRange(e!==null)}isEmpty(){return this._makeSureItIsValid(),this._height===0||!this._priceRange||this._priceRange.isEmpty()}invertedCoordinate(e){return this.isInverted()?e:this.height()-1-e}priceToCoordinate(e,t){return this.isPercentage()?e=ee(e,t):this.isIndexedTo100()&&(e=_e(e,t)),this._logicalToCoordinate(e,t)}pointsArrayToCoordinates(e,t,i){this._makeSureItIsValid();const r=this._bottomMarginPx(),n=m(this.priceRange()),o=n.minValue(),a=n.maxValue(),l=this.internalHeight()-1,h=this.isInverted(),c=l/(a-o),d=i===void 0?0:i.from,u=i===void 0?e.length:i.to,_=this._getCoordinateTransformer();for(let p=d;p<u;p++){const f=e[p],g=f.price;if(isNaN(g))continue;let S=g;_!==null&&(S=_(f.price,t));const v=r+c*(S-o),y=h?v:this._height-1-v;f.y=y}}barPricesToCoordinates(e,t,i){this._makeSureItIsValid();const r=this._bottomMarginPx(),n=m(this.priceRange()),o=n.minValue(),a=n.maxValue(),l=this.internalHeight()-1,h=this.isInverted(),c=l/(a-o),d=i===void 0?0:i.from,u=i===void 0?e.length:i.to,_=this._getCoordinateTransformer();for(let p=d;p<u;p++){const f=e[p];let g=f.open,S=f.high,v=f.low,y=f.close;_!==null&&(g=_(f.open,t),S=_(f.high,t),v=_(f.low,t),y=_(f.close,t));let w=r+c*(g-o),B=h?w:this._height-1-w;f.openY=B,w=r+c*(S-o),B=h?w:this._height-1-w,f.highY=B,w=r+c*(v-o),B=h?w:this._height-1-w,f.lowY=B,w=r+c*(y-o),B=h?w:this._height-1-w,f.closeY=B}}coordinateToPrice(e,t){const i=this._coordinateToLogical(e,t);return this.logicalToPrice(i,t)}logicalToPrice(e,t){let i=e;return this.isPercentage()?i=_s(i,t):this.isIndexedTo100()&&(i=ms(i,t)),i}dataSources(){return this._dataSources}orderedSources(){return this._cachedOrderedSources||(this._cachedOrderedSources=vi(this._dataSources)),this._cachedOrderedSources}addDataSource(e){this._dataSources.indexOf(e)===-1&&(this._dataSources.push(e),this.updateFormatter(),this.invalidateSourcesCache())}removeDataSource(e){const t=this._dataSources.indexOf(e);if(t===-1)throw new Error("source is not attached to scale");this._dataSources.splice(t,1),this._dataSources.length===0&&(this.setMode({autoScale:!0}),this.setPriceRange(null)),this.updateFormatter(),this.invalidateSourcesCache()}firstValue(){let e=null;for(const t of this._dataSources){const i=t.firstValue();i!==null&&(e===null||i.timePoint<e.timePoint)&&(e=i)}return e===null?null:e.value}isInverted(){return this._options.invertScale}marks(){const e=this.firstValue()===null;if(this._marksCache!==null&&(e||this._marksCache.firstValueIsNull===e))return this._marksCache.marks;this._markBuilder.rebuildTickMarks();const t=this._markBuilder.marks();return this._marksCache={marks:t,firstValueIsNull:e},this._onMarksChanged.fire(),t}onMarksChanged(){return this._onMarksChanged}startScale(e){this.isPercentage()||this.isIndexedTo100()||this._scaleStartPoint!==null||this._priceRangeSnapshot!==null||this.isEmpty()||(this._scaleStartPoint=this._height-e,this._priceRangeSnapshot=m(this.priceRange()).clone())}scaleTo(e){if(this.isPercentage()||this.isIndexedTo100()||this._scaleStartPoint===null)return;this.setMode({autoScale:!1}),e=this._height-e,e<0&&(e=0);let t=(this._scaleStartPoint+(this._height-1)*.2)/(e+(this._height-1)*.2);const i=m(this._priceRangeSnapshot).clone();t=Math.max(t,.1),i.scaleAroundCenter(t),this.setPriceRange(i)}endScale(){this.isPercentage()||this.isIndexedTo100()||(this._scaleStartPoint=null,this._priceRangeSnapshot=null)}startScroll(e){this.isAutoScale()||this._scrollStartPoint!==null||this._priceRangeSnapshot!==null||this.isEmpty()||(this._scrollStartPoint=e,this._priceRangeSnapshot=m(this.priceRange()).clone())}scrollTo(e){if(this.isAutoScale()||this._scrollStartPoint===null)return;const t=m(this.priceRange()).length()/(this.internalHeight()-1);let i=e-this._scrollStartPoint;this.isInverted()&&(i*=-1);const r=i*t,n=m(this._priceRangeSnapshot).clone();n.shift(r),this.setPriceRange(n,!0),this._marksCache=null}endScroll(){this.isAutoScale()||this._scrollStartPoint!==null&&(this._scrollStartPoint=null,this._priceRangeSnapshot=null)}formatter(){return this._formatter||this.updateFormatter(),this._formatter}formatPrice(e,t){switch(this._options.mode){case 2:return this._formatPercentage(ee(e,t));case 3:return this.formatter().format(_e(e,t));default:return this._formatPrice(e)}}formatLogical(e){switch(this._options.mode){case 2:return this._formatPercentage(e);case 3:return this.formatter().format(e);default:return this._formatPrice(e)}}formatLogicalTickmarks(e){switch(this._options.mode){case 2:return this._formatPercentageTickmarks(e);case 3:return this.formatter().formatTickmarks(e);default:return this._formatTickmarks(e)}}formatPriceAbsolute(e){return this._formatPrice(e,m(this._formatterSource).formatter())}formatPricePercentage(e,t){return e=ee(e,t),this._formatPercentage(e,Lt)}sourcesForAutoScale(){return this._dataSources}recalculatePriceRange(e){this._invalidatedForRange={visibleBars:e,isValid:!1}}updateAllViews(){this._dataSources.forEach(e=>e.updateAllViews())}hasVisibleEdgeMarks(){return this._options.ensureEdgeTickMarksVisible&&this.isAutoScale()}getEdgeMarksPadding(){return this.fontSize()/2}updateFormatter(){this._marksCache=null;let e=1/0;this._formatterSource=null;for(const i of this._dataSources)i.zorder()<e&&(e=i.zorder(),this._formatterSource=i);let t=100;this._formatterSource!==null&&(t=Math.round(this._formatterSource.base())),this._formatter=zt,this.isPercentage()?(this._formatter=Lt,t=100):this.isIndexedTo100()?(this._formatter=new Ie(100,1),t=100):this._formatterSource!==null&&(this._formatter=this._formatterSource.formatter()),this._markBuilder=new At(this,t,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._markBuilder.rebuildTickMarks()}invalidateSourcesCache(){this._cachedOrderedSources=null}colorParser(){return this._colorParser}_toggleCustomPriceRange(e){this._isCustomPriceRange=e}_topMarginPx(){return this.isInverted()?this._options.scaleMargins.bottom*this.height()+this._marginBelow:this._options.scaleMargins.top*this.height()+this._marginAbove}_bottomMarginPx(){return this.isInverted()?this._options.scaleMargins.top*this.height()+this._marginAbove:this._options.scaleMargins.bottom*this.height()+this._marginBelow}_makeSureItIsValid(){this._invalidatedForRange.isValid||(this._invalidatedForRange.isValid=!0,this._recalculatePriceRangeImpl())}_invalidateInternalHeightCache(){this._internalHeightCache=null}_logicalToCoordinate(e,t){if(this._makeSureItIsValid(),this.isEmpty())return 0;e=this.isLog()&&e?Re(e,this._logFormula):e;const i=m(this.priceRange()),r=this._bottomMarginPx()+(this.internalHeight()-1)*(e-i.minValue())/i.length();return this.invertedCoordinate(r)}_coordinateToLogical(e,t){if(this._makeSureItIsValid(),this.isEmpty())return 0;const i=this.invertedCoordinate(e),r=m(this.priceRange()),n=r.minValue()+r.length()*((i-this._bottomMarginPx())/(this.internalHeight()-1));return this.isLog()?fe(n,this._logFormula):n}_onIsInvertedChanged(){this._marksCache=null,this._markBuilder.rebuildTickMarks()}_recalculatePriceRangeImpl(){if(this.isCustomPriceRange()&&!this.isAutoScale())return;const e=this._invalidatedForRange.visibleBars;if(e===null)return;let t=null;const i=this.sourcesForAutoScale();let r=0,n=0;for(const o of i){if(!o.visible())continue;const a=o.firstValue();if(a===null)continue;const l=o.autoscaleInfo(e.left(),e.right());let h=l&&l.priceRange();if(h!==null){switch(this._options.mode){case 1:h=ce(h,this._logFormula);break;case 2:h=ps(h,a.value);break;case 3:h=fs(h,a.value);break}if(t===null?t=h:t=t.merge(m(h)),l!==null){const c=l.margins();c!==null&&(r=Math.max(r,c.above),n=Math.max(n,c.below))}}}if(this.hasVisibleEdgeMarks()&&(r=Math.max(r,this.getEdgeMarksPadding()),n=Math.max(n,this.getEdgeMarksPadding())),(r!==this._marginAbove||n!==this._marginBelow)&&(this._marginAbove=r,this._marginBelow=n,this._marksCache=null,this._invalidateInternalHeightCache()),t!==null){if(t.minValue()===t.maxValue()){const o=this._formatterSource,l=5*(o===null||this.isPercentage()||this.isIndexedTo100()?1:1/o.base());this.isLog()&&(t=ue(t,this._logFormula)),t=new E(t.minValue()-l,t.maxValue()+l),this.isLog()&&(t=ce(t,this._logFormula))}if(this.isLog()){const o=ue(t,this._logFormula),a=Ge(o);if(!Ss(a,this._logFormula)){const l=this._priceRangeSnapshot!==null?ue(this._priceRangeSnapshot,this._logFormula):null;this._logFormula=a,t=ce(o,a),l!==null&&(this._priceRangeSnapshot=ce(l,a))}}this.setPriceRange(t)}else this._priceRange===null&&(this.setPriceRange(new E(-.5,.5)),this._logFormula=Ge(null))}_getCoordinateTransformer(){return this.isPercentage()?ee:this.isIndexedTo100()?_e:this.isLog()?e=>Re(e,this._logFormula):null}_formatValue(e,t,i){return t===void 0?(i===void 0&&(i=this.formatter()),i.format(e)):t(e)}_formatValues(e,t,i){return t===void 0?(i===void 0&&(i=this.formatter()),i.formatTickmarks(e)):t(e)}_formatPrice(e,t){return this._formatValue(e,this._localizationOptions.priceFormatter,t)}_formatTickmarks(e,t){const i=this._localizationOptions.priceFormatter;return this._formatValues(e,this._localizationOptions.tickmarksPriceFormatter??(i?r=>r.map(i):void 0),t)}_formatPercentage(e,t){return this._formatValue(e,this._localizationOptions.percentageFormatter,t)}_formatPercentageTickmarks(e,t){const i=this._localizationOptions.percentageFormatter;return this._formatValues(e,this._localizationOptions.tickmarksPercentageFormatter??(i?r=>r.map(i):void 0),t)}}class ys extends Q{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(e,t){var o;if(!((o=this._data)!=null&&o.visible))return null;const{y:i,lineWidth:r,externalId:n}=this._data;return t>=i-r-7&&t<=i+r+7?{hitTestData:this._data,externalId:n}:null}_drawImpl({context:e,bitmapSize:t,horizontalPixelRatio:i,verticalPixelRatio:r}){if(this._data===null||this._data.visible===!1)return;const n=Math.round(this._data.y*r);n<0||n>t.height||(e.lineCap="butt",e.strokeStyle=this._data.color,e.lineWidth=Math.floor(this._data.lineWidth*i),j(e,this._data.lineStyle),ci(e,n,0,t.width))}}class mt{constructor(e){this._lineRendererData={y:0,color:"rgba(0, 0, 0, 0)",lineWidth:1,lineStyle:z.Solid,visible:!1},this._lineRenderer=new ys,this._invalidated=!0,this._series=e,this._model=e.model(),this._lineRenderer.setData(this._lineRendererData)}update(){this._invalidated=!0}renderer(){return this._series.visible()?(this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._lineRenderer):null}}class xs extends mt{constructor(e){super(e)}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.priceScale(),t=e.mode().mode;if(t!==Ve.Percentage&&t!==Ve.IndexedTo100)return;const i=this._series.options();if(!i.baseLineVisible||!this._series.visible())return;const r=this._series.firstValue();r!==null&&(this._lineRendererData.visible=!0,this._lineRendererData.y=e.priceToCoordinate(r.value,r.value),this._lineRendererData.color=i.baseLineColor,this._lineRendererData.lineWidth=i.baseLineWidth,this._lineRendererData.lineStyle=i.baseLineStyle)}}class Ts extends Q{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}data(){return this._data}_drawImpl({context:e,horizontalPixelRatio:t,verticalPixelRatio:i}){const r=this._data;if(r===null)return;const n=Math.max(1,Math.floor(t)),o=n%2/2,a=Math.round(r.center.x*t)+o,l=r.center.y*i;e.fillStyle=r.seriesLineColor,e.beginPath();const h=Math.max(2,r.seriesLineWidth*1.5)*t;e.arc(a,l,h,0,2*Math.PI,!1),e.fill(),e.fillStyle=r.fillColor,e.beginPath(),e.arc(a,l,r.radius*t,0,2*Math.PI,!1),e.fill(),e.lineWidth=n,e.strokeStyle=r.strokeColor,e.beginPath(),e.arc(a,l,r.radius*t+n/2,0,2*Math.PI,!1),e.stroke()}}const Ms=[{start:0,end:.25,startRadius:4,endRadius:10,startFillAlpha:.25,endFillAlpha:0,startStrokeAlpha:.4,endStrokeAlpha:.8},{start:.25,end:.25+.275,startRadius:10,endRadius:14,startFillAlpha:0,endFillAlpha:0,startStrokeAlpha:.8,endStrokeAlpha:0},{start:.25+.275,end:.25+.275+.475,startRadius:14,endRadius:14,startFillAlpha:0,endFillAlpha:0,startStrokeAlpha:0,endStrokeAlpha:0}];function ks(s,e,t){return e+(t-e)*s}class Bs{constructor(e){this._renderer=new Ts,this._invalidated=!0,this._stageInvalidated=!0,this._startTime=performance.now(),this._endTime=this._startTime-1,this._series=e}onDataCleared(){this._endTime=this._startTime-1,this.update()}onNewRealtimeDataReceived(){if(this.update(),this._series.options().lastPriceAnimation===O.OnDataUpdate){const e=performance.now(),t=this._endTime-e;if(t>0){t<2600/4&&(this._endTime+=2600);return}this._startTime=e,this._endTime=e+2600}}update(){this._invalidated=!0}invalidateStage(){this._stageInvalidated=!0}visible(){return this._series.options().lastPriceAnimation!==O.Disabled}animationActive(){switch(this._series.options().lastPriceAnimation){case O.Disabled:return!1;case O.Continuous:return!0;case O.OnDataUpdate:return performance.now()<=this._endTime}}renderer(){return this._invalidated?(this._updateImpl(),this._invalidated=!1,this._stageInvalidated=!1):this._stageInvalidated&&(this._updateRendererDataStage(),this._stageInvalidated=!1),this._renderer}_updateImpl(){this._renderer.setData(null);const e=this._series.model().timeScale(),t=e.visibleStrictRange(),i=this._series.firstValue();if(t===null||i===null)return;const r=this._series.lastValueData(!0);if(r.noData||!t.contains(r.index))return;const n={x:e.indexToCoordinate(r.index),y:this._series.priceScale().priceToCoordinate(r.price,i.value)},o=r.color,a=this._series.options().lineWidth,l=this._animationData(this._duration(),o);this._renderer.setData({seriesLineColor:o,seriesLineWidth:a,fillColor:l.fillColor,strokeColor:l.strokeColor,radius:l.radius,center:n})}_updateRendererDataStage(){const e=this._renderer.data();if(e!==null){const t=this._animationData(this._duration(),e.seriesLineColor);e.fillColor=t.fillColor,e.strokeColor=t.strokeColor,e.radius=t.radius}}_duration(){return this.animationActive()?performance.now()-this._startTime:2599}_color(e,t,i,r){const n=i+(r-i)*t;return this._series.model().colorParser().applyAlpha(e,n)}_animationData(e,t){const i=e%2600/2600;let r;for(const o of Ms)if(i>=o.start&&i<=o.end){r=o;break}k(r!==void 0,"Last price animation internal logic error");const n=(i-r.start)/(r.end-r.start);return{fillColor:this._color(t,n,r.startFillAlpha,r.endFillAlpha),strokeColor:this._color(t,n,r.startStrokeAlpha,r.endStrokeAlpha),radius:ks(n,r.startRadius,r.endRadius)}}}class Es extends mt{constructor(e){super(e)}_updateImpl(){const e=this._lineRendererData;e.visible=!1;const t=this._series.options();if(!t.priceLineVisible||!this._series.visible())return;const i=this._series.lastValueData(t.priceLineSource===ut.LastBar);i.noData||(e.visible=!0,e.y=i.coordinate,e.color=this._series.priceLineColor(i.color),e.lineWidth=t.priceLineWidth,e.lineStyle=t.priceLineStyle)}}class Rs extends ze{constructor(e){super(),this._source=e}_updateRendererData(e,t,i){e.visible=!1,t.visible=!1;const r=this._source;if(!r.visible())return;const n=r.options(),o=n.lastValueVisible,a=r.title()!=="",l=n.seriesLastValueMode===hi.LastPriceAndPercentageValue,h=r.lastValueData(!1);if(h.noData)return;o&&(e.text=this._axisText(h,o,l),e.visible=e.text.length!==0),(a||l)&&(t.text=this._paneText(h,o,a,l),t.visible=t.text.length>0);const c=r.priceLineColor(h.color),d=this._source.model().colorParser().generateContrastColors(c);i.background=d.background,i.coordinate=h.coordinate,t.borderColor=r.model().backgroundColorAtYPercentFromTop(h.coordinate/r.priceScale().height()),e.borderColor=c,e.color=d.foreground,t.color=d.foreground}_paneText(e,t,i,r){let n="";const o=this._source.title();return i&&o.length!==0&&(n+=`${o} `),t&&r&&(n+=this._source.priceScale().isPercentage()?e.formattedPriceAbsolute:e.formattedPricePercentage),n.trim()}_axisText(e,t,i){return t?i?this._source.priceScale().isPercentage()?e.formattedPricePercentage:e.formattedPriceAbsolute:e.text:""}}class Ae{constructor(e,t){this._priceRange=e,this._margins=t||null}priceRange(){return this._priceRange}margins(){return this._margins}toRaw(){return{priceRange:this._priceRange===null?null:this._priceRange.toRaw(),margins:this._margins||void 0}}static fromRaw(e){return e===null?null:new Ae(E.fromRaw(e.priceRange),e.margins)}}class Vs extends mt{constructor(e,t){super(e),this._priceLine=t}_updateImpl(){const e=this._lineRendererData;e.visible=!1;const t=this._priceLine.options();if(!this._series.visible()||!t.lineVisible)return;const i=this._priceLine.yCoord();i!==null&&(e.visible=!0,e.y=i,e.color=t.color,e.lineWidth=t.lineWidth,e.lineStyle=t.lineStyle,e.externalId=this._priceLine.options().id)}}class As extends ze{constructor(e,t){super(),this._series=e,this._priceLine=t}_updateRendererData(e,t,i){e.visible=!1,t.visible=!1;const r=this._priceLine.options(),n=r.axisLabelVisible,o=r.title!=="",a=this._series;if(!n||!a.visible())return;const l=this._priceLine.yCoord();if(l===null)return;o&&(t.text=r.title,t.visible=!0),t.borderColor=a.model().backgroundColorAtYPercentFromTop(l/a.priceScale().height()),e.text=this._formatPrice(r.price),e.visible=!0;const h=this._series.model().colorParser().generateContrastColors(r.axisLabelColor||r.color);i.background=h.background;const c=r.axisLabelTextColor||h.foreground;e.color=c,t.color=c,i.coordinate=l}_formatPrice(e){const t=this._series.firstValue();return t===null?"":this._series.priceScale().formatPrice(e,t.value)}}class Ls{constructor(e,t){this._series=e,this._options=t,this._priceLineView=new Vs(e,this),this._priceAxisView=new As(e,this),this._panePriceAxisView=new Si(this._priceAxisView,e,e.model())}applyOptions(e){A(this._options,e),this.update(),this._series.model().lightUpdate()}options(){return this._options}paneView(){return this._priceLineView}labelPaneView(){return this._panePriceAxisView}priceAxisView(){return this._priceAxisView}update(){this._priceLineView.update(),this._priceAxisView.update()}yCoord(){const e=this._series,t=e.priceScale();if(e.model().timeScale().isEmpty()||t.isEmpty())return null;const r=e.firstValue();return r===null?null:t.priceToCoordinate(this._options.price,r.value)}}function bi(s,e,t,i,r=0,n=e.length){let o=n-r;for(;0<o;){const a=o>>1,l=r+a;i(e[l],t)===s?(r=l+1,o-=a+1):o=a}return r}const re=bi.bind(null,!0),Ci=bi.bind(null,!1);var ge=(s=>(s[s.NearestLeft=-1]="NearestLeft",s[s.None=0]="None",s[s.NearestRight=1]="NearestRight",s))(ge||{});const U=30;class zs{constructor(){this._items=[],this._minMaxCache=new Map,this._rowSearchCache=new Map,this._indices=[]}last(){return this.size()>0?this._items[this._items.length-1]:null}firstIndex(){return this.size()>0?this._indexAt(0):null}lastIndex(){return this.size()>0?this._indexAt(this._items.length-1):null}size(){return this._items.length}isEmpty(){return this.size()===0}contains(e){return this._search(e,0)!==null}valueAt(e){return this.search(e)}search(e,t=0){const i=this._search(e,t);return i===null?null:{...this._valueAt(i),index:this._indexAt(i)}}rows(){return this._items}minMaxOnRangeCached(e,t,i){if(this.isEmpty())return null;let r=null;for(const n of i){const o=this._minMaxOnRangeCachedImpl(e,t,n);r=we(r,o)}return r}setData(e){this._rowSearchCache.clear(),this._minMaxCache.clear(),this._items=e,this._indices=e.map(t=>t.index)}indices(){return this._indices}_indexAt(e){return this._items[e].index}_valueAt(e){return this._items[e]}_search(e,t){const i=this._bsearch(e);if(i===null&&t!==0)switch(t){case-1:return this._searchNearestLeft(e);case 1:return this._searchNearestRight(e);default:throw new TypeError("Unknown search mode")}return i}_searchNearestLeft(e){let t=this._lowerbound(e);return t>0&&(t=t-1),t!==this._items.length&&this._indexAt(t)<e?t:null}_searchNearestRight(e){const t=this._upperbound(e);return t!==this._items.length&&e<this._indexAt(t)?t:null}_bsearch(e){const t=this._lowerbound(e);return t!==this._items.length&&!(e<this._items[t].index)?t:null}_lowerbound(e){return re(this._items,e,(t,i)=>t.index<i)}_upperbound(e){return Ci(this._items,e,(t,i)=>t.index>i)}_plotMinMax(e,t,i){let r=null;for(let n=e;n<t;n++){const a=this._items[n].value[i];Number.isNaN(a)||(r===null?r={min:a,max:a}:(a<r.min&&(r.min=a),a>r.max&&(r.max=a)))}return r}_minMaxOnRangeCachedImpl(e,t,i){if(this.isEmpty())return null;let r=null;const n=m(this.firstIndex()),o=m(this.lastIndex()),a=Math.max(e,n),l=Math.min(t,o),h=Math.ceil(a/U)*U,c=Math.max(h,Math.floor(l/U)*U);{const u=this._lowerbound(a),_=this._upperbound(Math.min(l,h,t)),p=this._plotMinMax(u,_,i);r=we(r,p)}let d=this._minMaxCache.get(i);d===void 0&&(d=new Map,this._minMaxCache.set(i,d));for(let u=Math.max(h+1,a);u<c;u+=U){const _=Math.floor(u/U);let p=d.get(_);if(p===void 0){const f=this._lowerbound(_*U),g=this._upperbound((_+1)*U-1);p=this._plotMinMax(f,g,i),d.set(_,p)}r=we(r,p)}{const u=this._lowerbound(c),_=this._upperbound(l),p=this._plotMinMax(u,_,i);r=we(r,p)}return r}}function we(s,e){if(s===null)return e;if(e===null)return s;{const t=Math.min(s.min,e.min),i=Math.max(s.max,e.max);return{min:t,max:i}}}class Ds extends mi{constructor(e){super(),this._model=e}model(){return this._model}}const Is={Bar:(s,e,t,i)=>{const r=e.upColor,n=e.downColor,o=m(s(t,i)),a=X(o.value[C.Open])<=X(o.value[C.Close]);return{barColor:o.color??(a?r:n)}},Candlestick:(s,e,t,i)=>{const r=e.upColor,n=e.downColor,o=e.borderUpColor,a=e.borderDownColor,l=e.wickUpColor,h=e.wickDownColor,c=m(s(t,i)),d=X(c.value[C.Open])<=X(c.value[C.Close]);return{barColor:c.color??(d?r:n),barBorderColor:c.borderColor??(d?o:a),barWickColor:c.wickColor??(d?l:h)}},Custom:(s,e,t,i)=>({barColor:m(s(t,i)).color??e.color}),Area:(s,e,t,i)=>{const r=m(s(t,i));return{barColor:r.lineColor??e.lineColor,lineColor:r.lineColor??e.lineColor,topColor:r.topColor??e.topColor,bottomColor:r.bottomColor??e.bottomColor}},Baseline:(s,e,t,i)=>{const r=m(s(t,i));return{barColor:r.value[C.Close]>=e.baseValue.price?e.topLineColor:e.bottomLineColor,topLineColor:r.topLineColor??e.topLineColor,bottomLineColor:r.bottomLineColor??e.bottomLineColor,topFillColor1:r.topFillColor1??e.topFillColor1,topFillColor2:r.topFillColor2??e.topFillColor2,bottomFillColor1:r.bottomFillColor1??e.bottomFillColor1,bottomFillColor2:r.bottomFillColor2??e.bottomFillColor2}},Line:(s,e,t,i)=>{const r=m(s(t,i));return{barColor:r.color??e.color,lineColor:r.color??e.color}},Histogram:(s,e,t,i)=>({barColor:m(s(t,i)).color??e.color})};class Os{constructor(e){this._findBar=(t,i)=>i!==void 0?i.value:this._series.bars().valueAt(t),this._series=e,this._styleGetter=Is[e.seriesType()]}barStyle(e,t){return this._styleGetter(this._findBar,this._series.options(),e,t)}}function Ws(){return new zs}class Fs{constructor(e){this._baseRenderer=e}draw(e,t,i){this._baseRenderer.draw(e)}drawBackground(e,t,i){var r,n;(n=(r=this._baseRenderer).drawBackground)==null||n.call(r,e)}}class Hs{constructor(e){this._cache=null,this._paneView=e}renderer(){var i;const e=this._paneView.renderer();if(e===null)return null;if(((i=this._cache)==null?void 0:i.base)===e)return this._cache.wrapper;const t=new Fs(e);return this._cache={base:e,wrapper:t},t}zOrder(){var e,t;return((t=(e=this._paneView).zOrder)==null?void 0:t.call(e))??"normal"}}class Pi{constructor(e){this._paneViewsCache=null,this._primitive=e}primitive(){return this._primitive}updateAllViews(){var e,t;(t=(e=this._primitive).updateAllViews)==null||t.call(e)}paneViews(){var i,r,n;const e=((r=(i=this._primitive).paneViews)==null?void 0:r.call(i))??[];if(((n=this._paneViewsCache)==null?void 0:n.base)===e)return this._paneViewsCache.wrapper;const t=e.map(o=>new Hs(o));return this._paneViewsCache={base:e,wrapper:t},t}hitTest(e,t){var i,r;return((r=(i=this._primitive).hitTest)==null?void 0:r.call(i,e,t))??null}}class Ns extends Pi{labelPaneViews(){return[]}}class Us{constructor(e){this._baseRenderer=e}draw(e,t,i){this._baseRenderer.draw(e)}drawBackground(e,t,i){var r,n;(n=(r=this._baseRenderer).drawBackground)==null||n.call(r,e)}}class Dt{constructor(e){this._cache=null,this._paneView=e}renderer(){var i;const e=this._paneView.renderer();if(e===null)return null;if(((i=this._cache)==null?void 0:i.base)===e)return this._cache.wrapper;const t=new Us(e);return this._cache={base:e,wrapper:t},t}zOrder(){var e,t;return((t=(e=this._paneView).zOrder)==null?void 0:t.call(e))??"normal"}}function wi(s){var e,t,i;return{text:s.text(),coordinate:s.coordinate(),fixedCoordinate:(e=s.fixedCoordinate)==null?void 0:e.call(s),color:s.textColor(),background:s.backColor(),visible:((t=s.visible)==null?void 0:t.call(s))??!0,tickVisible:((i=s.tickVisible)==null?void 0:i.call(s))??!0}}class Ys{constructor(e,t){this._renderer=new pi,this._baseView=e,this._timeScale=t}renderer(){return this._renderer.setData({width:this._timeScale.width(),...wi(this._baseView)}),this._renderer}}class Xs extends ze{constructor(e,t){super(),this._baseView=e,this._priceScale=t}_updateRendererData(e,t,i){const r=wi(this._baseView);i.background=r.background,e.color=r.color;const n=2/12*this._priceScale.fontSize();i.additionalPaddingTop=n,i.additionalPaddingBottom=n,i.coordinate=r.coordinate,i.fixedCoordinate=r.fixedCoordinate,e.text=r.text,e.visible=r.visible,e.tickVisible=r.tickVisible}}class Gs extends Pi{constructor(e,t){super(e),this._timeAxisViewsCache=null,this._priceAxisViewsCache=null,this._priceAxisPaneViewsCache=null,this._timeAxisPaneViewsCache=null,this._series=t}timeAxisViews(){var r,n,o;const e=((n=(r=this._primitive).timeAxisViews)==null?void 0:n.call(r))??[];if(((o=this._timeAxisViewsCache)==null?void 0:o.base)===e)return this._timeAxisViewsCache.wrapper;const t=this._series.model().timeScale(),i=e.map(a=>new Ys(a,t));return this._timeAxisViewsCache={base:e,wrapper:i},i}priceAxisViews(){var r,n,o;const e=((n=(r=this._primitive).priceAxisViews)==null?void 0:n.call(r))??[];if(((o=this._priceAxisViewsCache)==null?void 0:o.base)===e)return this._priceAxisViewsCache.wrapper;const t=this._series.priceScale(),i=e.map(a=>new Xs(a,t));return this._priceAxisViewsCache={base:e,wrapper:i},i}priceAxisPaneViews(){var i,r,n;const e=((r=(i=this._primitive).priceAxisPaneViews)==null?void 0:r.call(i))??[];if(((n=this._priceAxisPaneViewsCache)==null?void 0:n.base)===e)return this._priceAxisPaneViewsCache.wrapper;const t=e.map(o=>new Dt(o));return this._priceAxisPaneViewsCache={base:e,wrapper:t},t}timeAxisPaneViews(){var i,r,n;const e=((r=(i=this._primitive).timeAxisPaneViews)==null?void 0:r.call(i))??[];if(((n=this._timeAxisPaneViewsCache)==null?void 0:n.base)===e)return this._timeAxisPaneViewsCache.wrapper;const t=e.map(o=>new Dt(o));return this._timeAxisPaneViewsCache={base:e,wrapper:t},t}autoscaleInfo(e,t){var i,r;return((r=(i=this._primitive).autoscaleInfo)==null?void 0:r.call(i,e,t))??null}}function je(s,e,t,i){s.forEach(r=>{e(r).forEach(n=>{n.zOrder()===t&&i.push(n)})})}function Ke(s){return s.paneViews()}function $s(s){return s.priceAxisPaneViews()}function js(s){return s.timeAxisPaneViews()}const Ks=["Area","Line","Baseline"];class Oe extends Ds{constructor(e,t,i,r,n){super(e),this._data=Ws(),this._priceLineView=new Es(this),this._customPriceLines=[],this._baseHorizontalLineView=new xs(this),this._lastPriceAnimationPaneView=null,this._barColorerCache=null,this._animationTimeoutId=null,this._primitives=[],this._options=i,this._seriesType=t;const o=new Rs(this);this._priceAxisViews=[o],this._panePriceAxisView=new Si(o,this,e),Ks.includes(this._seriesType)&&(this._lastPriceAnimationPaneView=new Bs(this)),this._recreateFormatter(),this._paneView=r(this,this.model(),n)}destroy(){this._animationTimeoutId!==null&&clearTimeout(this._animationTimeoutId)}priceLineColor(e){return this._options.priceLineColor||e}lastValueData(e){const t={noData:!0},i=this.priceScale();if(this.model().timeScale().isEmpty()||i.isEmpty()||this._data.isEmpty())return t;const r=this.model().timeScale().visibleStrictRange(),n=this.firstValue();if(r===null||n===null)return t;let o,a;if(e){const u=this._data.last();if(u===null)return t;o=u,a=u.index}else{const u=this._data.search(r.right(),ge.NearestLeft);if(u===null||(o=this._data.valueAt(u.index),o===null))return t;a=u.index}const l=o.value[C.Close],c=this.barColorer().barStyle(a,{value:o}),d=i.priceToCoordinate(l,n.value);return{noData:!1,price:l,text:i.formatPrice(l,n.value),formattedPriceAbsolute:i.formatPriceAbsolute(l),formattedPricePercentage:i.formatPricePercentage(l,n.value),color:c.barColor,coordinate:d,index:a}}barColorer(){return this._barColorerCache!==null?this._barColorerCache:(this._barColorerCache=new Os(this),this._barColorerCache)}options(){return this._options}applyOptions(e){const t=e.priceScaleId;t!==void 0&&t!==this._options.priceScaleId&&this.model().moveSeriesToScale(this,t),A(this._options,e),e.priceFormat!==void 0&&(this._recreateFormatter(),this.model().fullUpdate()),this.model().updateSource(this),this.model().updateCrosshair(),this._paneView.update("options")}setData(e,t){this._data.setData(e),this._paneView.update("data"),this._lastPriceAnimationPaneView!==null&&(t&&t.lastBarUpdatedOrNewBarsAddedToTheRight?this._lastPriceAnimationPaneView.onNewRealtimeDataReceived():e.length===0&&this._lastPriceAnimationPaneView.onDataCleared());const i=this.model().paneForSource(this);this.model().recalculatePane(i),this.model().updateSource(this),this.model().updateCrosshair(),this.model().lightUpdate()}createPriceLine(e){const t=new Ls(this,e);return this._customPriceLines.push(t),this.model().updateSource(this),t}removePriceLine(e){const t=this._customPriceLines.indexOf(e);t!==-1&&this._customPriceLines.splice(t,1),this.model().updateSource(this)}priceLines(){return this._customPriceLines}seriesType(){return this._seriesType}firstValue(){const e=this.firstBar();return e===null?null:{value:e.value[C.Close],timePoint:e.time}}firstBar(){const e=this.model().timeScale().visibleStrictRange();if(e===null)return null;const t=e.left();return this._data.search(t,ge.NearestRight)}bars(){return this._data}dataAt(e){const t=this._data.valueAt(e);return t===null?null:this._seriesType==="Bar"||this._seriesType==="Candlestick"||this._seriesType==="Custom"?{open:t.value[C.Open],high:t.value[C.High],low:t.value[C.Low],close:t.value[C.Close]}:t.value[C.Close]}topPaneViews(e){const t=[];je(this._primitives,Ke,"top",t);const i=this._lastPriceAnimationPaneView;return i===null||!i.visible()||(this._animationTimeoutId===null&&i.animationActive()&&(this._animationTimeoutId=setTimeout(()=>{this._animationTimeoutId=null,this.model().cursorUpdate()},0)),i.invalidateStage(),t.unshift(i)),t}paneViews(){const e=[];this._isOverlay()||e.push(this._baseHorizontalLineView),e.push(this._paneView,this._priceLineView);const t=this._customPriceLines.map(i=>i.paneView());return e.push(...t),je(this._primitives,Ke,"normal",e),e}bottomPaneViews(){return this._extractPaneViews(Ke,"bottom")}pricePaneViews(e){return this._extractPaneViews($s,e)}timePaneViews(e){return this._extractPaneViews(js,e)}primitiveHitTest(e,t){return this._primitives.map(i=>i.hitTest(e,t)).filter(i=>i!==null)}labelPaneViews(){return[this._panePriceAxisView,...this._customPriceLines.map(e=>e.labelPaneView())]}priceAxisViews(e,t){if(t!==this._priceScale&&!this._isOverlay())return[];const i=[...this._priceAxisViews];for(const r of this._customPriceLines)i.push(r.priceAxisView());return this._primitives.forEach(r=>{i.push(...r.priceAxisViews())}),i}timeAxisViews(){const e=[];return this._primitives.forEach(t=>{e.push(...t.timeAxisViews())}),e}autoscaleInfo(e,t){if(this._options.autoscaleInfoProvider!==void 0){const i=this._options.autoscaleInfoProvider(()=>{const r=this._autoscaleInfoImpl(e,t);return r===null?null:r.toRaw()});return Ae.fromRaw(i)}return this._autoscaleInfoImpl(e,t)}base(){const e=this._options.priceFormat;return e.base??1/e.minMove}formatter(){return this._formatter}updateAllViews(){var e;this._paneView.update();for(const t of this._priceAxisViews)t.update();for(const t of this._customPriceLines)t.update();this._priceLineView.update(),this._baseHorizontalLineView.update(),(e=this._lastPriceAnimationPaneView)==null||e.update(),this._primitives.forEach(t=>t.updateAllViews())}priceScale(){return m(super.priceScale())}markerDataAtIndex(e){if(!((this._seriesType==="Line"||this._seriesType==="Area"||this._seriesType==="Baseline")&&this._options.crosshairMarkerVisible))return null;const i=this._data.valueAt(e);if(i===null)return null;const r=i.value[C.Close],n=this._markerRadius(),o=this._markerBorderColor(),a=this._markerBorderWidth(),l=this._markerBackgroundColor(e);return{price:r,radius:n,borderColor:o,borderWidth:a,backgroundColor:l}}title(){return this._options.title}visible(){return this._options.visible}attachPrimitive(e){this._primitives.push(new Gs(e,this))}detachPrimitive(e){this._primitives=this._primitives.filter(t=>t.primitive()!==e)}customSeriesPlotValuesBuilder(){if(this._seriesType==="Custom")return e=>this._paneView.priceValueBuilder(e)}customSeriesWhitespaceCheck(){if(this._seriesType==="Custom")return e=>this._paneView.isWhitespace(e)}fulfilledIndices(){return this._data.indices()}_isOverlay(){const e=this.priceScale();return!De(e.id())}_autoscaleInfoImpl(e,t){if(!me(e)||!me(t)||this._data.isEmpty())return null;const i=this._seriesType==="Line"||this._seriesType==="Area"||this._seriesType==="Baseline"||this._seriesType==="Histogram"?[C.Close]:[C.Low,C.High],r=this._data.minMaxOnRangeCached(e,t,i);let n=r!==null?new E(r.min,r.max):null,o=null;if(this.seriesType()==="Histogram"){const a=this._options.base,l=new E(a,a);n=n!==null?n.merge(l):l}return this._primitives.forEach(a=>{const l=a.autoscaleInfo(e,t);if(l!=null&&l.priceRange){const h=new E(l.priceRange.minValue,l.priceRange.maxValue);n=n!==null?n.merge(h):h}l!=null&&l.margins&&(o=l.margins)}),new Ae(n,o)}_markerRadius(){switch(this._seriesType){case"Line":case"Area":case"Baseline":return this._options.crosshairMarkerRadius}return 0}_markerBorderColor(){switch(this._seriesType){case"Line":case"Area":case"Baseline":{const e=this._options.crosshairMarkerBorderColor;if(e.length!==0)return e}}return null}_markerBorderWidth(){switch(this._seriesType){case"Line":case"Area":case"Baseline":return this._options.crosshairMarkerBorderWidth}return 0}_markerBackgroundColor(e){switch(this._seriesType){case"Line":case"Area":case"Baseline":{const t=this._options.crosshairMarkerBackgroundColor;if(t.length!==0)return t}}return this.barColorer().barStyle(e).barColor}_recreateFormatter(){switch(this._options.priceFormat.type){case"custom":{const e=this._options.priceFormat.formatter;this._formatter={format:e,formatTickmarks:this._options.priceFormat.tickmarksFormatter??(t=>t.map(e))};break}case"volume":{this._formatter=new cs(this._options.priceFormat.precision);break}case"percent":{this._formatter=new gi(this._options.priceFormat.precision);break}default:{const e=Math.pow(10,this._options.priceFormat.precision);this._formatter=new Ie(e,this._options.priceFormat.minMove*e)}}this._priceScale!==null&&this._priceScale.updateFormatter()}_extractPaneViews(e,t){const i=[];return je(this._primitives,e,t,i),i}}const qs=[C.Close],Zs=[C.Open,C.High,C.Low,C.Close];class Qs{constructor(e){this._options=e}align(e,t,i){let r=e;if(this._options.mode===N.Normal)return r;const n=i.defaultPriceScale(),o=n.firstValue();if(o===null)return r;const a=n.priceToCoordinate(e,o),h=i.dataSources().filter(d=>d instanceof Oe).reduce((d,u)=>{if(i.isOverlay(u)||!u.visible())return d;const _=u.priceScale(),p=u.bars();if(_.isEmpty()||!p.contains(t))return d;const f=p.valueAt(t);if(f===null)return d;const g=X(u.firstValue()),S=this._options.mode===N.MagnetOHLC?Zs:qs;return d.concat(S.map(v=>_.priceToCoordinate(f.value[v],g.value)))},[]);if(h.length===0)return r;h.sort((d,u)=>Math.abs(d-a)-Math.abs(u-a));const c=h[0];return r=n.coordinateToPrice(c,o),r}}class Js extends Q{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}_drawImpl({context:e,bitmapSize:t,horizontalPixelRatio:i,verticalPixelRatio:r}){if(this._data===null)return;const n=Math.max(1,Math.floor(i));e.lineWidth=n,Yi(e,()=>{const o=m(this._data);if(o.vertLinesVisible){e.strokeStyle=o.vertLinesColor,j(e,o.vertLineStyle),e.beginPath();for(const a of o.timeMarks){const l=Math.round(a.coord*i);e.moveTo(l,-n),e.lineTo(l,t.height+n)}e.stroke()}if(o.horzLinesVisible){e.strokeStyle=o.horzLinesColor,j(e,o.horzLineStyle),e.beginPath();for(const a of o.priceMarks){const l=Math.round(a.coord*r);e.moveTo(-n,l),e.lineTo(t.width+n,l)}e.stroke()}})}}class er{constructor(e){this._renderer=new Js,this._invalidated=!0,this._pane=e}update(){this._invalidated=!0}renderer(){if(this._invalidated){const e=this._pane.model().options().grid,t={horzLinesVisible:e.horzLines.visible,vertLinesVisible:e.vertLines.visible,horzLinesColor:e.horzLines.color,vertLinesColor:e.vertLines.color,horzLineStyle:e.horzLines.style,vertLineStyle:e.vertLines.style,priceMarks:this._pane.defaultPriceScale().marks(),timeMarks:(this._pane.model().timeScale().marks()||[]).map(i=>({coord:i.coord}))};this._renderer.setData(t),this._invalidated=!1}return this._renderer}}class tr{constructor(e){this._paneView=new er(e)}paneView(){return this._paneView}}function It(s){return s instanceof Oe}const yi=1,Ot=30;class xi{constructor(e,t){this._dataSources=[],this._overlaySourcesByScaleId=new Map,this._height=0,this._width=0,this._stretchFactor=yi,this._cachedOrderedSources=null,this._preserveEmptyPane=!1,this._destroyed=new T,this._primitives=[],this._timeScale=e,this._model=t,this._grid=new tr(this);const i=t.options();this._leftPriceScale=this._createPriceScale(L.Left,i.leftPriceScale),this._rightPriceScale=this._createPriceScale(L.Right,i.rightPriceScale),this._leftPriceScale.modeChanged().subscribe(this._onPriceScaleModeChanged.bind(this,this._leftPriceScale),this),this._rightPriceScale.modeChanged().subscribe(this._onPriceScaleModeChanged.bind(this,this._rightPriceScale),this),this.applyScaleOptions(i)}applyScaleOptions(e){if(e.leftPriceScale&&this._leftPriceScale.applyOptions(e.leftPriceScale),e.rightPriceScale&&this._rightPriceScale.applyOptions(e.rightPriceScale),e.localization&&(this._leftPriceScale.updateFormatter(),this._rightPriceScale.updateFormatter()),e.overlayPriceScales){const t=Array.from(this._overlaySourcesByScaleId.values());for(const i of t){const r=m(i[0].priceScale());r.applyOptions(e.overlayPriceScales),e.localization&&r.updateFormatter()}}}priceScaleById(e){switch(e){case L.Left:return this._leftPriceScale;case L.Right:return this._rightPriceScale}return this._overlaySourcesByScaleId.has(e)?V(this._overlaySourcesByScaleId.get(e))[0].priceScale():null}destroy(){this.model().priceScalesOptionsChanged().unsubscribeAll(this),this._leftPriceScale.modeChanged().unsubscribeAll(this),this._rightPriceScale.modeChanged().unsubscribeAll(this),this._dataSources.forEach(e=>{e.destroy&&e.destroy()}),this._primitives=this._primitives.filter(e=>{const t=e.primitive();return t.detached&&t.detached(),!1}),this._destroyed.fire()}stretchFactor(){return this._stretchFactor}setStretchFactor(e){this._stretchFactor=e}model(){return this._model}width(){return this._width}height(){return this._height}setWidth(e){this._width=e,this.updateAllSources()}setHeight(e){this._height=e,this._leftPriceScale.setHeight(e),this._rightPriceScale.setHeight(e),this._dataSources.forEach(t=>{if(this.isOverlay(t)){const i=t.priceScale();i!==null&&i.setHeight(e)}}),this.updateAllSources()}setPreserveEmptyPane(e){this._preserveEmptyPane=e}preserveEmptyPane(){return this._preserveEmptyPane}series(){return this._dataSources.filter(It)}dataSources(){return this._dataSources}isOverlay(e){const t=e.priceScale();return t===null?!0:this._leftPriceScale!==t&&this._rightPriceScale!==t}addDataSource(e,t,i){this._insertDataSource(e,t,i?e.zorder():this._dataSources.length)}removeDataSource(e,t){const i=this._dataSources.indexOf(e);k(i!==-1,"removeDataSource: invalid data source"),this._dataSources.splice(i,1),t||this._dataSources.forEach((o,a)=>o.setZorder(a));const r=m(e.priceScale()).id();if(this._overlaySourcesByScaleId.has(r)){const o=V(this._overlaySourcesByScaleId.get(r)),a=o.indexOf(e);a!==-1&&(o.splice(a,1),o.length===0&&this._overlaySourcesByScaleId.delete(r))}const n=e.priceScale();n&&n.dataSources().indexOf(e)>=0&&(n.removeDataSource(e),this.recalculatePriceScale(n)),this._cachedOrderedSources=null}priceScalePosition(e){return e===this._leftPriceScale?"left":e===this._rightPriceScale?"right":"overlay"}leftPriceScale(){return this._leftPriceScale}rightPriceScale(){return this._rightPriceScale}startScalePrice(e,t){e.startScale(t)}scalePriceTo(e,t){e.scaleTo(t),this.updateAllSources()}endScalePrice(e){e.endScale()}startScrollPrice(e,t){e.startScroll(t)}scrollPriceTo(e,t){e.scrollTo(t),this.updateAllSources()}endScrollPrice(e){e.endScroll()}updateAllSources(){this._dataSources.forEach(e=>{e.updateAllViews()})}defaultPriceScale(){let e=null;return this._model.options().rightPriceScale.visible&&this._rightPriceScale.dataSources().length!==0?e=this._rightPriceScale:this._model.options().leftPriceScale.visible&&this._leftPriceScale.dataSources().length!==0?e=this._leftPriceScale:this._dataSources.length!==0&&(e=this._dataSources[0].priceScale()),e===null&&(e=this._rightPriceScale),e}defaultVisiblePriceScale(){let e=null;return this._model.options().rightPriceScale.visible?e=this._rightPriceScale:this._model.options().leftPriceScale.visible&&(e=this._leftPriceScale),e}recalculatePriceScale(e){e===null||!e.isAutoScale()||this._recalculatePriceScaleImpl(e)}resetPriceScale(e){const t=this._timeScale.visibleStrictRange();e.setMode({autoScale:!0}),t!==null&&e.recalculatePriceRange(t),this.updateAllSources()}momentaryAutoScale(){this._recalculatePriceScaleImpl(this._leftPriceScale),this._recalculatePriceScaleImpl(this._rightPriceScale)}recalculate(){this.recalculatePriceScale(this._leftPriceScale),this.recalculatePriceScale(this._rightPriceScale),this._dataSources.forEach(e=>{this.isOverlay(e)&&this.recalculatePriceScale(e.priceScale())}),this.updateAllSources(),this._model.lightUpdate()}orderedSources(){return this._cachedOrderedSources===null&&(this._cachedOrderedSources=vi(this._dataSources)),this._cachedOrderedSources}setSeriesOrder(e,t){t=te(t,0,this._dataSources.length-1);const i=this._dataSources.indexOf(e);k(i!==-1,"setSeriesOrder: invalid data source"),this._dataSources.splice(i,1),this._dataSources.splice(t,0,e),this._dataSources.forEach((r,n)=>r.setZorder(n)),this._cachedOrderedSources=null;for(const r of[this._leftPriceScale,this._rightPriceScale])r.invalidateSourcesCache(),r.updateFormatter();this._model.lightUpdate()}orderedSeries(){return this.orderedSources().filter(It)}onDestroyed(){return this._destroyed}grid(){return this._grid}attachPrimitive(e){this._primitives.push(new Ns(e))}detachPrimitive(e){this._primitives=this._primitives.filter(t=>t.primitive()!==e),e.detached&&e.detached(),this._model.lightUpdate()}primitives(){return this._primitives}primitiveHitTest(e,t){return this._primitives.map(i=>i.hitTest(e,t)).filter(i=>i!==null)}_recalculatePriceScaleImpl(e){const t=e.sourcesForAutoScale();if(t&&t.length>0&&!this._timeScale.isEmpty()){const i=this._timeScale.visibleStrictRange();i!==null&&e.recalculatePriceRange(i)}e.updateAllViews()}_insertDataSource(e,t,i){let r=this.priceScaleById(t);if(r===null&&(r=this._createPriceScale(t,this._model.options().overlayPriceScales)),this._dataSources.splice(i,0,e),!De(t)){const n=this._overlaySourcesByScaleId.get(t)||[];n.push(e),this._overlaySourcesByScaleId.set(t,n)}e.setZorder(i),r.addDataSource(e),e.setPriceScale(r),this.recalculatePriceScale(r),this._cachedOrderedSources=null}_onPriceScaleModeChanged(e,t,i){t.mode!==i.mode&&this._recalculatePriceScaleImpl(e)}_createPriceScale(e,t){const i={visible:!0,autoScale:!0,...F(t)},r=new ws(e,i,this._model.options().layout,this._model.options().localization,this._model.colorParser());return r.setHeight(this.height()),r}}function ir(s,e){return!e||s==="top"&&e!=="top"||s==="normal"&&e==="bottom"}function sr(s,e,t){var n;let i,r;for(const o of s){const a=((n=o.primitiveHitTest)==null?void 0:n.call(o,e,t))??[];for(const l of a)ir(l.zOrder,i==null?void 0:i.zOrder)&&(i=l,r=o)}return!i||!r?null:{hit:i,source:r}}function ye(s){return{source:s.source,object:{externalId:s.hit.externalId},cursorStyle:s.hit.cursorStyle}}function rr(s,e,t,i){for(const r of s){const n=r.renderer(i);if(n!==null&&n.hitTest){const o=n.hitTest(e,t);if(o!==null)return{view:r,object:o}}}return null}function nr(s){return s.paneViews!==void 0}function Ti(s,e,t){const i=[s,...s.orderedSources()],r=sr(i,e,t);if((r==null?void 0:r.hit.zOrder)==="top")return ye(r);for(const n of i){if(r&&r.source===n&&r.hit.zOrder!=="bottom"&&!r.hit.isBackground)return ye(r);if(nr(n)){const o=rr(n.paneViews(s),e,t,s);if(o!==null)return{source:n,view:o.view,object:o.object}}if(r&&r.source===n&&r.hit.zOrder!=="bottom"&&r.hit.isBackground)return ye(r)}return r!=null&&r.hit?ye(r):null}class or{constructor(e,t,i=50){this._actualSize=0,this._usageTick=1,this._oldestTick=1,this._cache=new Map,this._tick2Labels=new Map,this._format=e,this._horzScaleBehavior=t,this._maxSize=i}format(e){const t=e.time,i=this._horzScaleBehavior.cacheKey(t),r=this._cache.get(i);if(r!==void 0)return r.string;if(this._actualSize===this._maxSize){const o=this._tick2Labels.get(this._oldestTick);this._tick2Labels.delete(this._oldestTick),this._cache.delete(V(o)),this._oldestTick++,this._actualSize--}const n=this._format(e);return this._cache.set(i,{string:n,tick:this._usageTick}),this._tick2Labels.set(this._usageTick,i),this._actualSize++,this._usageTick++,n}}class pe{constructor(e,t){k(e<=t,"right should be >= left"),this._left=e,this._right=t}left(){return this._left}right(){return this._right}count(){return this._right-this._left+1}contains(e){return this._left<=e&&e<=this._right}equals(e){return this._left===e.left()&&this._right===e.right()}}function Wt(s,e){return s===null||e===null?s===e:s.equals(e)}class ar{constructor(){this._marksByWeight=new Map,this._cache=null,this._uniformDistribution=!1}setUniformDistribution(e){this._uniformDistribution=e,this._cache=null}setTimeScalePoints(e,t){this._removeMarksSinceIndex(t),this._cache=null;for(let i=t;i<e.length;++i){const r=e[i];let n=this._marksByWeight.get(r.timeWeight);n===void 0&&(n=[],this._marksByWeight.set(r.timeWeight,n)),n.push({index:i,time:r.time,weight:r.timeWeight,originalTime:r.originalTime})}}build(e,t,i,r,n){const o=Math.ceil(t/e);return(this._cache===null||this._cache.maxIndexesPerMark!==o||n!==this._cache.indicesWithDataId||i!==this._cache.checkIndicesForData)&&(this._cache={indicesWithDataId:n,checkIndicesForData:i,marks:this._buildMarksImpl(o,i,r),maxIndexesPerMark:o}),this._cache.marks}_removeMarksSinceIndex(e){if(e===0){this._marksByWeight.clear();return}const t=[];this._marksByWeight.forEach((i,r)=>{e<=i[0].index?t.push(r):i.splice(re(i,e,n=>n.index<e),1/0)});for(const i of t)this._marksByWeight.delete(i)}_buildMarksImpl(e,t,i){let r=[];const n=o=>!t||i.has(o.index);for(const o of Array.from(this._marksByWeight.keys()).sort((a,l)=>l-a)){if(!this._marksByWeight.get(o))continue;const a=r;r=[];const l=a.length;let h=0;const c=V(this._marksByWeight.get(o)),d=c.length;let u=1/0,_=-1/0;for(let p=0;p<d;p++){const f=c[p],g=f.index;for(;h<l;){const S=a[h],v=S.index;if(v<g&&n(S))h++,r.push(S),_=v,u=1/0;else{u=v;break}}if(u-g>=e&&g-_>=e&&n(f))r.push(f),_=g;else if(this._uniformDistribution)return a}for(;h<l;h++)n(a[h])&&r.push(a[h])}return r}}class ie{constructor(e){this._logicalRange=e}strictRange(){return this._logicalRange===null?null:new pe(Math.floor(this._logicalRange.left()),Math.ceil(this._logicalRange.right()))}logicalRange(){return this._logicalRange}static invalid(){return new ie(null)}}const Ft=8;function lr(s,e){return s.weight>e.weight?s:e}class hr{constructor(e,t,i,r){this._width=0,this._baseIndexOrNull=null,this._points=[],this._scrollStartPoint=null,this._scaleStartPoint=null,this._tickMarks=new ar,this._formattedByWeight=new Map,this._visibleRange=ie.invalid(),this._visibleRangeInvalidated=!0,this._visibleBarsChanged=new T,this._logicalRangeChanged=new T,this._optionsApplied=new T,this._commonTransitionStartState=null,this._timeMarksCache=null,this._indicesWithData=new Map,this._indicesWithDataUpdateId=-1,this._labels=[],this._options=t,this._localizationOptions=i,this._rightOffset=t.rightOffset,this._barSpacing=t.barSpacing,this._model=e,this._horzScaleBehavior=r,this._updateDateTimeFormatter(),this._tickMarks.setUniformDistribution(t.uniformDistribution),this.recalculateIndicesWithData()}options(){return this._options}applyLocalizationOptions(e){A(this._localizationOptions,e),this._invalidateTickMarks(),this._updateDateTimeFormatter()}applyOptions(e,t){A(this._options,e),this._options.fixLeftEdge&&this._doFixLeftEdge(),this._options.fixRightEdge&&this._doFixRightEdge(),e.barSpacing!==void 0&&this._model.setBarSpacing(e.barSpacing),e.rightOffset!==void 0&&this._model.setRightOffset(e.rightOffset),(e.minBarSpacing!==void 0||e.maxBarSpacing!==void 0)&&this._model.setBarSpacing(e.barSpacing??this._barSpacing),e.ignoreWhitespaceIndices!==void 0&&e.ignoreWhitespaceIndices!==this._options.ignoreWhitespaceIndices&&this.recalculateIndicesWithData(),this._invalidateTickMarks(),this._updateDateTimeFormatter(),this._optionsApplied.fire()}indexToTime(e){var t;return((t=this._points[e])==null?void 0:t.time)??null}indexToTimeScalePoint(e){return this._points[e]??null}timeToIndex(e,t){if(this._points.length<1)return null;if(this._horzScaleBehavior.key(e)>this._horzScaleBehavior.key(this._points[this._points.length-1].time))return t?this._points.length-1:null;const i=re(this._points,this._horzScaleBehavior.key(e),(r,n)=>this._horzScaleBehavior.key(r.time)<n);return this._horzScaleBehavior.key(e)<this._horzScaleBehavior.key(this._points[i].time)?t?i:null:i}isEmpty(){return this._width===0||this._points.length===0||this._baseIndexOrNull===null}hasPoints(){return this._points.length>0}visibleStrictRange(){return this._updateVisibleRange(),this._visibleRange.strictRange()}visibleLogicalRange(){return this._updateVisibleRange(),this._visibleRange.logicalRange()}visibleTimeRange(){const e=this.visibleStrictRange();if(e===null)return null;const t={from:e.left(),to:e.right()};return this.timeRangeForLogicalRange(t)}timeRangeForLogicalRange(e){const t=Math.round(e.from),i=Math.round(e.to),r=m(this._firstIndex()),n=m(this._lastIndex());return{from:m(this.indexToTimeScalePoint(Math.max(r,t))),to:m(this.indexToTimeScalePoint(Math.min(n,i)))}}logicalRangeForTimeRange(e){return{from:m(this.timeToIndex(e.from,!0)),to:m(this.timeToIndex(e.to,!0))}}width(){return this._width}setWidth(e){if(!isFinite(e)||e<=0||this._width===e)return;const t=this.visibleLogicalRange(),i=this._width;if(this._width=e,this._visibleRangeInvalidated=!0,this._options.lockVisibleTimeRangeOnResize&&i!==0){const r=this._barSpacing*e/i;this._barSpacing=r}if(this._options.fixLeftEdge&&t!==null&&t.left()<=0){const r=i-e;this._rightOffset-=Math.round(r/this._barSpacing)+1,this._visibleRangeInvalidated=!0}this._correctBarSpacing(),this._correctOffset()}indexToCoordinate(e){if(this.isEmpty()||!me(e))return 0;const i=this.baseIndex()+this._rightOffset-e;return this._width-(i+.5)*this._barSpacing-1}indexesToCoordinates(e,t){const i=this.baseIndex(),r=t===void 0?0:t.from,n=t===void 0?e.length:t.to;for(let o=r;o<n;o++){const a=e[o].time,l=i+this._rightOffset-a,h=this._width-(l+.5)*this._barSpacing-1;e[o].x=h}}coordinateToIndex(e,t){const i=Math.ceil(this._coordinateToFloatIndex(e));return!t||!this._options.ignoreWhitespaceIndices||this._shouldConsiderIndex(i)?i:this._findNearestIndexWithData(i)}setRightOffset(e){this._visibleRangeInvalidated=!0,this._rightOffset=e,this._correctOffset(),this._model.recalculateAllPanes(),this._model.lightUpdate()}barSpacing(){return this._barSpacing}setBarSpacing(e){this._setBarSpacing(e),this._correctOffset(),this._model.recalculateAllPanes(),this._model.lightUpdate()}rightOffset(){return this._rightOffset}marks(){if(this.isEmpty())return null;if(this._timeMarksCache!==null)return this._timeMarksCache;const e=this._barSpacing,n=(this._model.options().layout.fontSize+4)*5/Ft*(this._options.tickMarkMaxCharacterLength||Ft),o=Math.round(n/e),a=m(this.visibleStrictRange()),l=Math.max(a.left(),a.left()-o),h=Math.max(a.right(),a.right()-o),c=this._tickMarks.build(e,n,this._options.ignoreWhitespaceIndices,this._indicesWithData,this._indicesWithDataUpdateId),d=this._firstIndex()+o,u=this._lastIndex()-o,_=this._isAllScalingAndScrollingDisabled(),p=this._options.fixLeftEdge||_,f=this._options.fixRightEdge||_;let g=0;for(const S of c){if(!(l<=S.index&&S.index<=h))continue;let v;g<this._labels.length?(v=this._labels[g],v.coord=this.indexToCoordinate(S.index),v.label=this._formatLabel(S),v.weight=S.weight):(v={needAlignCoordinate:!1,coord:this.indexToCoordinate(S.index),label:this._formatLabel(S),weight:S.weight},this._labels.push(v)),this._barSpacing>n/2&&!_?v.needAlignCoordinate=!1:v.needAlignCoordinate=p&&S.index<=d||f&&S.index>=u,g++}return this._labels.length=g,this._timeMarksCache=this._labels,this._labels}restoreDefault(){this._visibleRangeInvalidated=!0,this.setBarSpacing(this._options.barSpacing),this.setRightOffset(this._options.rightOffset)}setBaseIndex(e){this._visibleRangeInvalidated=!0,this._baseIndexOrNull=e,this._correctOffset(),this._doFixLeftEdge()}zoom(e,t){const i=this._coordinateToFloatIndex(e),r=this.barSpacing(),n=r+t*(r/10);this.setBarSpacing(n),this._options.rightBarStaysOnScroll||this.setRightOffset(this.rightOffset()+(i-this._coordinateToFloatIndex(e)))}startScale(e){this._scrollStartPoint&&this.endScroll(),!(this._scaleStartPoint!==null||this._commonTransitionStartState!==null)&&(this.isEmpty()||(this._scaleStartPoint=e,this._saveCommonTransitionsStartState()))}scaleTo(e){if(this._commonTransitionStartState===null)return;const t=te(this._width-e,0,this._width),i=te(this._width-m(this._scaleStartPoint),0,this._width);t===0||i===0||this.setBarSpacing(this._commonTransitionStartState.barSpacing*t/i)}endScale(){this._scaleStartPoint!==null&&(this._scaleStartPoint=null,this._clearCommonTransitionsStartState())}startScroll(e){this._scrollStartPoint!==null||this._commonTransitionStartState!==null||this.isEmpty()||(this._scrollStartPoint=e,this._saveCommonTransitionsStartState())}scrollTo(e){if(this._scrollStartPoint===null)return;const t=(this._scrollStartPoint-e)/this.barSpacing();this._rightOffset=m(this._commonTransitionStartState).rightOffset+t,this._visibleRangeInvalidated=!0,this._correctOffset()}endScroll(){this._scrollStartPoint!==null&&(this._scrollStartPoint=null,this._clearCommonTransitionsStartState())}scrollToRealTime(){this.scrollToOffsetAnimated(this._options.rightOffset)}scrollToOffsetAnimated(e,t=400){if(!isFinite(e))throw new RangeError("offset is required and must be finite number");if(!isFinite(t)||t<=0)throw new RangeError("animationDuration (optional) must be finite positive number");const i=this._rightOffset,r=performance.now();this._model.setTimeScaleAnimation({finished:n=>(n-r)/t>=1,getPosition:n=>{const o=(n-r)/t;return o>=1?e:i+(e-i)*o}})}update(e,t){this._visibleRangeInvalidated=!0,this._points=e,this._tickMarks.setTimeScalePoints(e,t),this._correctOffset()}visibleBarsChanged(){return this._visibleBarsChanged}logicalRangeChanged(){return this._logicalRangeChanged}optionsApplied(){return this._optionsApplied}baseIndex(){return this._baseIndexOrNull||0}setVisibleRange(e){const t=e.count();this._setBarSpacing(this._width/t),this._rightOffset=e.right()-this.baseIndex(),this._correctOffset(),this._visibleRangeInvalidated=!0,this._model.recalculateAllPanes(),this._model.lightUpdate()}fitContent(){const e=this._firstIndex(),t=this._lastIndex();e===null||t===null||this.setVisibleRange(new pe(e,t+this._options.rightOffset))}setLogicalRange(e){const t=new pe(e.from,e.to);this.setVisibleRange(t)}formatDateTime(e){return this._localizationOptions.timeFormatter!==void 0?this._localizationOptions.timeFormatter(e.originalTime):this._horzScaleBehavior.formatHorzItem(e.time)}recalculateIndicesWithData(){if(!this._options.ignoreWhitespaceIndices)return;this._indicesWithData.clear();const e=this._model.serieses();for(const t of e)for(const i of t.fulfilledIndices())this._indicesWithData.set(i,!0);this._indicesWithDataUpdateId++}_isAllScalingAndScrollingDisabled(){const e=this._model.options().handleScroll,t=this._model.options().handleScale;return!e.horzTouchDrag&&!e.mouseWheel&&!e.pressedMouseMove&&!e.vertTouchDrag&&!t.axisDoubleClickReset.time&&!t.axisPressedMouseMove.time&&!t.mouseWheel&&!t.pinch}_firstIndex(){return this._points.length===0?null:0}_lastIndex(){return this._points.length===0?null:this._points.length-1}_rightOffsetForCoordinate(e){return(this._width-1-e)/this._barSpacing}_coordinateToFloatIndex(e){const t=this._rightOffsetForCoordinate(e),r=this.baseIndex()+this._rightOffset-t;return Math.round(r*1e6)/1e6}_setBarSpacing(e){const t=this._barSpacing;this._barSpacing=e,this._correctBarSpacing(),t!==this._barSpacing&&(this._visibleRangeInvalidated=!0,this._resetTimeMarksCache())}_updateVisibleRange(){if(!this._visibleRangeInvalidated)return;if(this._visibleRangeInvalidated=!1,this.isEmpty()){this._setVisibleRange(ie.invalid());return}const e=this.baseIndex(),t=this._width/this._barSpacing,i=this._rightOffset+e,r=i-t+1,n=new pe(r,i);this._setVisibleRange(new ie(n))}_correctBarSpacing(){const e=te(this._barSpacing,this._minBarSpacing(),this._maxBarSpacing());this._barSpacing!==e&&(this._barSpacing=e,this._visibleRangeInvalidated=!0)}_maxBarSpacing(){return this._options.maxBarSpacing>0?this._options.maxBarSpacing:this._width*.5}_minBarSpacing(){return this._options.fixLeftEdge&&this._options.fixRightEdge&&this._points.length!==0?this._width/this._points.length:this._options.minBarSpacing}_correctOffset(){const e=this._minRightOffset();e!==null&&this._rightOffset<e&&(this._rightOffset=e,this._visibleRangeInvalidated=!0);const t=this._maxRightOffset();this._rightOffset>t&&(this._rightOffset=t,this._visibleRangeInvalidated=!0)}_minRightOffset(){const e=this._firstIndex(),t=this._baseIndexOrNull;if(e===null||t===null)return null;const i=this._options.fixLeftEdge?this._width/this._barSpacing:Math.min(2,this._points.length);return e-t-1+i}_maxRightOffset(){return this._options.fixRightEdge?0:this._width/this._barSpacing-Math.min(2,this._points.length)}_saveCommonTransitionsStartState(){this._commonTransitionStartState={barSpacing:this.barSpacing(),rightOffset:this.rightOffset()}}_clearCommonTransitionsStartState(){this._commonTransitionStartState=null}_formatLabel(e){let t=this._formattedByWeight.get(e.weight);return t===void 0&&(t=new or(i=>this._formatLabelImpl(i),this._horzScaleBehavior),this._formattedByWeight.set(e.weight,t)),t.format(e)}_formatLabelImpl(e){return this._horzScaleBehavior.formatTickmark(e,this._localizationOptions)}_setVisibleRange(e){const t=this._visibleRange;this._visibleRange=e,Wt(t.strictRange(),this._visibleRange.strictRange())||this._visibleBarsChanged.fire(),Wt(t.logicalRange(),this._visibleRange.logicalRange())||this._logicalRangeChanged.fire(),this._resetTimeMarksCache()}_resetTimeMarksCache(){this._timeMarksCache=null}_invalidateTickMarks(){this._resetTimeMarksCache(),this._formattedByWeight.clear()}_updateDateTimeFormatter(){this._horzScaleBehavior.updateFormatter(this._localizationOptions)}_doFixLeftEdge(){if(!this._options.fixLeftEdge)return;const e=this._firstIndex();if(e===null)return;const t=this.visibleStrictRange();if(t===null)return;const i=t.left()-e;if(i<0){const r=this._rightOffset-i-1;this.setRightOffset(r)}this._correctBarSpacing()}_doFixRightEdge(){this._correctOffset(),this._correctBarSpacing()}_shouldConsiderIndex(e){return this._options.ignoreWhitespaceIndices?this._indicesWithData.get(e)||!1:!0}_findNearestIndexWithData(e){const t=cr(e),i=this._lastIndex();for(;i;){const r=t.next().value;if(this._indicesWithData.get(r))return r;if(r<0||r>i)break}return e}}function*cr(s){const e=Math.round(s),t=e<s;let i=1;for(;;)t?(yield e+i,yield e-i):(yield e-i,yield e+i),i++}var ft=(s=>(s[s.OnTouchEnd=0]="OnTouchEnd",s[s.OnNextTap=1]="OnNextTap",s))(ft||{});function dr(s){return s instanceof xi}class ur{constructor(e,t,i){this._panes=[],this._serieses=[],this._width=0,this._hoveredSource=null,this._priceScalesOptionsChanged=new T,this._crosshairMoved=new T,this._gradientColorsCache=null,this._invalidateHandler=e,this._options=t,this._horzScaleBehavior=i,this._colorParser=new qi(this._options.layout.colorParsers),this._rendererOptionsProvider=new $i(this),this._timeScale=new hr(this,t.timeScale,this._options.localization,i),this._crosshair=new ls(this,t.crosshair),this._magnet=new Qs(t.crosshair),t.addDefaultPane&&(this._getOrCreatePane(0),this._panes[0].setStretchFactor(yi*2)),this._backgroundTopColor=this._getBackgroundColor(0),this._backgroundBottomColor=this._getBackgroundColor(1)}fullUpdate(){this._invalidate(M.full())}lightUpdate(){this._invalidate(M.light())}cursorUpdate(){this._invalidate(new M(x.Cursor))}updateSource(e){const t=this._invalidationMaskForSource(e);this._invalidate(t)}hoveredSource(){return this._hoveredSource}setHoveredSource(e){var i,r,n,o;if(((i=this._hoveredSource)==null?void 0:i.source)===(e==null?void 0:e.source)&&((n=(r=this._hoveredSource)==null?void 0:r.object)==null?void 0:n.externalId)===((o=e==null?void 0:e.object)==null?void 0:o.externalId))return;const t=this._hoveredSource;this._hoveredSource=e,t!==null&&this.updateSource(t.source),e!==null&&e.source!==(t==null?void 0:t.source)&&this.updateSource(e.source)}options(){return this._options}applyOptions(e){A(this._options,e),this._panes.forEach(t=>t.applyScaleOptions(e)),e.timeScale!==void 0&&this._timeScale.applyOptions(e.timeScale),e.localization!==void 0&&this._timeScale.applyLocalizationOptions(e.localization),(e.leftPriceScale||e.rightPriceScale)&&this._priceScalesOptionsChanged.fire(),this._backgroundTopColor=this._getBackgroundColor(0),this._backgroundBottomColor=this._getBackgroundColor(1),this.fullUpdate()}applyPriceScaleOptions(e,t,i=0){const r=this._panes[i];if(r===void 0)return;if(e===L.Left){A(this._options,{leftPriceScale:t}),r.applyScaleOptions({leftPriceScale:t}),this._priceScalesOptionsChanged.fire(),this.fullUpdate();return}else if(e===L.Right){A(this._options,{rightPriceScale:t}),r.applyScaleOptions({rightPriceScale:t}),this._priceScalesOptionsChanged.fire(),this.fullUpdate();return}const n=this.findPriceScale(e,i);n!==null&&(n.priceScale.applyOptions(t),this._priceScalesOptionsChanged.fire())}findPriceScale(e,t){const i=this._panes[t];if(i===void 0)return null;const r=i.priceScaleById(e);return r!==null?{pane:i,priceScale:r}:null}timeScale(){return this._timeScale}panes(){return this._panes}crosshairSource(){return this._crosshair}crosshairMoved(){return this._crosshairMoved}setPaneHeight(e,t){e.setHeight(t),this.recalculateAllPanes()}setWidth(e){this._width=e,this._timeScale.setWidth(this._width),this._panes.forEach(t=>t.setWidth(e)),this.recalculateAllPanes()}removePane(e){this._panes.length!==1&&(k(e>=0&&e<this._panes.length,"Invalid pane index"),this._panes.splice(e,1),this.fullUpdate())}changePanesHeight(e,t){if(this._panes.length<2)return;k(e>=0&&e<this._panes.length,"Invalid pane index");const i=this._panes[e],r=this._panes.reduce((d,u)=>d+u.stretchFactor(),0),n=this._panes.reduce((d,u)=>d+u.height(),0),o=n-Ot*(this._panes.length-1);t=Math.min(o,Math.max(Ot,t));const a=r/n,l=i.height();i.setStretchFactor(t*a);let h=t-l,c=this._panes.length-1;for(const d of this._panes)if(d!==i){const u=Math.min(o,Math.max(30,d.height()-h/c));h-=d.height()-u,c-=1;const _=u*a;d.setStretchFactor(_)}this.fullUpdate()}swapPanes(e,t){k(e>=0&&e<this._panes.length&&t>=0&&t<this._panes.length,"Invalid pane index");const i=this._panes[e],r=this._panes[t];this._panes[e]=r,this._panes[t]=i,this.fullUpdate()}movePane(e,t){if(k(e>=0&&e<this._panes.length&&t>=0&&t<this._panes.length,"Invalid pane index"),e===t)return;const[i]=this._panes.splice(e,1);this._panes.splice(t,0,i),this.fullUpdate()}startScalePrice(e,t,i){e.startScalePrice(t,i)}scalePriceTo(e,t,i){e.scalePriceTo(t,i),this.updateCrosshair(),this._invalidate(this._paneInvalidationMask(e,x.Light))}endScalePrice(e,t){e.endScalePrice(t),this._invalidate(this._paneInvalidationMask(e,x.Light))}startScrollPrice(e,t,i){t.isAutoScale()||e.startScrollPrice(t,i)}scrollPriceTo(e,t,i){t.isAutoScale()||(e.scrollPriceTo(t,i),this.updateCrosshair(),this._invalidate(this._paneInvalidationMask(e,x.Light)))}endScrollPrice(e,t){t.isAutoScale()||(e.endScrollPrice(t),this._invalidate(this._paneInvalidationMask(e,x.Light)))}resetPriceScale(e,t){e.resetPriceScale(t),this._invalidate(this._paneInvalidationMask(e,x.Light))}startScaleTime(e){this._timeScale.startScale(e)}zoomTime(e,t){const i=this.timeScale();if(i.isEmpty()||t===0)return;const r=i.width();e=Math.max(1,Math.min(e,r)),i.zoom(e,t),this.recalculateAllPanes()}scrollChart(e){this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime()}scaleTimeTo(e){this._timeScale.scaleTo(e),this.recalculateAllPanes()}endScaleTime(){this._timeScale.endScale(),this.lightUpdate()}startScrollTime(e){this._timeScale.startScroll(e)}scrollTimeTo(e){this._timeScale.scrollTo(e),this.recalculateAllPanes()}endScrollTime(){this._timeScale.endScroll(),this.lightUpdate()}serieses(){return this._serieses}setAndSaveCurrentPosition(e,t,i,r,n){this._crosshair.saveOriginCoord(e,t);let o=NaN,a=this._timeScale.coordinateToIndex(e,!0);const l=this._timeScale.visibleStrictRange();l!==null&&(a=Math.min(Math.max(l.left(),a),l.right()));const h=r.defaultPriceScale(),c=h.firstValue();if(c!==null&&(o=h.coordinateToPrice(t,c)),o=this._magnet.align(o,a,r),this._crosshair.setPosition(a,o,r),this.cursorUpdate(),!n){const d=Ti(r,e,t);this.setHoveredSource(d&&{source:d.source,object:d.object,cursorStyle:d.cursorStyle||null}),this._crosshairMoved.fire(this._crosshair.appliedIndex(),{x:e,y:t},i)}}setAndSaveSyntheticPosition(e,t,i){const r=i.defaultPriceScale(),n=r.firstValue(),o=r.priceToCoordinate(e,m(n)),a=this._timeScale.timeToIndex(t,!0),l=this._timeScale.indexToCoordinate(m(a));this.setAndSaveCurrentPosition(l,o,null,i,!0)}clearCurrentPosition(e){this.crosshairSource().clearPosition(),this.cursorUpdate(),e||this._crosshairMoved.fire(null,null,null)}updateCrosshair(){const e=this._crosshair.pane();if(e!==null){const t=this._crosshair.originCoordX(),i=this._crosshair.originCoordY();this.setAndSaveCurrentPosition(t,i,null,e)}this._crosshair.updateAllViews()}updateTimeScale(e,t,i){const r=this._timeScale.indexToTime(0);t!==void 0&&i!==void 0&&this._timeScale.update(t,i);const n=this._timeScale.indexToTime(0),o=this._timeScale.baseIndex(),a=this._timeScale.visibleStrictRange();if(a!==null&&r!==null&&n!==null){const l=a.contains(o),h=this._horzScaleBehavior.key(r)>this._horzScaleBehavior.key(n),d=e!==null&&e>o&&!h,u=this._timeScale.options().allowShiftVisibleRangeOnWhitespaceReplacement,p=l&&(!(i===void 0)||u)&&this._timeScale.options().shiftVisibleRangeOnNewBar;if(d&&!p){const f=e-o;this._timeScale.setRightOffset(this._timeScale.rightOffset()-f)}}this._timeScale.setBaseIndex(e)}recalculatePane(e){e!==null&&e.recalculate()}paneForSource(e){if(dr(e))return e;const t=this._panes.find(i=>i.orderedSources().includes(e));return t===void 0?null:t}recalculateAllPanes(){this._panes.forEach(e=>e.recalculate()),this.updateCrosshair()}destroy(){this._panes.forEach(e=>e.destroy()),this._panes.length=0,this._options.localization.priceFormatter=void 0,this._options.localization.percentageFormatter=void 0,this._options.localization.timeFormatter=void 0}rendererOptionsProvider(){return this._rendererOptionsProvider}priceAxisRendererOptions(){return this._rendererOptionsProvider.options()}priceScalesOptionsChanged(){return this._priceScalesOptionsChanged}addSeriesToPane(e,t){const i=this._getOrCreatePane(t);this._addSeriesToPane(e,i),this._serieses.push(e),this._serieses.length===1?this.fullUpdate():this.lightUpdate()}removeSeries(e){const t=this.paneForSource(e),i=this._serieses.indexOf(e);k(i!==-1,"Series not found");const r=m(t);this._serieses.splice(i,1),r.removeDataSource(e),e.destroy&&e.destroy(),this._timeScale.recalculateIndicesWithData(),this._cleanupIfPaneIsEmpty(r)}moveSeriesToScale(e,t){const i=m(this.paneForSource(e));i.removeDataSource(e,!0),i.addDataSource(e,t,!0)}fitContent(){const e=M.light();e.setFitContent(),this._invalidate(e)}setTargetLogicalRange(e){const t=M.light();t.applyRange(e),this._invalidate(t)}resetTimeScale(){const e=M.light();e.resetTimeScale(),this._invalidate(e)}setBarSpacing(e){const t=M.light();t.setBarSpacing(e),this._invalidate(t)}setRightOffset(e){const t=M.light();t.setRightOffset(e),this._invalidate(t)}setTimeScaleAnimation(e){const t=M.light();t.setTimeScaleAnimation(e),this._invalidate(t)}stopTimeScaleAnimation(){const e=M.light();e.stopTimeScaleAnimation(),this._invalidate(e)}defaultVisiblePriceScaleId(){return this._options.rightPriceScale.visible?L.Right:L.Left}moveSeriesToPane(e,t){k(t>=0,"Index should be greater or equal to 0");const i=this._seriesPaneIndex(e);if(t===i)return;const r=m(this.paneForSource(e));r.removeDataSource(e);const n=this._getOrCreatePane(t);this._addSeriesToPane(e,n),r.dataSources().length===0&&this._cleanupIfPaneIsEmpty(r),this.fullUpdate()}backgroundBottomColor(){return this._backgroundBottomColor}backgroundTopColor(){return this._backgroundTopColor}backgroundColorAtYPercentFromTop(e){const t=this._backgroundBottomColor,i=this._backgroundTopColor;if(t===i)return t;if(e=Math.max(0,Math.min(100,Math.round(e*100))),this._gradientColorsCache===null||this._gradientColorsCache.topColor!==i||this._gradientColorsCache.bottomColor!==t)this._gradientColorsCache={topColor:i,bottomColor:t,colors:new Map};else{const n=this._gradientColorsCache.colors.get(e);if(n!==void 0)return n}const r=this._colorParser.gradientColorAtPercent(i,t,e/100);return this._gradientColorsCache.colors.set(e,r),r}getPaneIndex(e){return this._panes.indexOf(e)}colorParser(){return this._colorParser}addPane(){return this._addPane()}_addPane(e){const t=new xi(this._timeScale,this);this._panes.push(t);const i=e??this._panes.length-1,r=M.full();return r.invalidatePane(i,{level:x.None,autoScale:!0}),this._invalidate(r),t}_getOrCreatePane(e){return k(e>=0,"Index should be greater or equal to 0"),e=Math.min(this._panes.length,e),e<this._panes.length?this._panes[e]:this._addPane(e)}_seriesPaneIndex(e){return this._panes.findIndex(t=>t.series().includes(e))}_paneInvalidationMask(e,t){const i=new M(t);if(e!==null){const r=this._panes.indexOf(e);i.invalidatePane(r,{level:t})}return i}_invalidationMaskForSource(e,t){return t===void 0&&(t=x.Light),this._paneInvalidationMask(this.paneForSource(e),t)}_invalidate(e){this._invalidateHandler&&this._invalidateHandler(e),this._panes.forEach(t=>t.grid().paneView().update())}_addSeriesToPane(e,t){const i=e.options().priceScaleId,r=i!==void 0?i:this.defaultVisiblePriceScaleId();t.addDataSource(e,r),De(r)||e.applyOptions(e.options())}_getBackgroundColor(e){const t=this._options.layout;return t.background.type===pt.VerticalGradient?e===0?t.background.topColor:t.background.bottomColor:t.background.color}_cleanupIfPaneIsEmpty(e){!e.preserveEmptyPane()&&e.dataSources().length===0&&this._panes.length>1&&this._panes.splice(this.getPaneIndex(e),1)}}function gt(s){return!se(s)&&!Se(s)}function Mi(s){return se(s)}var R=(s=>(s[s.Year=0]="Year",s[s.Month=1]="Month",s[s.DayOfMonth=2]="DayOfMonth",s[s.Time=3]="Time",s[s.TimeWithSeconds=4]="TimeWithSeconds",s))(R||{}),b=(s=>(s[s.LessThanSecond=0]="LessThanSecond",s[s.Second=10]="Second",s[s.Minute1=20]="Minute1",s[s.Minute5=21]="Minute5",s[s.Minute30=22]="Minute30",s[s.Hour1=30]="Hour1",s[s.Hour3=31]="Hour3",s[s.Hour6=32]="Hour6",s[s.Hour12=33]="Hour12",s[s.Day=50]="Day",s[s.Month=60]="Month",s[s.Year=70]="Year",s))(b||{});const _r=s=>s.getUTCMonth()+1,pr=s=>s.getUTCDate(),ki=s=>s.getUTCFullYear(),mr=s=>H(pr(s),2),fr=(s,e)=>new Date(s.getUTCFullYear(),s.getUTCMonth(),1).toLocaleString(e,{month:"long"}),gr=(s,e)=>new Date(s.getUTCFullYear(),s.getUTCMonth(),1).toLocaleString(e,{month:"short"}),Sr=s=>H(_r(s),2),vr=s=>H(ki(s)%100,2),br=s=>H(ki(s),4);function Cr(s,e,t){return e.replace(/yyyy/g,br(s)).replace(/yy/g,vr(s)).replace(/MMMM/g,fr(s,t)).replace(/MMM/g,gr(s,t)).replace(/MM/g,Sr(s)).replace(/dd/g,mr(s))}class Bi{constructor(e="yyyy-MM-dd",t="default"){this._dateFormat=e,this._locale=t}format(e){return Cr(e,this._dateFormat,this._locale)}}class Pr{constructor(e){this._formatStr=e||"%h:%m:%s"}format(e){return this._formatStr.replace("%h",H(e.getUTCHours(),2)).replace("%m",H(e.getUTCMinutes(),2)).replace("%s",H(e.getUTCSeconds(),2))}}const wr={dateFormat:"yyyy-MM-dd",timeFormat:"%h:%m:%s",dateTimeSeparator:" ",locale:"default"};class yr{constructor(e={}){const t={...wr,...e};this._dateFormatter=new Bi(t.dateFormat,t.locale),this._timeFormatter=new Pr(t.timeFormat),this._separator=t.dateTimeSeparator}format(e){return`${this._dateFormatter.format(e)}${this._separator}${this._timeFormatter.format(e)}`}}function xr(s,e,t){const i={};switch(e){case R.Year:i.year="numeric";break;case R.Month:i.month="short";break;case R.DayOfMonth:i.day="numeric";break;case R.Time:i.hour12=!1,i.hour="2-digit",i.minute="2-digit";break;case R.TimeWithSeconds:i.hour12=!1,i.hour="2-digit",i.minute="2-digit",i.second="2-digit";break}const r=s.businessDay===void 0?new Date(s.timestamp*1e3):new Date(Date.UTC(s.businessDay.year,s.businessDay.month-1,s.businessDay.day));return new Date(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds()).toLocaleString(t,i)}function xe(s){return s*60*60*1e3}function qe(s){return s*60*1e3}function Tr(s){return s*1e3}const Te=[{divisor:Tr(1),weight:b.Second},{divisor:qe(1),weight:b.Minute1},{divisor:qe(5),weight:b.Minute5},{divisor:qe(30),weight:b.Minute30},{divisor:xe(1),weight:b.Hour1},{divisor:xe(3),weight:b.Hour3},{divisor:xe(6),weight:b.Hour6},{divisor:xe(12),weight:b.Hour12}];function Ht(s,e){if(s.getUTCFullYear()!==e.getUTCFullYear())return b.Year;if(s.getUTCMonth()!==e.getUTCMonth())return b.Month;if(s.getUTCDate()!==e.getUTCDate())return b.Day;for(let t=Te.length-1;t>=0;--t)if(Math.floor(e.getTime()/Te[t].divisor)!==Math.floor(s.getTime()/Te[t].divisor))return Te[t].weight;return b.LessThanSecond}function Mr(s,e=0){if(s.length===0)return;let t=e===0?null:s[e-1].time.timestamp,i=t!==null?new Date(t*1e3):null,r=0;for(let n=e;n<s.length;++n){const o=s[n],a=new Date(o.time.timestamp*1e3);i!==null&&(o.timeWeight=Ht(a,i)),r+=o.time.timestamp-(t||o.time.timestamp),t=o.time.timestamp,i=a}if(e===0&&s.length>1){const n=Math.ceil(r/(s.length-1)),o=new Date((s[0].time.timestamp-n)*1e3);s[0].timeWeight=Ht(new Date(s[0].time.timestamp*1e3),o)}}function at(s){let e=s;if(Se(s)&&(e=St(s)),!gt(e))throw new Error("time must be of type BusinessDay");const t=new Date(Date.UTC(e.year,e.month-1,e.day,0,0,0,0));return{timestamp:Math.round(t.getTime()/1e3),businessDay:e}}function Ei(s){if(!Mi(s))throw new Error("time must be of type isUTCTimestamp");return{timestamp:s}}function kr(s){return s.length===0?null:gt(s[0].time)||Se(s[0].time)?at:Ei}function Br(s){return Mi(s)?Ei(s):gt(s)?at(s):at(St(s))}function St(s){const e=new Date(s);if(isNaN(e.getTime()))throw new Error(`Invalid date string=${s}, expected format=yyyy-mm-dd`);return{day:e.getUTCDate(),month:e.getUTCMonth()+1,year:e.getUTCFullYear()}}function Ri(s){Se(s.time)&&(s.time=St(s.time))}function Er(s){return s.forEach(Ri)}function Rr(s,e,t){switch(s){case b.LessThanSecond:case b.Second:return e?t?R.TimeWithSeconds:R.Time:R.DayOfMonth;case b.Minute1:case b.Minute5:case b.Minute30:case b.Hour1:case b.Hour3:case b.Hour6:case b.Hour12:return e?R.Time:R.DayOfMonth;case b.Day:return R.DayOfMonth;case b.Month:return R.Month;case b.Year:return R.Year}}class Nt{options(){return this._options}setOptions(e){this._options=e,this.updateFormatter(e.localization)}preprocessData(e){Array.isArray(e)?Er(e):Ri(e)}createConverterToInternalObj(e){return m(kr(e))}key(e){return typeof e=="object"&&"timestamp"in e?e.timestamp:this.key(this.convertHorzItemToInternal(e))}cacheKey(e){const t=e;return t.businessDay===void 0?new Date(t.timestamp*1e3).getTime():new Date(Date.UTC(t.businessDay.year,t.businessDay.month-1,t.businessDay.day)).getTime()}convertHorzItemToInternal(e){return Br(e)}updateFormatter(e){if(!this._options)return;const t=e.dateFormat;this._options.timeScale.timeVisible?this._dateTimeFormatter=new yr({dateFormat:t,timeFormat:this._options.timeScale.secondsVisible?"%h:%m:%s":"%h:%m",dateTimeSeparator:"   ",locale:e.locale}):this._dateTimeFormatter=new Bi(t,e.locale)}formatHorzItem(e){const t=e;return this._dateTimeFormatter.format(new Date(t.timestamp*1e3))}formatTickmark(e,t){const i=Rr(e.weight,this._options.timeScale.timeVisible,this._options.timeScale.secondsVisible),r=this._options.timeScale;if(r.tickMarkFormatter!==void 0){const n=r.tickMarkFormatter(e.originalTime,i,t.locale);if(n!==null)return n}return xr(e.time,i,t.locale)}maxTickMarkWeight(e){let t=e.reduce(lr,e[0]).weight;return t>b.Hour1&&t<b.Day&&(t=b.Hour1),t}fillWeightsForPoints(e,t){Mr(e,t)}static applyDefaults(e){return A({localization:{dateFormat:"dd MMM 'yy"}},e??{})}}function P(s){var e=s.width,t=s.height;if(e<0)throw new Error("Negative width is not allowed for Size");if(t<0)throw new Error("Negative height is not allowed for Size");return{width:e,height:t}}function $(s,e){return s.width===e.width&&s.height===e.height}var Vr=function(){function s(e){var t=this;this._resolutionListener=function(){return t._onResolutionChanged()},this._resolutionMediaQueryList=null,this._observers=[],this._window=e,this._installResolutionListener()}return s.prototype.dispose=function(){this._uninstallResolutionListener(),this._window=null},Object.defineProperty(s.prototype,"value",{get:function(){return this._window.devicePixelRatio},enumerable:!1,configurable:!0}),s.prototype.subscribe=function(e){var t=this,i={next:e};return this._observers.push(i),{unsubscribe:function(){t._observers=t._observers.filter(function(r){return r!==i})}}},s.prototype._installResolutionListener=function(){if(this._resolutionMediaQueryList!==null)throw new Error("Resolution listener is already installed");var e=this._window.devicePixelRatio;this._resolutionMediaQueryList=this._window.matchMedia("all and (resolution: ".concat(e,"dppx)")),this._resolutionMediaQueryList.addListener(this._resolutionListener)},s.prototype._uninstallResolutionListener=function(){this._resolutionMediaQueryList!==null&&(this._resolutionMediaQueryList.removeListener(this._resolutionListener),this._resolutionMediaQueryList=null)},s.prototype._reinstallResolutionListener=function(){this._uninstallResolutionListener(),this._installResolutionListener()},s.prototype._onResolutionChanged=function(){var e=this;this._observers.forEach(function(t){return t.next(e._window.devicePixelRatio)}),this._reinstallResolutionListener()},s}();function Ar(s){return new Vr(s)}var Lr=function(){function s(e,t,i){var r;this._canvasElement=null,this._bitmapSizeChangedListeners=[],this._suggestedBitmapSize=null,this._suggestedBitmapSizeChangedListeners=[],this._devicePixelRatioObservable=null,this._canvasElementResizeObserver=null,this._canvasElement=e,this._canvasElementClientSize=P({width:this._canvasElement.clientWidth,height:this._canvasElement.clientHeight}),this._transformBitmapSize=t??function(n){return n},this._allowResizeObserver=(r=i==null?void 0:i.allowResizeObserver)!==null&&r!==void 0?r:!0,this._chooseAndInitObserver()}return s.prototype.dispose=function(){var e,t;if(this._canvasElement===null)throw new Error("Object is disposed");(e=this._canvasElementResizeObserver)===null||e===void 0||e.disconnect(),this._canvasElementResizeObserver=null,(t=this._devicePixelRatioObservable)===null||t===void 0||t.dispose(),this._devicePixelRatioObservable=null,this._suggestedBitmapSizeChangedListeners.length=0,this._bitmapSizeChangedListeners.length=0,this._canvasElement=null},Object.defineProperty(s.prototype,"canvasElement",{get:function(){if(this._canvasElement===null)throw new Error("Object is disposed");return this._canvasElement},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"canvasElementClientSize",{get:function(){return this._canvasElementClientSize},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"bitmapSize",{get:function(){return P({width:this.canvasElement.width,height:this.canvasElement.height})},enumerable:!1,configurable:!0}),s.prototype.resizeCanvasElement=function(e){this._canvasElementClientSize=P(e),this.canvasElement.style.width="".concat(this._canvasElementClientSize.width,"px"),this.canvasElement.style.height="".concat(this._canvasElementClientSize.height,"px"),this._invalidateBitmapSize()},s.prototype.subscribeBitmapSizeChanged=function(e){this._bitmapSizeChangedListeners.push(e)},s.prototype.unsubscribeBitmapSizeChanged=function(e){this._bitmapSizeChangedListeners=this._bitmapSizeChangedListeners.filter(function(t){return t!==e})},Object.defineProperty(s.prototype,"suggestedBitmapSize",{get:function(){return this._suggestedBitmapSize},enumerable:!1,configurable:!0}),s.prototype.subscribeSuggestedBitmapSizeChanged=function(e){this._suggestedBitmapSizeChangedListeners.push(e)},s.prototype.unsubscribeSuggestedBitmapSizeChanged=function(e){this._suggestedBitmapSizeChangedListeners=this._suggestedBitmapSizeChangedListeners.filter(function(t){return t!==e})},s.prototype.applySuggestedBitmapSize=function(){if(this._suggestedBitmapSize!==null){var e=this._suggestedBitmapSize;this._suggestedBitmapSize=null,this._resizeBitmap(e),this._emitSuggestedBitmapSizeChanged(e,this._suggestedBitmapSize)}},s.prototype._resizeBitmap=function(e){var t=this.bitmapSize;$(t,e)||(this.canvasElement.width=e.width,this.canvasElement.height=e.height,this._emitBitmapSizeChanged(t,e))},s.prototype._emitBitmapSizeChanged=function(e,t){var i=this;this._bitmapSizeChangedListeners.forEach(function(r){return r.call(i,e,t)})},s.prototype._suggestNewBitmapSize=function(e){var t=this._suggestedBitmapSize,i=P(this._transformBitmapSize(e,this._canvasElementClientSize)),r=$(this.bitmapSize,i)?null:i;t===null&&r===null||t!==null&&r!==null&&$(t,r)||(this._suggestedBitmapSize=r,this._emitSuggestedBitmapSizeChanged(t,r))},s.prototype._emitSuggestedBitmapSizeChanged=function(e,t){var i=this;this._suggestedBitmapSizeChangedListeners.forEach(function(r){return r.call(i,e,t)})},s.prototype._chooseAndInitObserver=function(){var e=this;if(!this._allowResizeObserver){this._initDevicePixelRatioObservable();return}Dr().then(function(t){return t?e._initResizeObserver():e._initDevicePixelRatioObservable()})},s.prototype._initDevicePixelRatioObservable=function(){var e=this;if(this._canvasElement!==null){var t=Ut(this._canvasElement);if(t===null)throw new Error("No window is associated with the canvas");this._devicePixelRatioObservable=Ar(t),this._devicePixelRatioObservable.subscribe(function(){return e._invalidateBitmapSize()}),this._invalidateBitmapSize()}},s.prototype._invalidateBitmapSize=function(){var e,t;if(this._canvasElement!==null){var i=Ut(this._canvasElement);if(i!==null){var r=(t=(e=this._devicePixelRatioObservable)===null||e===void 0?void 0:e.value)!==null&&t!==void 0?t:i.devicePixelRatio,n=this._canvasElement.getClientRects(),o=n[0]!==void 0?Ir(n[0],r):P({width:this._canvasElementClientSize.width*r,height:this._canvasElementClientSize.height*r});this._suggestNewBitmapSize(o)}}},s.prototype._initResizeObserver=function(){var e=this;this._canvasElement!==null&&(this._canvasElementResizeObserver=new ResizeObserver(function(t){var i=t.find(function(o){return o.target===e._canvasElement});if(!(!i||!i.devicePixelContentBoxSize||!i.devicePixelContentBoxSize[0])){var r=i.devicePixelContentBoxSize[0],n=P({width:r.inlineSize,height:r.blockSize});e._suggestNewBitmapSize(n)}}),this._canvasElementResizeObserver.observe(this._canvasElement,{box:"device-pixel-content-box"}))},s}();function zr(s,e){return new Lr(s,e.transform,e.options)}function Ut(s){return s.ownerDocument.defaultView}function Dr(){return new Promise(function(s){var e=new ResizeObserver(function(t){s(t.every(function(i){return"devicePixelContentBoxSize"in i})),e.disconnect()});e.observe(document.body,{box:"device-pixel-content-box"})}).catch(function(){return!1})}function Ir(s,e){return P({width:Math.round(s.left*e+s.width*e)-Math.round(s.left*e),height:Math.round(s.top*e+s.height*e)-Math.round(s.top*e)})}var Or=function(){function s(e,t,i){if(t.width===0||t.height===0)throw new TypeError("Rendering target could only be created on a media with positive width and height");if(this._mediaSize=t,i.width===0||i.height===0)throw new TypeError("Rendering target could only be created using a bitmap with positive integer width and height");this._bitmapSize=i,this._context=e}return s.prototype.useMediaCoordinateSpace=function(e){try{return this._context.save(),this._context.setTransform(1,0,0,1,0,0),this._context.scale(this._horizontalPixelRatio,this._verticalPixelRatio),e({context:this._context,mediaSize:this._mediaSize})}finally{this._context.restore()}},s.prototype.useBitmapCoordinateSpace=function(e){try{return this._context.save(),this._context.setTransform(1,0,0,1,0,0),e({context:this._context,mediaSize:this._mediaSize,bitmapSize:this._bitmapSize,horizontalPixelRatio:this._horizontalPixelRatio,verticalPixelRatio:this._verticalPixelRatio})}finally{this._context.restore()}},Object.defineProperty(s.prototype,"_horizontalPixelRatio",{get:function(){return this._bitmapSize.width/this._mediaSize.width},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"_verticalPixelRatio",{get:function(){return this._bitmapSize.height/this._mediaSize.height},enumerable:!1,configurable:!0}),s}();function K(s,e){var t=s.canvasElementClientSize;if(t.width===0||t.height===0)return null;var i=s.bitmapSize;if(i.width===0||i.height===0)return null;var r=s.canvasElement.getContext("2d",e);return r===null?null:new Or(r,t,i)}const ne=typeof window<"u";function Yt(){return ne?window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1:!1}function Ze(){return ne?/iPhone|iPad|iPod/.test(window.navigator.platform):!1}function Wr(){return ne?window.chrome!==void 0:!1}function Fr(){var s;return ne?(s=navigator==null?void 0:navigator.userAgentData)!=null&&s.platform?navigator.userAgentData.platform==="Windows":navigator.userAgent.toLowerCase().indexOf("win")>=0:!1}function Hr(){return!ne||!navigator.userAgentData?!1:navigator.userAgentData.brands.some(s=>s.brand.includes("Chromium"))}function Nr(s){const e=Math.floor(s.width),t=Math.floor(s.height),i=e-e%2,r=t-t%2;return P({width:i,height:r})}function Ur(s){return s+s%2}function lt(s){return s+s%2}function Yr(s){Wr()&&s.addEventListener("mousedown",e=>{if(e.button===MouseEventButton.Middle)return e.preventDefault(),!1})}class We{constructor(e,t,i){this._clickCount=0,this._clickTimeoutId=null,this._clickPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY},this._tapCount=0,this._tapTimeoutId=null,this._tapPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY},this._longTapTimeoutId=null,this._longTapActive=!1,this._mouseMoveStartPosition=null,this._touchMoveStartPosition=null,this._touchMoveExceededManhattanDistance=!1,this._cancelClick=!1,this._cancelTap=!1,this._unsubscribeOutsideMouseEvents=null,this._unsubscribeOutsideTouchEvents=null,this._unsubscribeMobileSafariEvents=null,this._unsubscribeMousemove=null,this._unsubscribeRootMouseEvents=null,this._unsubscribeRootTouchEvents=null,this._startPinchMiddlePoint=null,this._startPinchDistance=0,this._pinchPrevented=!1,this._preventTouchDragProcess=!1,this._mousePressed=!1,this._lastTouchEventTimeStamp=0,this._activeTouchId=null,this._acceptMouseLeave=!Ze(),this._onFirefoxOutsideMouseUp=r=>{this._mouseUpHandler(r)},this._onMobileSafariDoubleClick=r=>{if(this._firesTouchEvents(r)){const n=this._makeCompatEvent(r);if(++this._tapCount,this._tapTimeoutId&&this._tapCount>1){const{manhattanDistance:o}=this._touchMouseMoveWithDownInfo(D(r),this._tapPosition);o<30&&!this._cancelTap&&this._processTouchEvent(n,this._handler.doubleTapEvent),this._resetTapTimeout()}}else{const n=this._makeCompatEvent(r);if(++this._clickCount,this._clickTimeoutId&&this._clickCount>1){const{manhattanDistance:o}=this._touchMouseMoveWithDownInfo(D(r),this._clickPosition);o<5&&!this._cancelClick&&this._processMouseEvent(n,this._handler.mouseDoubleClickEvent),this._resetClickTimeout()}}},this._target=e,this._handler=t,this._options=i,this._init()}destroy(){this._unsubscribeOutsideMouseEvents!==null&&(this._unsubscribeOutsideMouseEvents(),this._unsubscribeOutsideMouseEvents=null),this._unsubscribeOutsideTouchEvents!==null&&(this._unsubscribeOutsideTouchEvents(),this._unsubscribeOutsideTouchEvents=null),this._unsubscribeMousemove!==null&&(this._unsubscribeMousemove(),this._unsubscribeMousemove=null),this._unsubscribeRootMouseEvents!==null&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null),this._unsubscribeRootTouchEvents!==null&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null),this._unsubscribeMobileSafariEvents!==null&&(this._unsubscribeMobileSafariEvents(),this._unsubscribeMobileSafariEvents=null),this._clearLongTapTimeout(),this._resetClickTimeout()}_mouseEnterHandler(e){this._unsubscribeMousemove&&this._unsubscribeMousemove();const t=this._mouseMoveHandler.bind(this);if(this._unsubscribeMousemove=()=>{this._target.removeEventListener("mousemove",t)},this._target.addEventListener("mousemove",t),this._firesTouchEvents(e))return;const i=this._makeCompatEvent(e);this._processMouseEvent(i,this._handler.mouseEnterEvent),this._acceptMouseLeave=!0}_resetClickTimeout(){this._clickTimeoutId!==null&&clearTimeout(this._clickTimeoutId),this._clickCount=0,this._clickTimeoutId=null,this._clickPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY}}_resetTapTimeout(){this._tapTimeoutId!==null&&clearTimeout(this._tapTimeoutId),this._tapCount=0,this._tapTimeoutId=null,this._tapPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY}}_mouseMoveHandler(e){if(this._mousePressed||this._touchMoveStartPosition!==null||this._firesTouchEvents(e))return;const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.mouseMoveEvent),this._acceptMouseLeave=!0}_touchMoveHandler(e){const t=Qe(e.changedTouches,m(this._activeTouchId));if(t===null||(this._lastTouchEventTimeStamp=Me(e),this._startPinchMiddlePoint!==null)||this._preventTouchDragProcess)return;this._pinchPrevented=!0;const i=this._touchMouseMoveWithDownInfo(D(t),m(this._touchMoveStartPosition)),{xOffset:r,yOffset:n,manhattanDistance:o}=i;if(!(!this._touchMoveExceededManhattanDistance&&o<5)){if(!this._touchMoveExceededManhattanDistance){const a=r*.5,l=n>=a&&!this._options.treatVertTouchDragAsPageScroll(),h=a>n&&!this._options.treatHorzTouchDragAsPageScroll();!l&&!h&&(this._preventTouchDragProcess=!0),this._touchMoveExceededManhattanDistance=!0,this._cancelTap=!0,this._clearLongTapTimeout(),this._resetTapTimeout()}if(!this._preventTouchDragProcess){const a=this._makeCompatEvent(e,t);this._processTouchEvent(a,this._handler.touchMoveEvent),J(e)}}}_mouseMoveWithDownHandler(e){if(e.button!==MouseEventButton.Left)return;const t=this._touchMouseMoveWithDownInfo(D(e),m(this._mouseMoveStartPosition)),{manhattanDistance:i}=t;if(i>=5&&(this._cancelClick=!0,this._resetClickTimeout()),this._cancelClick){const r=this._makeCompatEvent(e);this._processMouseEvent(r,this._handler.pressedMouseMoveEvent)}}_touchMouseMoveWithDownInfo(e,t){const i=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y),n=i+r;return{xOffset:i,yOffset:r,manhattanDistance:n}}_touchEndHandler(e){let t=Qe(e.changedTouches,m(this._activeTouchId));if(t===null&&e.touches.length===0&&(t=e.changedTouches[0]),t===null)return;this._activeTouchId=null,this._lastTouchEventTimeStamp=Me(e),this._clearLongTapTimeout(),this._touchMoveStartPosition=null,this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null);const i=this._makeCompatEvent(e,t);if(this._processTouchEvent(i,this._handler.touchEndEvent),++this._tapCount,this._tapTimeoutId&&this._tapCount>1){const{manhattanDistance:r}=this._touchMouseMoveWithDownInfo(D(t),this._tapPosition);r<30&&!this._cancelTap&&this._processTouchEvent(i,this._handler.doubleTapEvent),this._resetTapTimeout()}else this._cancelTap||(this._processTouchEvent(i,this._handler.tapEvent),this._handler.tapEvent&&J(e));this._tapCount===0&&J(e),e.touches.length===0&&this._longTapActive&&(this._longTapActive=!1,J(e))}_mouseUpHandler(e){if(e.button!==MouseEventButton.Left)return;const t=this._makeCompatEvent(e);if(this._mouseMoveStartPosition=null,this._mousePressed=!1,this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null),Yt()&&this._target.ownerDocument.documentElement.removeEventListener("mouseleave",this._onFirefoxOutsideMouseUp),!this._firesTouchEvents(e))if(this._processMouseEvent(t,this._handler.mouseUpEvent),++this._clickCount,this._clickTimeoutId&&this._clickCount>1){const{manhattanDistance:i}=this._touchMouseMoveWithDownInfo(D(e),this._clickPosition);i<5&&!this._cancelClick&&this._processMouseEvent(t,this._handler.mouseDoubleClickEvent),this._resetClickTimeout()}else this._cancelClick||this._processMouseEvent(t,this._handler.mouseClickEvent)}_clearLongTapTimeout(){this._longTapTimeoutId!==null&&(clearTimeout(this._longTapTimeoutId),this._longTapTimeoutId=null)}_touchStartHandler(e){if(this._activeTouchId!==null)return;const t=e.changedTouches[0];this._activeTouchId=t.identifier,this._lastTouchEventTimeStamp=Me(e);const i=this._target.ownerDocument.documentElement;this._cancelTap=!1,this._touchMoveExceededManhattanDistance=!1,this._preventTouchDragProcess=!1,this._touchMoveStartPosition=D(t),this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null);{const n=this._touchMoveHandler.bind(this),o=this._touchEndHandler.bind(this);this._unsubscribeRootTouchEvents=()=>{i.removeEventListener("touchmove",n),i.removeEventListener("touchend",o)},i.addEventListener("touchmove",n,{passive:!1}),i.addEventListener("touchend",o,{passive:!1}),this._clearLongTapTimeout(),this._longTapTimeoutId=setTimeout(this._longTapHandler.bind(this,e),240)}const r=this._makeCompatEvent(e,t);this._processTouchEvent(r,this._handler.touchStartEvent),this._tapTimeoutId||(this._tapCount=0,this._tapTimeoutId=setTimeout(this._resetTapTimeout.bind(this),500),this._tapPosition=D(t))}_mouseDownHandler(e){if(e.button!==MouseEventButton.Left)return;const t=this._target.ownerDocument.documentElement;Yt()&&t.addEventListener("mouseleave",this._onFirefoxOutsideMouseUp),this._cancelClick=!1,this._mouseMoveStartPosition=D(e),this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null);{const r=this._mouseMoveWithDownHandler.bind(this),n=this._mouseUpHandler.bind(this);this._unsubscribeRootMouseEvents=()=>{t.removeEventListener("mousemove",r),t.removeEventListener("mouseup",n)},t.addEventListener("mousemove",r),t.addEventListener("mouseup",n)}if(this._mousePressed=!0,this._firesTouchEvents(e))return;const i=this._makeCompatEvent(e);this._processMouseEvent(i,this._handler.mouseDownEvent),this._clickTimeoutId||(this._clickCount=0,this._clickTimeoutId=setTimeout(this._resetClickTimeout.bind(this),500),this._clickPosition=D(e))}_init(){this._target.addEventListener("mouseenter",this._mouseEnterHandler.bind(this)),this._target.addEventListener("touchcancel",this._clearLongTapTimeout.bind(this));{const e=this._target.ownerDocument,t=i=>{this._handler.mouseDownOutsideEvent&&(i.composed&&this._target.contains(i.composedPath()[0])||i.target&&this._target.contains(i.target)||this._handler.mouseDownOutsideEvent())};this._unsubscribeOutsideTouchEvents=()=>{e.removeEventListener("touchstart",t)},this._unsubscribeOutsideMouseEvents=()=>{e.removeEventListener("mousedown",t)},e.addEventListener("mousedown",t),e.addEventListener("touchstart",t,{passive:!0})}Ze()&&(this._unsubscribeMobileSafariEvents=()=>{this._target.removeEventListener("dblclick",this._onMobileSafariDoubleClick)},this._target.addEventListener("dblclick",this._onMobileSafariDoubleClick)),this._target.addEventListener("mouseleave",this._mouseLeaveHandler.bind(this)),this._target.addEventListener("touchstart",this._touchStartHandler.bind(this),{passive:!0}),Yr(this._target),this._target.addEventListener("mousedown",this._mouseDownHandler.bind(this)),this._initPinch(),this._target.addEventListener("touchmove",()=>{},{passive:!1})}_initPinch(){this._handler.pinchStartEvent===void 0&&this._handler.pinchEvent===void 0&&this._handler.pinchEndEvent===void 0||(this._target.addEventListener("touchstart",e=>this._checkPinchState(e.touches),{passive:!0}),this._target.addEventListener("touchmove",e=>{if(!(e.touches.length!==2||this._startPinchMiddlePoint===null)&&this._handler.pinchEvent!==void 0){const i=Xt(e.touches[0],e.touches[1])/this._startPinchDistance;this._handler.pinchEvent(this._startPinchMiddlePoint,i),J(e)}},{passive:!1}),this._target.addEventListener("touchend",e=>{this._checkPinchState(e.touches)}))}_checkPinchState(e){e.length===1&&(this._pinchPrevented=!1),e.length!==2||this._pinchPrevented||this._longTapActive?this._stopPinch():this._startPinch(e)}_startPinch(e){const t=Xr(this._target);this._startPinchMiddlePoint={x:(e[0].clientX-t.left+(e[1].clientX-t.left))/2,y:(e[0].clientY-t.top+(e[1].clientY-t.top))/2},this._startPinchDistance=Xt(e[0],e[1]),this._handler.pinchStartEvent!==void 0&&this._handler.pinchStartEvent(),this._clearLongTapTimeout()}_stopPinch(){this._startPinchMiddlePoint!==null&&(this._startPinchMiddlePoint=null,this._handler.pinchEndEvent!==void 0&&this._handler.pinchEndEvent())}_mouseLeaveHandler(e){if(this._unsubscribeMousemove&&this._unsubscribeMousemove(),this._firesTouchEvents(e)||!this._acceptMouseLeave)return;const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.mouseLeaveEvent),this._acceptMouseLeave=!Ze()}_longTapHandler(e){const t=Qe(e.touches,m(this._activeTouchId));if(t===null)return;const i=this._makeCompatEvent(e,t);this._processTouchEvent(i,this._handler.longTapEvent),this._cancelTap=!0,this._longTapActive=!0}_firesTouchEvents(e){return e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents!==void 0?e.sourceCapabilities.firesTouchEvents:Me(e)<this._lastTouchEventTimeStamp+500}_processTouchEvent(e,t){t&&t.call(this._handler,e)}_processMouseEvent(e,t){t&&t.call(this._handler,e)}_makeCompatEvent(e,t){const i=t||e,r=this._target.getBoundingClientRect()||{left:0,top:0};return{clientX:i.clientX,clientY:i.clientY,pageX:i.pageX,pageY:i.pageY,screenX:i.screenX,screenY:i.screenY,localX:i.clientX-r.left,localY:i.clientY-r.top,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,metaKey:e.metaKey,isTouch:!e.type.startsWith("mouse")&&e.type!=="contextmenu"&&e.type!=="click",srcType:e.type,target:i.target,view:e.view,preventDefault:()=>{e.type!=="touchstart"&&J(e)}}}}function Xr(s){return s.getBoundingClientRect()||{left:0,top:0}}function Xt(s,e){const t=s.clientX-e.clientX,i=s.clientY-e.clientY;return Math.sqrt(t*t+i*i)}function J(s){s.cancelable&&s.preventDefault()}function D(s){return{x:s.pageX,y:s.pageY}}function Me(s){return s.timeStamp||performance.now()}function Qe(s,e){for(let t=0;t<s.length;++t)if(s[t].identifier===e)return s[t];return null}var Vi=(s=>(s[s.SeparatorHeight=1]="SeparatorHeight",s[s.MinPaneHeight=30]="MinPaneHeight",s))(Vi||{});class Gr{constructor(e,t,i){this._handle=null,this._mouseEventHandler=null,this._resizeEnabled=!0,this._resizeInfo=null,this._chartWidget=e,this._topPane=e.paneWidgets()[t],this._bottomPane=e.paneWidgets()[i],this._rowElement=document.createElement("tr"),this._rowElement.style.height="1px",this._cell=document.createElement("td"),this._cell.style.position="relative",this._cell.style.padding="0",this._cell.style.margin="0",this._cell.setAttribute("colspan","3"),this._updateBorderColor(),this._rowElement.appendChild(this._cell),this._resizeEnabled=this._chartWidget.options().layout.panes.enableResize,this._resizeEnabled?this._addResizableHandle():(this._handle=null,this._mouseEventHandler=null)}destroy(){this._mouseEventHandler!==null&&this._mouseEventHandler.destroy()}getElement(){return this._rowElement}getSize(){return P({width:this._topPane.getSize().width,height:1})}getBitmapSize(){return P({width:this._topPane.getBitmapSize().width,height:1*window.devicePixelRatio})}drawBitmap(e,t,i){const r=this.getBitmapSize();e.fillStyle=this._chartWidget.options().layout.panes.separatorColor,e.fillRect(t,i,r.width,r.height)}update(){this._updateBorderColor(),this._chartWidget.options().layout.panes.enableResize!==this._resizeEnabled&&(this._resizeEnabled=this._chartWidget.options().layout.panes.enableResize,this._resizeEnabled?this._addResizableHandle():(this._handle!==null&&(this._cell.removeChild(this._handle.backgroundElement),this._cell.removeChild(this._handle.element),this._handle=null),this._mouseEventHandler!==null&&(this._mouseEventHandler.destroy(),this._mouseEventHandler=null)))}_addResizableHandle(){const e=document.createElement("div"),t=e.style;t.position="fixed",t.display="none",t.zIndex="49",t.top="0",t.left="0",t.width="100%",t.height="100%",t.cursor="row-resize",this._cell.appendChild(e);const i=document.createElement("div"),r=i.style;r.position="absolute",r.zIndex="50",r.top="-4px",r.height="9px",r.width="100%",r.backgroundColor="",r.cursor="row-resize",this._cell.appendChild(i);const n={mouseEnterEvent:this._mouseOverEvent.bind(this),mouseLeaveEvent:this._mouseLeaveEvent.bind(this),mouseDownEvent:this._mouseDownEvent.bind(this),touchStartEvent:this._mouseDownEvent.bind(this),pressedMouseMoveEvent:this._pressedMouseMoveEvent.bind(this),touchMoveEvent:this._pressedMouseMoveEvent.bind(this),mouseUpEvent:this._mouseUpEvent.bind(this),touchEndEvent:this._mouseUpEvent.bind(this)};this._mouseEventHandler=new We(i,n,{treatVertTouchDragAsPageScroll:()=>!1,treatHorzTouchDragAsPageScroll:()=>!0}),this._handle={element:i,backgroundElement:e}}_updateBorderColor(){this._cell.style.background=this._chartWidget.options().layout.panes.separatorColor}_mouseOverEvent(e){this._handle!==null&&(this._handle.element.style.backgroundColor=this._chartWidget.options().layout.panes.separatorHoverColor)}_mouseLeaveEvent(e){this._handle!==null&&this._resizeInfo===null&&(this._handle.element.style.backgroundColor="")}_mouseDownEvent(e){if(this._handle===null)return;const t=this._topPane.state().stretchFactor()+this._bottomPane.state().stretchFactor(),i=this._topPane.getSize().height+this._bottomPane.getSize().height,r=t/i,n=30*r;t<=n*2||(this._resizeInfo={startY:e.pageY,prevStretchTopPane:this._topPane.state().stretchFactor(),maxPaneStretch:t-n,totalStretch:t,pixelStretchFactor:r,minPaneStretch:n},this._handle.backgroundElement.style.display="block")}_pressedMouseMoveEvent(e){const t=this._resizeInfo;if(t===null)return;const r=(e.pageY-t.startY)*t.pixelStretchFactor,n=te(t.prevStretchTopPane+r,t.minPaneStretch,t.maxPaneStretch);this._topPane.state().setStretchFactor(n),this._bottomPane.state().setStretchFactor(t.totalStretch-n),this._chartWidget.model().fullUpdate()}_mouseUpEvent(e){this._resizeInfo===null||this._handle===null||(this._resizeInfo=null,this._handle.backgroundElement.style.display="none")}}function Je(s,e){return s.position-e.position}function et(s,e,t){const i=(s.position-e.position)/(s.time-e.time);return Math.sign(i)*Math.min(Math.abs(i),t)}function $r(s,e){const t=Math.log(e);return Math.log(1*t/-s)/t}class jr{constructor(e,t,i,r){this._position1=null,this._position2=null,this._position3=null,this._position4=null,this._animationStartPosition=null,this._durationMsecs=0,this._speedPxPerMsec=0,this._minSpeed=e,this._maxSpeed=t,this._dumpingCoeff=i,this._minMove=r}addPosition(e,t){if(this._position1!==null){if(this._position1.time===t){this._position1.position=e;return}if(Math.abs(this._position1.position-e)<this._minMove)return}this._position4=this._position3,this._position3=this._position2,this._position2=this._position1,this._position1={time:t,position:e}}start(e,t){if(this._position1===null||this._position2===null||t-this._position1.time>50)return;let i=0;const r=et(this._position1,this._position2,this._maxSpeed),n=Je(this._position1,this._position2),o=[r],a=[n];if(i+=n,this._position3!==null){const h=et(this._position2,this._position3,this._maxSpeed);if(Math.sign(h)===Math.sign(r)){const c=Je(this._position2,this._position3);if(o.push(h),a.push(c),i+=c,this._position4!==null){const d=et(this._position3,this._position4,this._maxSpeed);if(Math.sign(d)===Math.sign(r)){const u=Je(this._position3,this._position4);o.push(d),a.push(u),i+=u}}}}let l=0;for(let h=0;h<o.length;++h)l+=a[h]/i*o[h];Math.abs(l)<this._minSpeed||(this._animationStartPosition={position:e,time:t},this._speedPxPerMsec=l,this._durationMsecs=$r(Math.abs(l),this._dumpingCoeff))}getPosition(e){const t=m(this._animationStartPosition),i=e-t.time;return t.position+this._speedPxPerMsec*(Math.pow(this._dumpingCoeff,i)-1)/Math.log(this._dumpingCoeff)}finished(e){return this._animationStartPosition===null||this._progressDuration(e)===this._durationMsecs}_progressDuration(e){const t=m(this._animationStartPosition),i=e-t.time;return Math.min(i,this._durationMsecs)}}const Kr='<svg xmlns="http://www.w3.org/2000/svg" width="35" height="19" fill="none"><g fill-rule="evenodd" clip-path="url(#a)" clip-rule="evenodd"><path fill="var(--stroke)" d="M2 0H0v10h6v9h21.4l.5-1.3 6-15 1-2.7H23.7l-.5 1.3-.2.6a5 5 0 0 0-7-.9V0H2Zm20 17h4l5.2-13 .8-2h-7l-1 2.5-.2.5-1.5 3.8-.3.7V17Zm-.8-10a3 3 0 0 0 .7-2.7A3 3 0 1 0 16.8 7h4.4ZM14 7V2H2v6h6v9h4V7h2Z"/><path fill="var(--fill)" d="M14 2H2v6h6v9h6V2Zm12 15h-7l6-15h7l-6 15Zm-7-9a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></g><defs><clipPath id="a"><path fill="var(--stroke)" d="M0 0h35v19H0z"/></clipPath></defs></svg>',qr="a#tv-attr-logo{--fill:#131722;--stroke:#fff;position:absolute;left:10px;bottom:10px;height:19px;width:35px;margin:0;padding:0;border:0;z-index:3;}a#tv-attr-logo[data-dark]{--fill:#D1D4DC;--stroke:#131722;}";class Zr{constructor(e,t){this._element=void 0,this._cssElement=void 0,this._theme=void 0,this._visible=!1,this._container=e,this._chart=t,this._render()}update(){this._render()}removeElement(){this._element&&this._container.removeChild(this._element),this._cssElement&&this._container.removeChild(this._cssElement),this._element=void 0,this._cssElement=void 0}_shouldUpdate(){return this._visible!==this._shouldBeVisible()||this._theme!==this._themeToUse()}_themeToUse(){return this._chart.model().colorParser().colorStringToGrayscale(this._chart.options().layout.textColor)>160?"dark":"light"}_shouldBeVisible(){return this._chart.options().layout.attributionLogo}_getUTMSource(){const e=new URL(location.href);return e.hostname?"&utm_source="+e.hostname+e.pathname:""}_render(){this._shouldUpdate()&&(this.removeElement(),this._visible=this._shouldBeVisible(),this._visible&&(this._theme=this._themeToUse(),this._cssElement=document.createElement("style"),this._cssElement.innerText=qr,this._element=document.createElement("a"),this._element.href=`https://www.tradingview.com/?utm_medium=lwc-link&utm_campaign=lwc-chart${this._getUTMSource()}`,this._element.title="Charting by TradingView",this._element.id="tv-attr-logo",this._element.target="_blank",this._element.innerHTML=Kr,this._element.toggleAttribute("data-dark",this._theme==="dark"),this._container.appendChild(this._cssElement),this._container.appendChild(this._element)))}}function q(s,e){const i=m(s.ownerDocument).createElement("canvas");s.appendChild(i);const r=zr(i,{options:{allowResizeObserver:!0},transform:(n,o)=>({width:Math.max(n.width,o.width),height:Math.max(n.height,o.height)})});return r.resizeCanvasElement(e),r}function Z(s){var e;s.width=1,s.height=1,(e=s.getContext("2d"))==null||e.clearRect(0,0,1,1)}function ht(s,e,t,i){s.drawBackground&&s.drawBackground(e,t,i)}function ke(s,e,t,i){s.draw(e,t,i)}function ct(s,e,t,i){const r=s(t,i);for(const n of r){const o=n.renderer(i);o!==null&&e(o)}}function Qr(s){return s.priceScale!==void 0}function tt(s,e){return t=>{var r,n;return Qr(t)?(((r=t.priceScale())==null?void 0:r.id())??"")!==e?[]:((n=t.pricePaneViews)==null?void 0:n.call(t,s))??[]:[]}}function Gt(s,e,t,i){if(!s.length)return;let r=0;const n=s[0].height(i,!0);let o=e===1?t/2-(s[0].getFixedCoordinate()-n/2):s[0].getFixedCoordinate()-n/2-t/2;o=Math.max(0,o);for(let a=1;a<s.length;a++){const l=s[a],h=s[a-1],c=h.height(i,!1),d=l.getFixedCoordinate(),u=h.getFixedCoordinate();if(e===1?d>u-c:d<u+c){const p=u-c*e;l.setFixedCoordinate(p);const f=p-e*c/2;if((e===1?f<0:f>t)&&o>0){const S=e===1?-1-f:f-t,v=Math.min(S,o);for(let y=r;y<s.length;y++)s[y].setFixedCoordinate(s[y].getFixedCoordinate()+e*v);o-=v}}else r=a,o=e===1?u-c-d:d-(u+c)}}function Jr(s){return s.mode!==N.Hidden&&s.horzLine.visible&&s.horzLine.labelVisible}class $t{constructor(e,t,i,r){this._priceScale=null,this._size=null,this._mousedown=!1,this._widthCache=new Ee(200),this._font=null,this._prevOptimalWidth=0,this._isSettingSize=!1,this._canvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._pane.chart().model().lightUpdate()},this._topCanvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._pane.chart().model().lightUpdate()},this._pane=e,this._options=t,this._layoutOptions=t.layout,this._rendererOptionsProvider=i,this._isLeft=r==="left",this._sourcePaneViews=tt("normal",r),this._sourceTopPaneViews=tt("top",r),this._sourceBottomPaneViews=tt("bottom",r),this._cell=document.createElement("div"),this._cell.style.height="100%",this._cell.style.overflow="hidden",this._cell.style.width="25px",this._cell.style.left="0",this._cell.style.position="relative",this._canvasBinding=q(this._cell,P({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler);const n=this._canvasBinding.canvasElement;n.style.position="absolute",n.style.zIndex="1",n.style.left="0",n.style.top="0",this._topCanvasBinding=q(this._cell,P({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler);const o=this._topCanvasBinding.canvasElement;o.style.position="absolute",o.style.zIndex="2",o.style.left="0",o.style.top="0";const a={mouseDownEvent:this._mouseDownEvent.bind(this),touchStartEvent:this._mouseDownEvent.bind(this),pressedMouseMoveEvent:this._pressedMouseMoveEvent.bind(this),touchMoveEvent:this._pressedMouseMoveEvent.bind(this),mouseDownOutsideEvent:this._mouseDownOutsideEvent.bind(this),mouseUpEvent:this._mouseUpEvent.bind(this),touchEndEvent:this._mouseUpEvent.bind(this),mouseDoubleClickEvent:this._mouseDoubleClickEvent.bind(this),doubleTapEvent:this._mouseDoubleClickEvent.bind(this),mouseEnterEvent:this._mouseEnterEvent.bind(this),mouseLeaveEvent:this._mouseLeaveEvent.bind(this)};this._mouseEventHandler=new We(this._topCanvasBinding.canvasElement,a,{treatVertTouchDragAsPageScroll:()=>!this._options.handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:()=>!0})}destroy(){this._mouseEventHandler.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler),Z(this._topCanvasBinding.canvasElement),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Z(this._canvasBinding.canvasElement),this._canvasBinding.dispose(),this._priceScale!==null&&this._priceScale.onMarksChanged().unsubscribeAll(this),this._priceScale=null}getElement(){return this._cell}fontSize(){return this._layoutOptions.fontSize}rendererOptions(){const e=this._rendererOptionsProvider.options();return this._font!==e.font&&(this._widthCache.reset(),this._font=e.font),e}optimalWidth(){if(this._priceScale===null)return 0;let e=0;const t=this.rendererOptions(),i=m(this._canvasBinding.canvasElement.getContext("2d",{colorSpace:this._pane.chart().options().layout.colorSpace}));i.save();const r=this._priceScale.marks();i.font=this._baseFont(),r.length>0&&(e=Math.max(this._widthCache.measureText(i,r[0].label),this._widthCache.measureText(i,r[r.length-1].label)));const n=this._backLabels();for(let h=n.length;h--;){const c=this._widthCache.measureText(i,n[h].text());c>e&&(e=c)}const o=this._priceScale.firstValue();if(o!==null&&this._size!==null&&Jr(this._options.crosshair)){const h=this._priceScale.coordinateToPrice(1,o),c=this._priceScale.coordinateToPrice(this._size.height-2,o);e=Math.max(e,this._widthCache.measureText(i,this._priceScale.formatPrice(Math.floor(Math.min(h,c))+.11111111111111,o)),this._widthCache.measureText(i,this._priceScale.formatPrice(Math.ceil(Math.max(h,c))-.11111111111111,o)))}i.restore();const a=e||34,l=Math.ceil(t.borderSize+t.tickLength+t.paddingInner+t.paddingOuter+5+a);return lt(l)}setSize(e){(this._size===null||!$(this._size,e))&&(this._size=e,this._isSettingSize=!0,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._isSettingSize=!1,this._cell.style.width=`${e.width}px`,this._cell.style.height=`${e.height}px`)}getWidth(){return m(this._size).width}setPriceScale(e){this._priceScale!==e&&(this._priceScale!==null&&this._priceScale.onMarksChanged().unsubscribeAll(this),this._priceScale=e,e.onMarksChanged().subscribe(this._onMarksChanged.bind(this),this))}priceScale(){return this._priceScale}reset(){const e=this._pane.state();this._pane.chart().model().resetPriceScale(e,m(this.priceScale()))}paint(e){if(this._size===null)return;const t={colorSpace:this._pane.chart().options().layout.colorSpace};if(e!==x.Cursor){this._alignLabels(),this._canvasBinding.applySuggestedBitmapSize();const r=K(this._canvasBinding,t);r!==null&&(r.useBitmapCoordinateSpace(n=>{this._drawBackground(n),this._drawBorder(n)}),this._pane.drawAdditionalSources(r,this._sourceBottomPaneViews),this._drawTickMarks(r),this._pane.drawAdditionalSources(r,this._sourcePaneViews),this._drawBackLabels(r))}this._topCanvasBinding.applySuggestedBitmapSize();const i=K(this._topCanvasBinding,t);i!==null&&(i.useBitmapCoordinateSpace(({context:r,bitmapSize:n})=>{r.clearRect(0,0,n.width,n.height)}),this._drawCrosshairLabel(i),this._pane.drawAdditionalSources(i,this._sourceTopPaneViews))}getBitmapSize(){return this._canvasBinding.bitmapSize}drawBitmap(e,t,i){const r=this.getBitmapSize();r.width>0&&r.height>0&&e.drawImage(this._canvasBinding.canvasElement,t,i)}update(){var e;(e=this._priceScale)==null||e.marks()}_mouseDownEvent(e){if(this._priceScale===null||this._priceScale.isEmpty()||!this._options.handleScale.axisPressedMouseMove.price)return;const t=this._pane.chart().model(),i=this._pane.state();this._mousedown=!0,t.startScalePrice(i,this._priceScale,e.localY)}_pressedMouseMoveEvent(e){if(this._priceScale===null||!this._options.handleScale.axisPressedMouseMove.price)return;const t=this._pane.chart().model(),i=this._pane.state(),r=this._priceScale;t.scalePriceTo(i,r,e.localY)}_mouseDownOutsideEvent(){if(this._priceScale===null||!this._options.handleScale.axisPressedMouseMove.price)return;const e=this._pane.chart().model(),t=this._pane.state(),i=this._priceScale;this._mousedown&&(this._mousedown=!1,e.endScalePrice(t,i))}_mouseUpEvent(e){if(this._priceScale===null||!this._options.handleScale.axisPressedMouseMove.price)return;const t=this._pane.chart().model(),i=this._pane.state();this._mousedown=!1,t.endScalePrice(i,this._priceScale)}_mouseDoubleClickEvent(e){this._options.handleScale.axisDoubleClickReset.price&&this.reset()}_mouseEnterEvent(e){if(this._priceScale===null)return;this._pane.chart().model().options().handleScale.axisPressedMouseMove.price&&!this._priceScale.isPercentage()&&!this._priceScale.isIndexedTo100()&&this._setCursor(1)}_mouseLeaveEvent(e){this._setCursor(0)}_backLabels(){const e=[],t=this._priceScale===null?void 0:this._priceScale;return(r=>{for(let n=0;n<r.length;++n){const a=r[n].priceAxisViews(this._pane.state(),t);for(let l=0;l<a.length;l++)e.push(a[l])}})(this._pane.state().orderedSources()),e}_drawBackground({context:e,bitmapSize:t}){const{width:i,height:r}=t,n=this._pane.state().model(),o=n.backgroundTopColor(),a=n.backgroundBottomColor();o===a?Le(e,0,0,i,r,o):_i(e,0,0,i,r,o,a)}_drawBorder({context:e,bitmapSize:t,horizontalPixelRatio:i}){if(this._size===null||this._priceScale===null||!this._priceScale.options().borderVisible)return;e.fillStyle=this._priceScale.options().borderColor;const r=Math.max(1,Math.floor(this.rendererOptions().borderSize*i));let n;this._isLeft?n=t.width-r:n=0,e.fillRect(n,0,r,t.height)}_drawTickMarks(e){if(this._size===null||this._priceScale===null)return;const t=this._priceScale.marks(),i=this._priceScale.options(),r=this.rendererOptions(),n=this._isLeft?this._size.width-r.tickLength:0;i.borderVisible&&i.ticksVisible&&e.useBitmapCoordinateSpace(({context:o,horizontalPixelRatio:a,verticalPixelRatio:l})=>{o.fillStyle=i.borderColor;const h=Math.max(1,Math.floor(l)),c=Math.floor(l*.5),d=Math.round(r.tickLength*a);o.beginPath();for(const u of t)o.rect(Math.floor(n*a),Math.round(u.coord*l)-c,d,h);o.fill()}),e.useMediaCoordinateSpace(({context:o})=>{o.font=this._baseFont(),o.fillStyle=i.textColor??this._layoutOptions.textColor,o.textAlign=this._isLeft?"right":"left",o.textBaseline="middle";const a=this._isLeft?Math.round(n-r.paddingInner):Math.round(n+r.tickLength+r.paddingInner),l=t.map(h=>this._widthCache.yMidCorrection(o,h.label));for(let h=t.length;h--;){const c=t[h];o.fillText(c.label,a,c.coord+l[h])}})}_alignLabels(){if(this._size===null||this._priceScale===null)return;let e=this._size.height/2;const t=[],i=this._priceScale.orderedSources().slice(),n=this._pane.state(),o=this.rendererOptions();this._priceScale===n.defaultVisiblePriceScale()&&this._pane.state().orderedSources().forEach(u=>{n.isOverlay(u)&&i.push(u)});const l=this._priceScale.dataSources()[0],h=this._priceScale;(u=>{u.forEach(_=>{const p=_.priceAxisViews(n,h);p.forEach(f=>{f.setFixedCoordinate(null),f.isVisible()&&t.push(f)}),l===_&&p.length>0&&(e=p[0].coordinate())})})(i),t.forEach(u=>u.setFixedCoordinate(u.coordinate())),this._priceScale.options().alignLabels&&this._fixLabelOverlap(t,o,e)}_fixLabelOverlap(e,t,i){if(this._size===null)return;const r=e.filter(o=>o.coordinate()<=i),n=e.filter(o=>o.coordinate()>i);r.sort((o,a)=>a.coordinate()-o.coordinate()),r.length&&n.length&&n.push(r[0]),n.sort((o,a)=>o.coordinate()-a.coordinate());for(const o of e){const a=Math.floor(o.height(t)/2),l=o.coordinate();l>-a&&l<a&&o.setFixedCoordinate(a),l>this._size.height-a&&l<this._size.height+a&&o.setFixedCoordinate(this._size.height-a)}Gt(r,1,this._size.height,t),Gt(n,-1,this._size.height,t)}_drawBackLabels(e){if(this._size===null)return;const t=this._backLabels(),i=this.rendererOptions(),r=this._isLeft?"right":"left";t.forEach(n=>{n.isAxisLabelVisible()&&n.renderer(m(this._priceScale)).draw(e,i,this._widthCache,r)})}_drawCrosshairLabel(e){if(this._size===null||this._priceScale===null)return;const t=this._pane.chart().model(),i=[],r=this._pane.state(),n=t.crosshairSource().priceAxisViews(r,this._priceScale);n.length&&i.push(n);const o=this.rendererOptions(),a=this._isLeft?"right":"left";i.forEach(l=>{l.forEach(h=>{h.renderer(m(this._priceScale)).draw(e,o,this._widthCache,a)})})}_setCursor(e){this._cell.style.cursor=e===1?"ns-resize":"default"}_onMarksChanged(){const e=this.optimalWidth();this._prevOptimalWidth<e&&this._pane.chart().model().fullUpdate(),this._prevOptimalWidth=e}_baseFont(){return Be(this._layoutOptions.fontSize,this._layoutOptions.fontFamily)}}function en(s,e){var t;return((t=s.bottomPaneViews)==null?void 0:t.call(s,e))??[]}function jt(s,e){var t;return((t=s.paneViews)==null?void 0:t.call(s,e))??[]}function Kt(s,e){var t;return((t=s.labelPaneViews)==null?void 0:t.call(s,e))??[]}function tn(s,e){var t;return((t=s.topPaneViews)==null?void 0:t.call(s,e))??[]}class vt{constructor(e,t){this._size=P({width:0,height:0}),this._leftPriceAxisWidget=null,this._rightPriceAxisWidget=null,this._attributionLogoWidget=null,this._startScrollingPos=null,this._isScrolling=!1,this._clicked=new T,this._dblClicked=new T,this._prevPinchScale=0,this._longTap=!1,this._startTrackPoint=null,this._exitTrackingModeOnNextTry=!1,this._initCrosshairPosition=null,this._scrollXAnimation=null,this._isSettingSize=!1,this._canvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._state===null||this._model().lightUpdate()},this._topCanvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._state===null||this._model().lightUpdate()},this._chart=e,this._state=t,this._state.onDestroyed().subscribe(this._onStateDestroyed.bind(this),this,!0),this._paneCell=document.createElement("td"),this._paneCell.style.padding="0",this._paneCell.style.position="relative";const i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.style.position="relative",i.style.overflow="hidden",this._leftAxisCell=document.createElement("td"),this._leftAxisCell.style.padding="0",this._rightAxisCell=document.createElement("td"),this._rightAxisCell.style.padding="0",this._paneCell.appendChild(i),this._canvasBinding=q(i,P({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler);const r=this._canvasBinding.canvasElement;r.style.position="absolute",r.style.zIndex="1",r.style.left="0",r.style.top="0",this._topCanvasBinding=q(i,P({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler);const n=this._topCanvasBinding.canvasElement;n.style.position="absolute",n.style.zIndex="2",n.style.left="0",n.style.top="0",this._rowElement=document.createElement("tr"),this._rowElement.appendChild(this._leftAxisCell),this._rowElement.appendChild(this._paneCell),this._rowElement.appendChild(this._rightAxisCell),this.updatePriceAxisWidgetsStates(),this._mouseEventHandler=new We(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:()=>this._startTrackPoint===null&&!this._chart.options().handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:()=>this._startTrackPoint===null&&!this._chart.options().handleScroll.horzTouchDrag})}destroy(){this._leftPriceAxisWidget!==null&&this._leftPriceAxisWidget.destroy(),this._rightPriceAxisWidget!==null&&this._rightPriceAxisWidget.destroy(),this._attributionLogoWidget=null,this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler),Z(this._topCanvasBinding.canvasElement),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Z(this._canvasBinding.canvasElement),this._canvasBinding.dispose(),this._state!==null&&(this._state.onDestroyed().unsubscribeAll(this),this._state.destroy()),this._mouseEventHandler.destroy()}state(){return m(this._state)}setState(e){var t;this._state!==null&&this._state.onDestroyed().unsubscribeAll(this),this._state=e,this._state!==null&&this._state.onDestroyed().subscribe(vt.prototype._onStateDestroyed.bind(this),this,!0),this.updatePriceAxisWidgetsStates(),this._chart.paneWidgets().indexOf(this)===this._chart.paneWidgets().length-1?(this._attributionLogoWidget=this._attributionLogoWidget??new Zr(this._paneCell,this._chart),this._attributionLogoWidget.update()):((t=this._attributionLogoWidget)==null||t.removeElement(),this._attributionLogoWidget=null)}chart(){return this._chart}getElement(){return this._rowElement}updatePriceAxisWidgetsStates(){if(this._state!==null&&(this._recreatePriceAxisWidgets(),this._model().serieses().length!==0)){if(this._leftPriceAxisWidget!==null){const e=this._state.leftPriceScale();this._leftPriceAxisWidget.setPriceScale(m(e))}if(this._rightPriceAxisWidget!==null){const e=this._state.rightPriceScale();this._rightPriceAxisWidget.setPriceScale(m(e))}}}updatePriceAxisWidgets(){this._leftPriceAxisWidget!==null&&this._leftPriceAxisWidget.update(),this._rightPriceAxisWidget!==null&&this._rightPriceAxisWidget.update()}stretchFactor(){return this._state!==null?this._state.stretchFactor():0}setStretchFactor(e){this._state&&this._state.setStretchFactor(e)}mouseEnterEvent(e){if(!this._state)return;this._onMouseEvent();const t=e.localX,i=e.localY;this._setCrosshairPosition(t,i,e)}mouseDownEvent(e){this._onMouseEvent(),this._mouseTouchDownEvent(),this._setCrosshairPosition(e.localX,e.localY,e)}mouseMoveEvent(e){if(!this._state)return;this._onMouseEvent();const t=e.localX,i=e.localY;this._setCrosshairPosition(t,i,e)}mouseClickEvent(e){this._state!==null&&(this._onMouseEvent(),this._fireClickedDelegate(e))}mouseDoubleClickEvent(e){this._state!==null&&this._fireMouseClickDelegate(this._dblClicked,e)}doubleTapEvent(e){this.mouseDoubleClickEvent(e)}pressedMouseMoveEvent(e){this._onMouseEvent(),this._pressedMouseTouchMoveEvent(e),this._setCrosshairPosition(e.localX,e.localY,e)}mouseUpEvent(e){this._state!==null&&(this._onMouseEvent(),this._longTap=!1,this._endScroll(e))}tapEvent(e){this._state!==null&&this._fireClickedDelegate(e)}longTapEvent(e){if(this._longTap=!0,this._startTrackPoint===null){const t={x:e.localX,y:e.localY};this._startTrackingMode(t,t,e)}}mouseLeaveEvent(e){this._state!==null&&(this._onMouseEvent(),this._state.model().setHoveredSource(null),this._clearCrosshairPosition())}clicked(){return this._clicked}dblClicked(){return this._dblClicked}pinchStartEvent(){this._prevPinchScale=1,this._model().stopTimeScaleAnimation()}pinchEvent(e,t){if(!this._chart.options().handleScale.pinch)return;const i=(t-this._prevPinchScale)*5;this._prevPinchScale=t,this._model().zoomTime(e.x,i)}touchStartEvent(e){this._longTap=!1,this._exitTrackingModeOnNextTry=this._startTrackPoint!==null,this._mouseTouchDownEvent();const t=this._model().crosshairSource();this._startTrackPoint!==null&&t.visible()&&(this._initCrosshairPosition={x:t.appliedX(),y:t.appliedY()},this._startTrackPoint={x:e.localX,y:e.localY})}touchMoveEvent(e){if(this._state===null)return;const t=e.localX,i=e.localY;if(this._startTrackPoint!==null){this._exitTrackingModeOnNextTry=!1;const r=m(this._initCrosshairPosition),n=r.x+(t-this._startTrackPoint.x),o=r.y+(i-this._startTrackPoint.y);this._setCrosshairPosition(n,o,e);return}this._pressedMouseTouchMoveEvent(e)}touchEndEvent(e){this.chart().options().trackingMode.exitMode===ft.OnTouchEnd&&(this._exitTrackingModeOnNextTry=!0),this._tryExitTrackingMode(),this._endScroll(e)}hitTest(e,t){const i=this._state;return i===null?null:Ti(i,e,t)}setPriceAxisSize(e,t){const i=t==="left"?this._leftPriceAxisWidget:this._rightPriceAxisWidget;m(i).setSize(P({width:e,height:this._size.height}))}getSize(){return this._size}setSize(e){$(this._size,e)||(this._size=e,this._isSettingSize=!0,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._isSettingSize=!1,this._paneCell.style.width=e.width+"px",this._paneCell.style.height=e.height+"px")}recalculatePriceScales(){const e=m(this._state);e.recalculatePriceScale(e.leftPriceScale()),e.recalculatePriceScale(e.rightPriceScale());for(const t of e.dataSources())if(e.isOverlay(t)){const i=t.priceScale();i!==null&&e.recalculatePriceScale(i),t.updateAllViews()}for(const t of e.primitives())t.updateAllViews()}getBitmapSize(){return this._canvasBinding.bitmapSize}drawBitmap(e,t,i){const r=this.getBitmapSize();r.width>0&&r.height>0&&e.drawImage(this._canvasBinding.canvasElement,t,i)}paint(e){if(e===x.None||this._state===null)return;e>x.Cursor&&this.recalculatePriceScales(),this._leftPriceAxisWidget!==null&&this._leftPriceAxisWidget.paint(e),this._rightPriceAxisWidget!==null&&this._rightPriceAxisWidget.paint(e);const t={colorSpace:this._chart.options().layout.colorSpace};if(e!==x.Cursor){this._canvasBinding.applySuggestedBitmapSize();const r=K(this._canvasBinding,t);r!==null&&(r.useBitmapCoordinateSpace(n=>{this._drawBackground(n)}),this._state&&(this._drawSources(r,en),this._drawGrid(r),this._drawSources(r,jt),this._drawSources(r,Kt)))}this._topCanvasBinding.applySuggestedBitmapSize();const i=K(this._topCanvasBinding,t);i!==null&&(i.useBitmapCoordinateSpace(({context:r,bitmapSize:n})=>{r.clearRect(0,0,n.width,n.height)}),this._drawCrosshair(i),this._drawSources(i,tn),this._drawSources(i,Kt))}leftPriceAxisWidget(){return this._leftPriceAxisWidget}rightPriceAxisWidget(){return this._rightPriceAxisWidget}drawAdditionalSources(e,t){this._drawSources(e,t)}_onStateDestroyed(){this._state!==null&&this._state.onDestroyed().unsubscribeAll(this),this._state=null}_fireClickedDelegate(e){this._fireMouseClickDelegate(this._clicked,e)}_fireMouseClickDelegate(e,t){const i=t.localX,r=t.localY;e.hasListeners()&&e.fire(this._model().timeScale().coordinateToIndex(i),{x:i,y:r},t)}_drawBackground({context:e,bitmapSize:t}){const{width:i,height:r}=t,n=this._model(),o=n.backgroundTopColor(),a=n.backgroundBottomColor();o===a?Le(e,0,0,i,r,a):_i(e,0,0,i,r,o,a)}_drawGrid(e){const t=m(this._state),r=t.grid().paneView().renderer(t);r!==null&&r.draw(e,!1)}_drawCrosshair(e){this._drawSourceImpl(e,jt,ke,this._model().crosshairSource())}_drawSources(e,t){const i=m(this._state),r=i.orderedSources(),n=i.primitives();for(const o of n)this._drawSourceImpl(e,t,ht,o);for(const o of r)this._drawSourceImpl(e,t,ht,o);for(const o of n)this._drawSourceImpl(e,t,ke,o);for(const o of r)this._drawSourceImpl(e,t,ke,o)}_drawSourceImpl(e,t,i,r){const n=m(this._state),o=n.model().hoveredSource(),a=o!==null&&o.source===r,l=o!==null&&a&&o.object!==void 0?o.object.hitTestData:void 0;ct(t,c=>i(c,e,a,l),r,n)}_recreatePriceAxisWidgets(){if(this._state===null)return;const e=this._chart,t=this._state.leftPriceScale().options().visible,i=this._state.rightPriceScale().options().visible;!t&&this._leftPriceAxisWidget!==null&&(this._leftAxisCell.removeChild(this._leftPriceAxisWidget.getElement()),this._leftPriceAxisWidget.destroy(),this._leftPriceAxisWidget=null),!i&&this._rightPriceAxisWidget!==null&&(this._rightAxisCell.removeChild(this._rightPriceAxisWidget.getElement()),this._rightPriceAxisWidget.destroy(),this._rightPriceAxisWidget=null);const r=e.model().rendererOptionsProvider();t&&this._leftPriceAxisWidget===null&&(this._leftPriceAxisWidget=new $t(this,e.options(),r,"left"),this._leftAxisCell.appendChild(this._leftPriceAxisWidget.getElement())),i&&this._rightPriceAxisWidget===null&&(this._rightPriceAxisWidget=new $t(this,e.options(),r,"right"),this._rightAxisCell.appendChild(this._rightPriceAxisWidget.getElement()))}_preventScroll(e){return e.isTouch&&this._longTap||this._startTrackPoint!==null}_correctXCoord(e){return Math.max(0,Math.min(e,this._size.width-1))}_correctYCoord(e){return Math.max(0,Math.min(e,this._size.height-1))}_setCrosshairPosition(e,t,i){this._model().setAndSaveCurrentPosition(this._correctXCoord(e),this._correctYCoord(t),i,m(this._state))}_clearCrosshairPosition(){this._model().clearCurrentPosition()}_tryExitTrackingMode(){this._exitTrackingModeOnNextTry&&(this._startTrackPoint=null,this._clearCrosshairPosition())}_startTrackingMode(e,t,i){this._startTrackPoint=e,this._exitTrackingModeOnNextTry=!1,this._setCrosshairPosition(t.x,t.y,i);const r=this._model().crosshairSource();this._initCrosshairPosition={x:r.appliedX(),y:r.appliedY()}}_model(){return this._chart.model()}_endScroll(e){if(!this._isScrolling)return;const t=this._model(),i=this.state();if(t.endScrollPrice(i,i.defaultPriceScale()),this._startScrollingPos=null,this._isScrolling=!1,t.endScrollTime(),this._scrollXAnimation!==null){const r=performance.now(),n=t.timeScale();this._scrollXAnimation.start(n.rightOffset(),r),this._scrollXAnimation.finished(r)||t.setTimeScaleAnimation(this._scrollXAnimation)}}_onMouseEvent(){this._startTrackPoint=null}_mouseTouchDownEvent(){if(!this._state)return;if(this._model().stopTimeScaleAnimation(),document.activeElement!==document.body&&document.activeElement!==document.documentElement)m(document.activeElement).blur();else{const t=document.getSelection();t!==null&&t.removeAllRanges()}this._state.defaultPriceScale().isEmpty()||this._model().timeScale().isEmpty()}_pressedMouseTouchMoveEvent(e){if(this._state===null)return;const t=this._model(),i=t.timeScale();if(i.isEmpty())return;const r=this._chart.options(),n=r.handleScroll,o=r.kineticScroll;if((!n.pressedMouseMove||e.isTouch)&&(!n.horzTouchDrag&&!n.vertTouchDrag||!e.isTouch))return;const a=this._state.defaultPriceScale(),l=performance.now();if(this._startScrollingPos===null&&!this._preventScroll(e)&&(this._startScrollingPos={x:e.clientX,y:e.clientY,timestamp:l,localX:e.localX,localY:e.localY}),this._startScrollingPos!==null&&!this._isScrolling&&(this._startScrollingPos.x!==e.clientX||this._startScrollingPos.y!==e.clientY)){if(e.isTouch&&o.touch||!e.isTouch&&o.mouse){const h=i.barSpacing();this._scrollXAnimation=new jr(.2/h,7/h,.997,15/h),this._scrollXAnimation.addPosition(i.rightOffset(),this._startScrollingPos.timestamp)}else this._scrollXAnimation=null;a.isEmpty()||t.startScrollPrice(this._state,a,e.localY),t.startScrollTime(e.localX),this._isScrolling=!0}this._isScrolling&&(a.isEmpty()||t.scrollPriceTo(this._state,a,e.localY),t.scrollTimeTo(e.localX),this._scrollXAnimation!==null&&this._scrollXAnimation.addPosition(i.rightOffset(),l))}}class qt{constructor(e,t,i,r,n){this._invalidated=!0,this._size=P({width:0,height:0}),this._canvasSuggestedBitmapSizeChangedHandler=()=>this.paint(x.Full),this._isLeft=e==="left",this._rendererOptionsProvider=i.rendererOptionsProvider,this._options=t,this._borderVisible=r,this._bottomColor=n,this._cell=document.createElement("div"),this._cell.style.width="25px",this._cell.style.height="100%",this._cell.style.overflow="hidden",this._canvasBinding=q(this._cell,P({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler)}destroy(){this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Z(this._canvasBinding.canvasElement),this._canvasBinding.dispose()}getElement(){return this._cell}getSize(){return this._size}setSize(e){$(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._cell.style.width=`${e.width}px`,this._cell.style.height=`${e.height}px`,this._invalidated=!0)}paint(e){if(e<x.Full&&!this._invalidated||this._size.width===0||this._size.height===0)return;this._invalidated=!1,this._canvasBinding.applySuggestedBitmapSize();const t=K(this._canvasBinding,{colorSpace:this._options.layout.colorSpace});t!==null&&t.useBitmapCoordinateSpace(i=>{this._drawBackground(i),this._drawBorder(i)})}getBitmapSize(){return this._canvasBinding.bitmapSize}drawBitmap(e,t,i){const r=this.getBitmapSize();r.width>0&&r.height>0&&e.drawImage(this._canvasBinding.canvasElement,t,i)}_drawBorder({context:e,bitmapSize:t,horizontalPixelRatio:i,verticalPixelRatio:r}){if(!this._borderVisible())return;e.fillStyle=this._options.timeScale.borderColor;const n=Math.floor(this._rendererOptionsProvider.options().borderSize*i),o=Math.floor(this._rendererOptionsProvider.options().borderSize*r),a=this._isLeft?t.width-n:0;e.fillRect(a,0,n,o)}_drawBackground({context:e,bitmapSize:t}){Le(e,0,0,t.width,t.height,this._bottomColor())}}function bt(s){return e=>{var t;return((t=e.timePaneViews)==null?void 0:t.call(e,s))??[]}}const sn=bt("normal"),rn=bt("top"),nn=bt("bottom");class on{constructor(e,t){this._leftStub=null,this._rightStub=null,this._rendererOptions=null,this._mouseDown=!1,this._size=P({width:0,height:0}),this._sizeChanged=new T,this._widthCache=new Ee(5),this._isSettingSize=!1,this._canvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._chart.model().lightUpdate()},this._topCanvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._chart.model().lightUpdate()},this._chart=e,this._horzScaleBehavior=t,this._options=e.options().layout,this._element=document.createElement("tr"),this._leftStubCell=document.createElement("td"),this._leftStubCell.style.padding="0",this._rightStubCell=document.createElement("td"),this._rightStubCell.style.padding="0",this._cell=document.createElement("td"),this._cell.style.height="25px",this._cell.style.padding="0",this._dv=document.createElement("div"),this._dv.style.width="100%",this._dv.style.height="100%",this._dv.style.position="relative",this._dv.style.overflow="hidden",this._cell.appendChild(this._dv),this._canvasBinding=q(this._dv,P({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler);const i=this._canvasBinding.canvasElement;i.style.position="absolute",i.style.zIndex="1",i.style.left="0",i.style.top="0",this._topCanvasBinding=q(this._dv,P({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler);const r=this._topCanvasBinding.canvasElement;r.style.position="absolute",r.style.zIndex="2",r.style.left="0",r.style.top="0",this._element.appendChild(this._leftStubCell),this._element.appendChild(this._cell),this._element.appendChild(this._rightStubCell),this._recreateStubs(),this._chart.model().priceScalesOptionsChanged().subscribe(this._recreateStubs.bind(this),this),this._mouseEventHandler=new We(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:()=>!0,treatHorzTouchDragAsPageScroll:()=>!this._chart.options().handleScroll.horzTouchDrag})}destroy(){this._mouseEventHandler.destroy(),this._leftStub!==null&&this._leftStub.destroy(),this._rightStub!==null&&this._rightStub.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler),Z(this._topCanvasBinding.canvasElement),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Z(this._canvasBinding.canvasElement),this._canvasBinding.dispose()}getElement(){return this._element}leftStub(){return this._leftStub}rightStub(){return this._rightStub}mouseDownEvent(e){if(this._mouseDown)return;this._mouseDown=!0;const t=this._chart.model();t.timeScale().isEmpty()||!this._chart.options().handleScale.axisPressedMouseMove.time||t.startScaleTime(e.localX)}touchStartEvent(e){this.mouseDownEvent(e)}mouseDownOutsideEvent(){const e=this._chart.model();!e.timeScale().isEmpty()&&this._mouseDown&&(this._mouseDown=!1,this._chart.options().handleScale.axisPressedMouseMove.time&&e.endScaleTime())}pressedMouseMoveEvent(e){const t=this._chart.model();t.timeScale().isEmpty()||!this._chart.options().handleScale.axisPressedMouseMove.time||t.scaleTimeTo(e.localX)}touchMoveEvent(e){this.pressedMouseMoveEvent(e)}mouseUpEvent(){this._mouseDown=!1;const e=this._chart.model();e.timeScale().isEmpty()&&!this._chart.options().handleScale.axisPressedMouseMove.time||e.endScaleTime()}touchEndEvent(){this.mouseUpEvent()}mouseDoubleClickEvent(){this._chart.options().handleScale.axisDoubleClickReset.time&&this._chart.model().resetTimeScale()}doubleTapEvent(){this.mouseDoubleClickEvent()}mouseEnterEvent(){this._chart.model().options().handleScale.axisPressedMouseMove.time&&this._setCursor(1)}mouseLeaveEvent(){this._setCursor(0)}getSize(){return this._size}sizeChanged(){return this._sizeChanged}setSizes(e,t,i){$(this._size,e)||(this._size=e,this._isSettingSize=!0,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._isSettingSize=!1,this._cell.style.width=`${e.width}px`,this._cell.style.height=`${e.height}px`,this._sizeChanged.fire(e)),this._leftStub!==null&&this._leftStub.setSize(P({width:t,height:e.height})),this._rightStub!==null&&this._rightStub.setSize(P({width:i,height:e.height}))}optimalHeight(){const e=this._getRendererOptions();return Math.ceil(e.borderSize+e.tickLength+e.fontSize+e.paddingTop+e.paddingBottom+e.labelBottomOffset)}update(){this._chart.model().timeScale().marks()}getBitmapSize(){return this._canvasBinding.bitmapSize}drawBitmap(e,t,i){const r=this.getBitmapSize();r.width>0&&r.height>0&&e.drawImage(this._canvasBinding.canvasElement,t,i)}paint(e){if(e===x.None)return;const t={colorSpace:this._options.colorSpace};if(e!==x.Cursor){this._canvasBinding.applySuggestedBitmapSize();const r=K(this._canvasBinding,t);r!==null&&(r.useBitmapCoordinateSpace(n=>{this._drawBackground(n),this._drawBorder(n),this._drawAdditionalSources(r,nn)}),this._drawTickMarks(r),this._drawAdditionalSources(r,sn)),this._leftStub!==null&&this._leftStub.paint(e),this._rightStub!==null&&this._rightStub.paint(e)}this._topCanvasBinding.applySuggestedBitmapSize();const i=K(this._topCanvasBinding,t);i!==null&&(i.useBitmapCoordinateSpace(({context:r,bitmapSize:n})=>{r.clearRect(0,0,n.width,n.height)}),this._drawLabels([...this._chart.model().serieses(),this._chart.model().crosshairSource()],i),this._drawAdditionalSources(i,rn))}_drawAdditionalSources(e,t){const i=this._chart.model().serieses();for(const r of i)ct(t,n=>ht(n,e,!1,void 0),r,void 0);for(const r of i)ct(t,n=>ke(n,e,!1,void 0),r,void 0)}_drawBackground({context:e,bitmapSize:t}){Le(e,0,0,t.width,t.height,this._chart.model().backgroundBottomColor())}_drawBorder({context:e,bitmapSize:t,verticalPixelRatio:i}){if(this._chart.options().timeScale.borderVisible){e.fillStyle=this._lineColor();const r=Math.max(1,Math.floor(this._getRendererOptions().borderSize*i));e.fillRect(0,0,t.width,r)}}_drawTickMarks(e){const t=this._chart.model().timeScale(),i=t.marks();if(!i||i.length===0)return;const r=this._horzScaleBehavior.maxTickMarkWeight(i),n=this._getRendererOptions(),o=t.options();o.borderVisible&&o.ticksVisible&&e.useBitmapCoordinateSpace(({context:a,horizontalPixelRatio:l,verticalPixelRatio:h})=>{a.strokeStyle=this._lineColor(),a.fillStyle=this._lineColor();const c=Math.max(1,Math.floor(l)),d=Math.floor(l*.5);a.beginPath();const u=Math.round(n.tickLength*h);for(let _=i.length;_--;){const p=Math.round(i[_].coord*l);a.rect(p-d,0,c,u)}a.fill()}),e.useMediaCoordinateSpace(({context:a})=>{const l=n.borderSize+n.tickLength+n.paddingTop+n.fontSize/2;a.textAlign="center",a.textBaseline="middle",a.fillStyle=this._textColor(),a.font=this._baseFont();for(const h of i)if(h.weight<r){const c=h.needAlignCoordinate?this._alignTickMarkLabelCoordinate(a,h.coord,h.label):h.coord;a.fillText(h.label,c,l)}this._chart.options().timeScale.allowBoldLabels&&(a.font=this._baseBoldFont());for(const h of i)if(h.weight>=r){const c=h.needAlignCoordinate?this._alignTickMarkLabelCoordinate(a,h.coord,h.label):h.coord;a.fillText(h.label,c,l)}})}_alignTickMarkLabelCoordinate(e,t,i){const r=this._widthCache.measureText(e,i),n=r/2,o=Math.floor(t-n)+.5;return o<0?t=t+Math.abs(0-o):o+r>this._size.width&&(t=t-Math.abs(this._size.width-(o+r))),t}_drawLabels(e,t){const i=this._getRendererOptions();for(const r of e)for(const n of r.timeAxisViews())n.renderer().draw(t,i)}_lineColor(){return this._chart.options().timeScale.borderColor}_textColor(){return this._options.textColor}_fontSize(){return this._options.fontSize}_baseFont(){return Be(this._fontSize(),this._options.fontFamily)}_baseBoldFont(){return Be(this._fontSize(),this._options.fontFamily,"bold")}_getRendererOptions(){this._rendererOptions===null&&(this._rendererOptions={borderSize:1,baselineOffset:NaN,paddingTop:NaN,paddingBottom:NaN,paddingHorizontal:NaN,tickLength:5,fontSize:NaN,font:"",widthCache:new Ee,labelBottomOffset:0});const e=this._rendererOptions,t=this._baseFont();if(e.font!==t){const i=this._fontSize();e.fontSize=i,e.font=t,e.paddingTop=3*i/12,e.paddingBottom=3*i/12,e.paddingHorizontal=9*i/12,e.baselineOffset=0,e.labelBottomOffset=4*i/12,e.widthCache.reset()}return this._rendererOptions}_setCursor(e){this._cell.style.cursor=e===1?"ew-resize":"default"}_recreateStubs(){const e=this._chart.model(),t=e.options();!t.leftPriceScale.visible&&this._leftStub!==null&&(this._leftStubCell.removeChild(this._leftStub.getElement()),this._leftStub.destroy(),this._leftStub=null),!t.rightPriceScale.visible&&this._rightStub!==null&&(this._rightStubCell.removeChild(this._rightStub.getElement()),this._rightStub.destroy(),this._rightStub=null);const r={rendererOptionsProvider:this._chart.model().rendererOptionsProvider()},n=()=>t.leftPriceScale.borderVisible&&e.timeScale().options().borderVisible,o=()=>e.backgroundBottomColor();t.leftPriceScale.visible&&this._leftStub===null&&(this._leftStub=new qt("left",t,r,n,o),this._leftStubCell.appendChild(this._leftStub.getElement())),t.rightPriceScale.visible&&this._rightStub===null&&(this._rightStub=new qt("right",t,r,n,o),this._rightStubCell.appendChild(this._rightStub.getElement()))}}const an=Hr()&&Fr();class ln{constructor(e,t,i){this._paneWidgets=[],this._paneSeparators=[],this._drawRafId=0,this._height=0,this._width=0,this._leftPriceAxisWidth=0,this._rightPriceAxisWidth=0,this._invalidateMask=null,this._drawPlanned=!1,this._clicked=new T,this._dblClicked=new T,this._crosshairMoved=new T,this._observer=null,this._cursorStyleOverride=null,this._container=e,this._options=t,this._horzScaleBehavior=i,this._element=document.createElement("div"),this._element.classList.add("tv-lightweight-charts"),this._element.style.overflow="hidden",this._element.style.direction="ltr",this._element.style.width="100%",this._element.style.height="100%",hn(this._element),this._tableElement=document.createElement("table"),this._tableElement.setAttribute("cellspacing","0"),this._element.appendChild(this._tableElement),this._onWheelBound=this._onMousewheel.bind(this),it(this._options)&&this._setMouseWheelEventListener(!0),this._model=new ur(this._invalidateHandler.bind(this),this._options,i),this.model().crosshairMoved().subscribe(this._onPaneWidgetCrosshairMoved.bind(this),this),this._timeAxisWidget=new on(this,this._horzScaleBehavior),this._tableElement.appendChild(this._timeAxisWidget.getElement());const r=t.autoSize&&this._installObserver();let n=this._options.width,o=this._options.height;if(r||n===0||o===0){const a=e.getBoundingClientRect();n=n||a.width,o=o||a.height}this.resize(n,o),this._syncGuiWithModel(),e.appendChild(this._element),this._updateTimeAxisVisibility(),this._model.timeScale().optionsApplied().subscribe(this._model.fullUpdate.bind(this._model),this),this._model.priceScalesOptionsChanged().subscribe(this._model.fullUpdate.bind(this._model),this)}model(){return this._model}options(){return this._options}paneWidgets(){return this._paneWidgets}timeAxisWidget(){return this._timeAxisWidget}destroy(){this._setMouseWheelEventListener(!1),this._drawRafId!==0&&window.cancelAnimationFrame(this._drawRafId),this._model.crosshairMoved().unsubscribeAll(this),this._model.timeScale().optionsApplied().unsubscribeAll(this),this._model.priceScalesOptionsChanged().unsubscribeAll(this),this._model.destroy();for(const e of this._paneWidgets)this._tableElement.removeChild(e.getElement()),e.clicked().unsubscribeAll(this),e.dblClicked().unsubscribeAll(this),e.destroy();this._paneWidgets=[];for(const e of this._paneSeparators)this._destroySeparator(e);this._paneSeparators=[],m(this._timeAxisWidget).destroy(),this._element.parentElement!==null&&this._element.parentElement.removeChild(this._element),this._crosshairMoved.destroy(),this._clicked.destroy(),this._dblClicked.destroy(),this._uninstallObserver()}resize(e,t,i=!1){if(this._height===t&&this._width===e)return;const r=Nr(P({width:e,height:t}));this._height=r.height,this._width=r.width;const n=this._height+"px",o=this._width+"px";m(this._element).style.height=n,m(this._element).style.width=o,this._tableElement.style.height=n,this._tableElement.style.width=o,i?this._drawImpl(M.full(),performance.now()):this._model.fullUpdate()}paint(e){e===void 0&&(e=M.full());for(let t=0;t<this._paneWidgets.length;t++)this._paneWidgets[t].paint(e.invalidateForPane(t).level);this._options.timeScale.visible&&this._timeAxisWidget.paint(e.fullInvalidation())}applyOptions(e){var r;const t=it(this._options);this._model.applyOptions(e);const i=it(this._options);i!==t&&this._setMouseWheelEventListener(i),(r=e.layout)!=null&&r.panes&&this._applyPanesOptions(),this._updateTimeAxisVisibility(),this._applyAutoSizeOptions(e)}clicked(){return this._clicked}dblClicked(){return this._dblClicked}crosshairMoved(){return this._crosshairMoved}takeScreenshot(){this._invalidateMask!==null&&(this._drawImpl(this._invalidateMask,performance.now()),this._invalidateMask=null);const e=this._traverseLayout(null),t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=m(t.getContext("2d"));return this._traverseLayout(i),t}getPriceAxisWidth(e){if(e===L.Left&&!this._isLeftAxisVisible()||e===L.Right&&!this._isRightAxisVisible()||this._paneWidgets.length===0)return 0;const t=e===L.Left?this._paneWidgets[0].leftPriceAxisWidget():this._paneWidgets[0].rightPriceAxisWidget();return m(t).getWidth()}autoSizeActive(){return this._options.autoSize&&this._observer!==null}element(){return this._element}setCursorStyle(e){this._cursorStyleOverride=e,this._cursorStyleOverride?this.element().style.setProperty("cursor",e):this.element().style.removeProperty("cursor")}getCursorOverrideStyle(){return this._cursorStyleOverride}paneSize(e){return V(this._paneWidgets[e]).getSize()}_applyPanesOptions(){this._paneSeparators.forEach(e=>{e.update()})}_applyAutoSizeOptions(e){e.autoSize===void 0&&this._observer&&(e.width!==void 0||e.height!==void 0)||(e.autoSize&&!this._observer&&this._installObserver(),e.autoSize===!1&&this._observer!==null&&this._uninstallObserver(),!e.autoSize&&(e.width!==void 0||e.height!==void 0)&&this.resize(e.width||this._width,e.height||this._height))}_traverseLayout(e){let t=0,i=0;const r=this._paneWidgets[0],n=(l,h)=>{let c=0;for(let d=0;d<this._paneWidgets.length;d++){const u=this._paneWidgets[d],_=m(l==="left"?u.leftPriceAxisWidget():u.rightPriceAxisWidget()),p=_.getBitmapSize();if(e!==null&&_.drawBitmap(e,h,c),c+=p.height,d<this._paneWidgets.length-1){const f=this._paneSeparators[d],g=f.getBitmapSize();e!==null&&f.drawBitmap(e,h,c),c+=g.height}}};if(this._isLeftAxisVisible()){n("left",0);const l=m(r.leftPriceAxisWidget()).getBitmapSize().width;t+=l}for(let l=0;l<this._paneWidgets.length;l++){const h=this._paneWidgets[l],c=h.getBitmapSize();if(e!==null&&h.drawBitmap(e,t,i),i+=c.height,l<this._paneWidgets.length-1){const d=this._paneSeparators[l],u=d.getBitmapSize();e!==null&&d.drawBitmap(e,t,i),i+=u.height}}const o=r.getBitmapSize().width;if(t+=o,this._isRightAxisVisible()){n("right",t);const l=m(r.rightPriceAxisWidget()).getBitmapSize().width;t+=l}const a=(l,h,c)=>{m(l==="left"?this._timeAxisWidget.leftStub():this._timeAxisWidget.rightStub()).drawBitmap(m(e),h,c)};if(this._options.timeScale.visible){const l=this._timeAxisWidget.getBitmapSize();if(e!==null){let h=0;this._isLeftAxisVisible()&&(a("left",h,i),h=m(r.leftPriceAxisWidget()).getBitmapSize().width),this._timeAxisWidget.drawBitmap(e,h,i),h+=l.width,this._isRightAxisVisible()&&a("right",h,i)}i+=l.height}return P({width:t,height:i})}_adjustSizeImpl(){let e=0,t=0,i=0;for(const S of this._paneWidgets)this._isLeftAxisVisible()&&(t=Math.max(t,m(S.leftPriceAxisWidget()).optimalWidth(),this._options.leftPriceScale.minimumWidth)),this._isRightAxisVisible()&&(i=Math.max(i,m(S.rightPriceAxisWidget()).optimalWidth(),this._options.rightPriceScale.minimumWidth)),e+=S.stretchFactor();t=lt(t),i=lt(i);const r=this._width,n=this._height,o=Math.max(r-t-i,0),a=this._paneSeparators.length,h=Vi.SeparatorHeight*a,c=this._options.timeScale.visible;let d=c?Math.max(this._timeAxisWidget.optimalHeight(),this._options.timeScale.minimumHeight):0;d=Ur(d);const u=h+d,_=n<u?0:n-u,p=_/e;let f=0;const g=window.devicePixelRatio||1;for(let S=0;S<this._paneWidgets.length;++S){const v=this._paneWidgets[S];v.setState(this._model.panes()[S]);let y=0,w=0;S===this._paneWidgets.length-1?w=Math.ceil((_-f)*g)/g:w=Math.round(v.stretchFactor()*p*g)/g,y=Math.max(w,2),f+=y,v.setSize(P({width:o,height:y})),this._isLeftAxisVisible()&&v.setPriceAxisSize(t,"left"),this._isRightAxisVisible()&&v.setPriceAxisSize(i,"right"),v.state()&&this._model.setPaneHeight(v.state(),y)}this._timeAxisWidget.setSizes(P({width:c?o:0,height:d}),c?t:0,c?i:0),this._model.setWidth(o),this._leftPriceAxisWidth!==t&&(this._leftPriceAxisWidth=t),this._rightPriceAxisWidth!==i&&(this._rightPriceAxisWidth=i)}_setMouseWheelEventListener(e){if(e){this._element.addEventListener("wheel",this._onWheelBound,{passive:!1});return}this._element.removeEventListener("wheel",this._onWheelBound)}_determineWheelSpeedAdjustment(e){switch(e.deltaMode){case e.DOM_DELTA_PAGE:return 120;case e.DOM_DELTA_LINE:return 32}return an?1/window.devicePixelRatio:1}_onMousewheel(e){if((e.deltaX===0||!this._options.handleScroll.mouseWheel)&&(e.deltaY===0||!this._options.handleScale.mouseWheel))return;const t=this._determineWheelSpeedAdjustment(e),i=t*e.deltaX/100,r=-(t*e.deltaY/100);if(e.cancelable&&e.preventDefault(),r!==0&&this._options.handleScale.mouseWheel){const n=Math.sign(r)*Math.min(1,Math.abs(r)),o=e.clientX-this._element.getBoundingClientRect().left;this.model().zoomTime(o,n)}i!==0&&this._options.handleScroll.mouseWheel&&this.model().scrollChart(i*-80)}_drawImpl(e,t){var r;const i=e.fullInvalidation();i===x.Full&&this._updateGui(),(i===x.Full||i===x.Light)&&(this._applyMomentaryAutoScale(e),this._applyTimeScaleInvalidations(e,t),this._timeAxisWidget.update(),this._paneWidgets.forEach(n=>{n.updatePriceAxisWidgets()}),((r=this._invalidateMask)==null?void 0:r.fullInvalidation())===x.Full&&(this._invalidateMask.merge(e),this._updateGui(),this._applyMomentaryAutoScale(this._invalidateMask),this._applyTimeScaleInvalidations(this._invalidateMask,t),e=this._invalidateMask,this._invalidateMask=null)),this.paint(e)}_applyTimeScaleInvalidations(e,t){for(const i of e.timeScaleInvalidations())this._applyTimeScaleInvalidation(i,t)}_applyMomentaryAutoScale(e){const t=this._model.panes();for(let i=0;i<t.length;i++)e.invalidateForPane(i).autoScale&&t[i].momentaryAutoScale()}_applyTimeScaleInvalidation(e,t){const i=this._model.timeScale();switch(e.type){case Y.FitContent:i.fitContent();break;case Y.ApplyRange:i.setLogicalRange(e.value);break;case Y.ApplyBarSpacing:i.setBarSpacing(e.value);break;case Y.ApplyRightOffset:i.setRightOffset(e.value);break;case Y.Reset:i.restoreDefault();break;case Y.Animation:e.value.finished(t)||i.setRightOffset(e.value.getPosition(t));break}}_invalidateHandler(e){this._invalidateMask!==null?this._invalidateMask.merge(e):this._invalidateMask=e,this._drawPlanned||(this._drawPlanned=!0,this._drawRafId=window.requestAnimationFrame(t=>{if(this._drawPlanned=!1,this._drawRafId=0,this._invalidateMask!==null){const i=this._invalidateMask;this._invalidateMask=null,this._drawImpl(i,t);for(const r of i.timeScaleInvalidations())if(r.type===Y.Animation&&!r.value.finished(t)){this.model().setTimeScaleAnimation(r.value);break}}}))}_updateGui(){this._syncGuiWithModel()}_destroySeparator(e){this._tableElement.removeChild(e.getElement()),e.destroy()}_syncGuiWithModel(){const e=this._model.panes(),t=e.length,i=this._paneWidgets.length;for(let r=t;r<i;r++){const n=V(this._paneWidgets.pop());this._tableElement.removeChild(n.getElement()),n.clicked().unsubscribeAll(this),n.dblClicked().unsubscribeAll(this),n.destroy();const o=this._paneSeparators.pop();o!==void 0&&this._destroySeparator(o)}for(let r=i;r<t;r++){const n=new vt(this,e[r]);if(n.clicked().subscribe(this._onPaneWidgetClicked.bind(this,n),this),n.dblClicked().subscribe(this._onPaneWidgetDblClicked.bind(this,n),this),this._paneWidgets.push(n),r>0){const o=new Gr(this,r-1,r);this._paneSeparators.push(o),this._tableElement.insertBefore(o.getElement(),this._timeAxisWidget.getElement())}this._tableElement.insertBefore(n.getElement(),this._timeAxisWidget.getElement())}for(let r=0;r<t;r++){const n=e[r],o=this._paneWidgets[r];o.state()!==n?o.setState(n):o.updatePriceAxisWidgetsStates()}this._updateTimeAxisVisibility(),this._adjustSizeImpl()}_getMouseEventParamsImpl(e,t,i,r){var d;const n=new Map;e!==null&&this._model.serieses().forEach(_=>{const p=_.bars().search(e);p!==null&&n.set(_,p)});let o;if(e!==null){const u=(d=this._model.timeScale().indexToTimeScalePoint(e))==null?void 0:d.originalTime;u!==void 0&&(o=u)}const a=this.model().hoveredSource(),l=a!==null&&a.source instanceof Oe?a.source:void 0,h=a!==null&&a.object!==void 0?a.object.externalId:void 0,c=this._getPaneIndex(r);return{originalTime:o,index:e??void 0,point:t??void 0,paneIndex:c!==-1?c:void 0,hoveredSeries:l,seriesData:n,hoveredObject:h,touchMouseEventData:i??void 0}}_getPaneIndex(e){let t=-1;if(e)t=this._paneWidgets.indexOf(e);else{const i=this.model().crosshairSource().pane();i!==null&&(t=this.model().panes().indexOf(i))}return t}_onPaneWidgetClicked(e,t,i,r){this._clicked.fire(()=>this._getMouseEventParamsImpl(t,i,r,e))}_onPaneWidgetDblClicked(e,t,i,r){this._dblClicked.fire(()=>this._getMouseEventParamsImpl(t,i,r,e))}_onPaneWidgetCrosshairMoved(e,t,i){var r;this.setCursorStyle(((r=this.model().hoveredSource())==null?void 0:r.cursorStyle)??null),this._crosshairMoved.fire(()=>this._getMouseEventParamsImpl(e,t,i))}_updateTimeAxisVisibility(){const e=this._options.timeScale.visible?"":"none";this._timeAxisWidget.getElement().style.display=e}_isLeftAxisVisible(){return this._paneWidgets[0].state().leftPriceScale().options().visible}_isRightAxisVisible(){return this._paneWidgets[0].state().rightPriceScale().options().visible}_installObserver(){return"ResizeObserver"in window?(this._observer=new ResizeObserver(e=>{const t=e[e.length-1];t&&this.resize(t.contentRect.width,t.contentRect.height)}),this._observer.observe(this._container,{box:"border-box"}),!0):!1}_uninstallObserver(){this._observer!==null&&this._observer.disconnect(),this._observer=null}}function hn(s){s.style.userSelect="none",s.style.webkitUserSelect="none",s.style.msUserSelect="none",s.style.MozUserSelect="none",s.style.webkitTapHighlightColor="transparent"}function it(s){return!!(s.handleScroll.mouseWheel||s.handleScale.mouseWheel)}function cn(s){return s.open===void 0&&s.value===void 0}function dn(s){return un(s)||_n(s)}function un(s){return s.open!==void 0}function _n(s){return s.value!==void 0}function Zt(s,e,t,i){const r=t.value,n={index:e,time:s,value:[r,r,r,r],originalTime:i};return t.color!==void 0&&(n.color=t.color),n}function pn(s,e,t,i){const r=t.value,n={index:e,time:s,value:[r,r,r,r],originalTime:i};return t.lineColor!==void 0&&(n.lineColor=t.lineColor),t.topColor!==void 0&&(n.topColor=t.topColor),t.bottomColor!==void 0&&(n.bottomColor=t.bottomColor),n}function mn(s,e,t,i){const r=t.value,n={index:e,time:s,value:[r,r,r,r],originalTime:i};return t.topLineColor!==void 0&&(n.topLineColor=t.topLineColor),t.bottomLineColor!==void 0&&(n.bottomLineColor=t.bottomLineColor),t.topFillColor1!==void 0&&(n.topFillColor1=t.topFillColor1),t.topFillColor2!==void 0&&(n.topFillColor2=t.topFillColor2),t.bottomFillColor1!==void 0&&(n.bottomFillColor1=t.bottomFillColor1),t.bottomFillColor2!==void 0&&(n.bottomFillColor2=t.bottomFillColor2),n}function fn(s,e,t,i){const r={index:e,time:s,value:[t.open,t.high,t.low,t.close],originalTime:i};return t.color!==void 0&&(r.color=t.color),r}function gn(s,e,t,i){const r={index:e,time:s,value:[t.open,t.high,t.low,t.close],originalTime:i};return t.color!==void 0&&(r.color=t.color),t.borderColor!==void 0&&(r.borderColor=t.borderColor),t.wickColor!==void 0&&(r.wickColor=t.wickColor),r}function Sn(s,e,t,i,r){const n=V(r)(t),o=Math.max(...n),a=Math.min(...n),l=n[n.length-1],h=[l,o,a,l],{time:c,color:d,...u}=t;return{index:e,time:s,value:h,originalTime:i,data:u,color:d}}function de(s){return s.value!==void 0}function Qt(s,e){return e.customValues!==void 0&&(s.customValues=e.customValues),s}function vn(s,e){return e?e(s):cn(s)}function G(s){return(e,t,i,r,n,o)=>vn(i,o)?Qt({time:e,index:t,originalTime:r},i):Qt(s(e,t,i,r,n),i)}function Jt(s){return{Candlestick:G(gn),Bar:G(fn),Area:G(pn),Baseline:G(mn),Histogram:G(Zt),Line:G(Zt),Custom:G(Sn)}[s]}function ei(s){return{index:0,mapping:new Map,timePoint:s}}function ti(s,e){if(!(s===void 0||s.length===0))return{firstTime:e.key(s[0].time),lastTime:e.key(s[s.length-1].time)}}function bn(s,e,t){const i=ti(s,t),r=ti(e,t);if(i!==void 0&&r!==void 0)return{historicalUpdate:!1,lastBarUpdatedOrNewBarsAddedToTheRight:i.lastTime>=r.lastTime&&i.firstTime>=r.firstTime}}function ii(s){let e;return s.forEach(t=>{e===void 0&&(e=t.originalTime)}),V(e)}function Cn(s){s.originalTime===void 0&&(s.originalTime=s.time)}class Pn{constructor(e){this._pointDataByTimePoint=new Map,this._seriesRowsBySeries=new Map,this._seriesLastTimePoint=new Map,this._sortedTimePoints=[],this._horzScaleBehavior=e}destroy(){this._pointDataByTimePoint.clear(),this._seriesRowsBySeries.clear(),this._seriesLastTimePoint.clear(),this._sortedTimePoints=[]}setSeriesData(e,t){let i=this._pointDataByTimePoint.size!==0,r=!1;const n=this._seriesRowsBySeries.get(e);if(n!==void 0)if(this._seriesRowsBySeries.size===1)i=!1,r=!0,this._pointDataByTimePoint.clear();else for(const l of this._sortedTimePoints)l.pointData.mapping.delete(e)&&(r=!0);let o=[];if(t.length!==0){const l=t.map(_=>_.time),h=this._horzScaleBehavior.createConverterToInternalObj(t),c=Jt(e.seriesType()),d=e.customSeriesPlotValuesBuilder(),u=e.customSeriesWhitespaceCheck();o=t.map((_,p)=>{const f=h(_.time),g=this._horzScaleBehavior.key(f);let S=this._pointDataByTimePoint.get(g);S===void 0&&(S=ei(f),this._pointDataByTimePoint.set(g,S),r=!0);const v=c(f,S.index,_,l[p],d,u);return S.mapping.set(e,v),v})}i&&this._cleanupPointsData(),this._setRowsToSeries(e,o);let a=-1;if(r){const l=[];this._pointDataByTimePoint.forEach(h=>{l.push({timeWeight:0,time:h.timePoint,pointData:h,originalTime:ii(h.mapping)})}),l.sort((h,c)=>this._horzScaleBehavior.key(h.time)-this._horzScaleBehavior.key(c.time)),a=this._replaceTimeScalePoints(l)}return this._getUpdateResponse(e,a,bn(this._seriesRowsBySeries.get(e),n,this._horzScaleBehavior))}removeSeries(e){return this.setSeriesData(e,[])}updateSeriesData(e,t,i){const r=t;Cn(r),this._horzScaleBehavior.preprocessData(t);const o=this._horzScaleBehavior.createConverterToInternalObj([t])(t.time),a=this._seriesLastTimePoint.get(e);if(!i&&a!==void 0&&this._horzScaleBehavior.key(o)<this._horzScaleBehavior.key(a))throw new Error(`Cannot update oldest data, last time=${a}, new time=${o}`);let l=this._pointDataByTimePoint.get(this._horzScaleBehavior.key(o));if(i&&l===void 0)throw new Error("Cannot update non-existing data point when historicalUpdate is true");const h=l===void 0;l===void 0&&(l=ei(o),this._pointDataByTimePoint.set(this._horzScaleBehavior.key(o),l));const c=Jt(e.seriesType()),d=e.customSeriesPlotValuesBuilder(),u=e.customSeriesWhitespaceCheck(),_=c(o,l.index,t,r.originalTime,d,u);l.mapping.set(e,_),i?this._updateHistoricalSeriesRow(e,_,l.index):this._updateLastSeriesRow(e,_);const p={lastBarUpdatedOrNewBarsAddedToTheRight:de(_),historicalUpdate:i};if(!h)return this._getUpdateResponse(e,-1,p);const f={timeWeight:0,time:l.timePoint,pointData:l,originalTime:ii(l.mapping)},g=re(this._sortedTimePoints,this._horzScaleBehavior.key(f.time),(S,v)=>this._horzScaleBehavior.key(S.time)<v);this._sortedTimePoints.splice(g,0,f);for(let S=g;S<this._sortedTimePoints.length;++S)st(this._sortedTimePoints[S].pointData,S);return this._horzScaleBehavior.fillWeightsForPoints(this._sortedTimePoints,g),this._getUpdateResponse(e,g,p)}_updateLastSeriesRow(e,t){let i=this._seriesRowsBySeries.get(e);i===void 0&&(i=[],this._seriesRowsBySeries.set(e,i));const r=i.length!==0?i[i.length-1]:null;r===null||this._horzScaleBehavior.key(t.time)>this._horzScaleBehavior.key(r.time)?de(t)&&i.push(t):de(t)?i[i.length-1]=t:i.splice(-1,1),this._seriesLastTimePoint.set(e,t.time)}_updateHistoricalSeriesRow(e,t,i){const r=this._seriesRowsBySeries.get(e);if(r===void 0)return;const n=re(r,i,(o,a)=>o.index<a);de(t)?r[n]=t:r.splice(n,1)}_setRowsToSeries(e,t){t.length!==0?(this._seriesRowsBySeries.set(e,t.filter(de)),this._seriesLastTimePoint.set(e,t[t.length-1].time)):(this._seriesRowsBySeries.delete(e),this._seriesLastTimePoint.delete(e))}_cleanupPointsData(){for(const e of this._sortedTimePoints)e.pointData.mapping.size===0&&this._pointDataByTimePoint.delete(this._horzScaleBehavior.key(e.time))}_replaceTimeScalePoints(e){let t=-1;for(let i=0;i<this._sortedTimePoints.length&&i<e.length;++i){const r=this._sortedTimePoints[i],n=e[i];if(this._horzScaleBehavior.key(r.time)!==this._horzScaleBehavior.key(n.time)){t=i;break}n.timeWeight=r.timeWeight,st(n.pointData,i)}if(t===-1&&this._sortedTimePoints.length!==e.length&&(t=Math.min(this._sortedTimePoints.length,e.length)),t===-1)return-1;for(let i=t;i<e.length;++i)st(e[i].pointData,i);return this._horzScaleBehavior.fillWeightsForPoints(e,t),this._sortedTimePoints=e,t}_getBaseIndex(){if(this._seriesRowsBySeries.size===0)return null;let e=0;return this._seriesRowsBySeries.forEach(t=>{t.length!==0&&(e=Math.max(e,t[t.length-1].index))}),e}_getUpdateResponse(e,t,i){const r={series:new Map,timeScale:{baseIndex:this._getBaseIndex()}};if(t!==-1)this._seriesRowsBySeries.forEach((n,o)=>{r.series.set(o,{data:n,info:o===e?i:void 0})}),this._seriesRowsBySeries.has(e)||r.series.set(e,{data:[],info:i}),r.timeScale.points=this._sortedTimePoints,r.timeScale.firstChangedPointIndex=t;else{const n=this._seriesRowsBySeries.get(e);r.series.set(e,{data:n||[],info:i})}return r}}function st(s,e){s.index=e,s.mapping.forEach(t=>{t.index=e})}function wn(s,e){return s.time<e}function yn(s,e){return e<s.time}function xn(s,e,t){const i=e.left(),r=e.right(),n=re(s,i,wn),o=Ci(s,r,yn);if(!t)return{from:n,to:o};let a=n,l=o;return n>0&&n<s.length&&s[n].time>=i&&(a=n-1),o>0&&o<s.length&&s[o-1].time<=r&&(l=o+1),{from:a,to:l}}class Ai{constructor(e,t,i){this._invalidated=!0,this._dataInvalidated=!0,this._optionsInvalidated=!0,this._items=[],this._itemsVisibleRange=null,this._series=e,this._model=t,this._extendedVisibleRange=i}update(e){this._invalidated=!0,e==="data"&&(this._dataInvalidated=!0),e==="options"&&(this._optionsInvalidated=!0)}renderer(){return this._series.visible()?(this._makeValid(),this._itemsVisibleRange===null?null:this._renderer):null}_updateOptions(){this._items=this._items.map(e=>({...e,...this._series.barColorer().barStyle(e.time)}))}_clearVisibleRange(){this._itemsVisibleRange=null}_makeValid(){this._dataInvalidated&&(this._fillRawPoints(),this._dataInvalidated=!1),this._optionsInvalidated&&(this._updateOptions(),this._optionsInvalidated=!1),this._invalidated&&(this._makeValidImpl(),this._invalidated=!1)}_makeValidImpl(){const e=this._series.priceScale(),t=this._model.timeScale();if(this._clearVisibleRange(),t.isEmpty()||e.isEmpty())return;const i=t.visibleStrictRange();if(i===null||this._series.bars().size()===0)return;const r=this._series.firstValue();r!==null&&(this._itemsVisibleRange=xn(this._items,i,this._extendedVisibleRange),this._convertToCoordinates(e,t,r.value),this._prepareRendererData())}}class Tn{constructor(e,t){this._sourceRenderer=e,this._priceScale=t}draw(e,t,i){this._sourceRenderer.draw(e,this._priceScale,t,i)}}class Mn extends Ai{constructor(e,t,i){super(e,t,!1),this._paneView=i,this._renderer=new Tn(this._paneView.renderer(),r=>{const n=e.firstValue();return n===null?null:e.priceScale().priceToCoordinate(r,n.value)})}priceValueBuilder(e){return this._paneView.priceValueBuilder(e)}isWhitespace(e){return this._paneView.isWhitespace(e)}_fillRawPoints(){const e=this._series.barColorer();this._items=this._series.bars().rows().map(t=>({time:t.index,x:NaN,...e.barStyle(t.index),originalData:t.data}))}_convertToCoordinates(e,t){t.indexesToCoordinates(this._items,ot(this._itemsVisibleRange))}_prepareRendererData(){this._paneView.update({bars:this._items.map(kn),barSpacing:this._model.timeScale().barSpacing(),visibleRange:this._itemsVisibleRange},this._series.options())}}function kn(s){return{x:s.x,time:s.time,originalData:s.originalData,barColor:s.barColor}}const Bn={color:"#2196f3"},En=(s,e,t)=>{const i=X(t);return new Mn(s,e,i)},Rn=s=>({type:"Custom",isBuiltIn:!1,defaultOptions:{...Bn,...s.defaultOptions()},createPaneView:En,customPaneView:s}),Vn=s=>s.createPaneView!==void 0;function Ct(s){const e={value:s.value[C.Close],time:s.originalTime};return s.customValues!==void 0&&(e.customValues=s.customValues),e}function si(s){const e=Ct(s);return s.color!==void 0&&(e.color=s.color),e}function An(s){const e=Ct(s);return s.lineColor!==void 0&&(e.lineColor=s.lineColor),s.topColor!==void 0&&(e.topColor=s.topColor),s.bottomColor!==void 0&&(e.bottomColor=s.bottomColor),e}function Ln(s){const e=Ct(s);return s.topLineColor!==void 0&&(e.topLineColor=s.topLineColor),s.bottomLineColor!==void 0&&(e.bottomLineColor=s.bottomLineColor),s.topFillColor1!==void 0&&(e.topFillColor1=s.topFillColor1),s.topFillColor2!==void 0&&(e.topFillColor2=s.topFillColor2),s.bottomFillColor1!==void 0&&(e.bottomFillColor1=s.bottomFillColor1),s.bottomFillColor2!==void 0&&(e.bottomFillColor2=s.bottomFillColor2),e}function Li(s){const e={open:s.value[C.Open],high:s.value[C.High],low:s.value[C.Low],close:s.value[C.Close],time:s.originalTime};return s.customValues!==void 0&&(e.customValues=s.customValues),e}function zn(s){const e=Li(s);return s.color!==void 0&&(e.color=s.color),e}function Dn(s){const e=Li(s),{color:t,borderColor:i,wickColor:r}=s;return t!==void 0&&(e.color=t),i!==void 0&&(e.borderColor=i),r!==void 0&&(e.wickColor=r),e}function dt(s){return{Area:An,Line:si,Baseline:Ln,Histogram:si,Bar:zn,Candlestick:Dn,Custom:In}[s]}function In(s){const e=s.originalTime;return{...s.data,time:e}}const On={vertLine:{color:"#9598A1",width:1,style:z.LargeDashed,visible:!0,labelVisible:!0,labelBackgroundColor:"#131722"},horzLine:{color:"#9598A1",width:1,style:z.LargeDashed,visible:!0,labelVisible:!0,labelBackgroundColor:"#131722"},mode:N.Magnet},Wn={vertLines:{color:"#D6DCDE",style:z.Solid,visible:!0},horzLines:{color:"#D6DCDE",style:z.Solid,visible:!0}},Fn={background:{type:pt.Solid,color:"#FFFFFF"},textColor:"#191919",fontSize:12,fontFamily:ui,panes:{enableResize:!0,separatorColor:"#E0E3EB",separatorHoverColor:"rgba(178, 181, 189, 0.2)"},attributionLogo:!0,colorSpace:"srgb",colorParsers:[]},rt={autoScale:!0,mode:Ve.Normal,invertScale:!1,alignLabels:!0,borderVisible:!0,borderColor:"#2B2B43",entireTextOnly:!1,visible:!1,ticksVisible:!1,scaleMargins:{bottom:.1,top:.2},minimumWidth:0,ensureEdgeTickMarksVisible:!1},Hn={rightOffset:0,barSpacing:6,minBarSpacing:.5,maxBarSpacing:0,fixLeftEdge:!1,fixRightEdge:!1,lockVisibleTimeRangeOnResize:!1,rightBarStaysOnScroll:!1,borderVisible:!0,borderColor:"#2B2B43",visible:!0,timeVisible:!1,secondsVisible:!0,shiftVisibleRangeOnNewBar:!0,allowShiftVisibleRangeOnWhitespaceReplacement:!1,ticksVisible:!1,uniformDistribution:!1,minimumHeight:0,allowBoldLabels:!0,ignoreWhitespaceIndices:!1};function ri(){return{addDefaultPane:!0,width:0,height:0,autoSize:!1,layout:Fn,crosshair:On,grid:Wn,overlayPriceScales:{...rt},leftPriceScale:{...rt,visible:!1},rightPriceScale:{...rt,visible:!0},timeScale:Hn,localization:{locale:ne?navigator.language:"",dateFormat:"dd MMM 'yy"},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!0},handleScale:{axisPressedMouseMove:{time:!0,price:!0},axisDoubleClickReset:{time:!0,price:!0},mouseWheel:!0,pinch:!0},kineticScroll:{mouse:!1,touch:!0},trackingMode:{exitMode:ft.OnNextTap}}}class zi{constructor(e,t,i){this._chartWidget=e,this._priceScaleId=t,this._paneIndex=i??0}applyOptions(e){this._chartWidget.model().applyPriceScaleOptions(this._priceScaleId,e,this._paneIndex)}options(){return this._priceScale().options()}width(){return De(this._priceScaleId)?this._chartWidget.getPriceAxisWidth(this._priceScaleId):0}setVisibleRange(e){this.setAutoScale(!1),this._priceScale().setCustomPriceRange(new E(e.from,e.to))}getVisibleRange(){const e=this._priceScale().priceRange();return e===null?null:{from:e.minValue(),to:e.maxValue()}}setAutoScale(e){this.applyOptions({autoScale:e})}_priceScale(){return m(this._chartWidget.model().findPriceScale(this._priceScaleId,this._paneIndex)).priceScale}}class Nn{constructor(e,t,i,r){this._chartWidget=e,this._pane=i,this._seriesApiGetter=t,this._chartApi=r}getHeight(){return this._pane.height()}setHeight(e){const t=this._chartWidget.model(),i=t.getPaneIndex(this._pane);t.changePanesHeight(i,e)}getStretchFactor(){return this._pane.stretchFactor()}setStretchFactor(e){this._pane.setStretchFactor(e),this._chartWidget.model().fullUpdate()}paneIndex(){return this._chartWidget.model().getPaneIndex(this._pane)}moveTo(e){const t=this.paneIndex();t!==e&&(k(e>=0&&e<this._chartWidget.paneWidgets().length,"Invalid pane index"),this._chartWidget.model().movePane(t,e))}getSeries(){return this._pane.series().map(e=>this._seriesApiGetter(e))??[]}getHTMLElement(){const e=this._chartWidget.paneWidgets();return!e||e.length===0||!e[this.paneIndex()]?null:e[this.paneIndex()].getElement()}attachPrimitive(e){this._pane.attachPrimitive(e),e.attached&&e.attached({chart:this._chartApi,requestUpdate:()=>this._pane.model().fullUpdate()})}detachPrimitive(e){this._pane.detachPrimitive(e)}priceScale(e){if(this._pane.priceScaleById(e)===null)throw new Error(`Cannot find price scale with id: ${e}`);return new zi(this._chartWidget,e,this.paneIndex())}setPreserveEmptyPane(e){this._pane.setPreserveEmptyPane(e)}preserveEmptyPane(){return this._pane.preserveEmptyPane()}addCustomSeries(e,t={},i=0){return this._chartApi.addCustomSeries(e,t,i)}addSeries(e,t={}){return this._chartApi.addSeries(e,t,this.paneIndex())}}const Un={color:"#FF0000",price:0,lineStyle:z.Dashed,lineWidth:1,lineVisible:!0,axisLabelVisible:!0,title:"",axisLabelColor:"",axisLabelTextColor:""};class ni{constructor(e){this._priceLine=e}applyOptions(e){this._priceLine.applyOptions(e)}options(){return this._priceLine.options()}priceLine(){return this._priceLine}}class Yn{constructor(e,t,i,r,n,o){this._dataChangedDelegate=new T,this._series=e,this._dataUpdatesConsumer=t,this._priceScaleApiProvider=i,this._horzScaleBehavior=n,this._chartApi=r,this._paneApiGetter=o}destroy(){this._dataChangedDelegate.destroy()}priceFormatter(){return this._series.formatter()}priceToCoordinate(e){const t=this._series.firstValue();return t===null?null:this._series.priceScale().priceToCoordinate(e,t.value)}coordinateToPrice(e){const t=this._series.firstValue();return t===null?null:this._series.priceScale().coordinateToPrice(e,t.value)}barsInLogicalRange(e){if(e===null)return null;const t=new ie(new pe(e.from,e.to)).strictRange(),i=this._series.bars();if(i.isEmpty())return null;const r=i.search(t.left(),ge.NearestRight),n=i.search(t.right(),ge.NearestLeft),o=m(i.firstIndex()),a=m(i.lastIndex());if(r!==null&&n!==null&&r.index>n.index)return{barsBefore:e.from-o,barsAfter:a-e.to};const l=r===null||r.index===o?e.from-o:r.index-o,h=n===null||n.index===a?a-e.to:a-n.index,c={barsBefore:l,barsAfter:h};return r!==null&&n!==null&&(c.from=r.originalTime,c.to=n.originalTime),c}setData(e){this._horzScaleBehavior,this._series.seriesType(),this._dataUpdatesConsumer.applyNewData(this._series,e),this._onDataChanged("full")}update(e,t=!1){this._series.seriesType(),this._dataUpdatesConsumer.updateData(this._series,e,t),this._onDataChanged("update")}dataByIndex(e,t){const i=this._series.bars().search(e,t);return i===null?null:dt(this.seriesType())(i)}data(){const e=dt(this.seriesType());return this._series.bars().rows().map(i=>e(i))}subscribeDataChanged(e){this._dataChangedDelegate.subscribe(e)}unsubscribeDataChanged(e){this._dataChangedDelegate.unsubscribe(e)}applyOptions(e){this._series.applyOptions(e)}options(){return F(this._series.options())}priceScale(){return this._priceScaleApiProvider.priceScale(this._series.priceScale().id(),this.getPane().paneIndex())}createPriceLine(e){const t=A(F(Un),e),i=this._series.createPriceLine(t);return new ni(i)}removePriceLine(e){this._series.removePriceLine(e.priceLine())}priceLines(){return this._series.priceLines().map(e=>new ni(e))}seriesType(){return this._series.seriesType()}attachPrimitive(e){this._series.attachPrimitive(e),e.attached&&e.attached({chart:this._chartApi,series:this,requestUpdate:()=>this._series.model().fullUpdate(),horzScaleBehavior:this._horzScaleBehavior})}detachPrimitive(e){this._series.detachPrimitive(e),e.detached&&e.detached(),this._series.model().fullUpdate()}getPane(){const e=this._series,t=m(this._series.model().paneForSource(e));return this._paneApiGetter(t)}moveToPane(e){this._series.model().moveSeriesToPane(this._series,e)}seriesOrder(){const e=this._series.model().paneForSource(this._series);return e===null?-1:e.series().indexOf(this._series)}setSeriesOrder(e){const t=this._series.model().paneForSource(this._series);t!==null&&t.setSeriesOrder(this._series,e)}_onDataChanged(e){this._dataChangedDelegate.hasListeners()&&this._dataChangedDelegate.fire(e)}}class Xn{constructor(e,t,i){this._timeRangeChanged=new T,this._logicalRangeChanged=new T,this._sizeChanged=new T,this._model=e,this._timeScale=e.timeScale(),this._timeAxisWidget=t,this._timeScale.visibleBarsChanged().subscribe(this._onVisibleBarsChanged.bind(this)),this._timeScale.logicalRangeChanged().subscribe(this._onVisibleLogicalRangeChanged.bind(this)),this._timeAxisWidget.sizeChanged().subscribe(this._onSizeChanged.bind(this)),this._horzScaleBehavior=i}destroy(){this._timeScale.visibleBarsChanged().unsubscribeAll(this),this._timeScale.logicalRangeChanged().unsubscribeAll(this),this._timeAxisWidget.sizeChanged().unsubscribeAll(this),this._timeRangeChanged.destroy(),this._logicalRangeChanged.destroy(),this._sizeChanged.destroy()}scrollPosition(){return this._timeScale.rightOffset()}scrollToPosition(e,t){if(!t){this._model.setRightOffset(e);return}this._timeScale.scrollToOffsetAnimated(e,1e3)}scrollToRealTime(){this._timeScale.scrollToRealTime()}getVisibleRange(){const e=this._timeScale.visibleTimeRange();return e===null?null:{from:e.from.originalTime,to:e.to.originalTime}}setVisibleRange(e){const t={from:this._horzScaleBehavior.convertHorzItemToInternal(e.from),to:this._horzScaleBehavior.convertHorzItemToInternal(e.to)},i=this._timeScale.logicalRangeForTimeRange(t);this._model.setTargetLogicalRange(i)}getVisibleLogicalRange(){const e=this._timeScale.visibleLogicalRange();return e===null?null:{from:e.left(),to:e.right()}}setVisibleLogicalRange(e){k(e.from<=e.to,"The from index cannot be after the to index."),this._model.setTargetLogicalRange(e)}resetTimeScale(){this._model.resetTimeScale()}fitContent(){this._model.fitContent()}logicalToCoordinate(e){const t=this._model.timeScale();return t.isEmpty()?null:t.indexToCoordinate(e)}coordinateToLogical(e){return this._timeScale.isEmpty()?null:this._timeScale.coordinateToIndex(e)}timeToIndex(e,t){const i=this._horzScaleBehavior.convertHorzItemToInternal(e);return this._timeScale.timeToIndex(i,t)}timeToCoordinate(e){const t=this.timeToIndex(e,!1);return t===null?null:this._timeScale.indexToCoordinate(t)}coordinateToTime(e){const t=this._model.timeScale(),i=t.coordinateToIndex(e),r=t.indexToTimeScalePoint(i);return r===null?null:r.originalTime}width(){return this._timeAxisWidget.getSize().width}height(){return this._timeAxisWidget.getSize().height}subscribeVisibleTimeRangeChange(e){this._timeRangeChanged.subscribe(e)}unsubscribeVisibleTimeRangeChange(e){this._timeRangeChanged.unsubscribe(e)}subscribeVisibleLogicalRangeChange(e){this._logicalRangeChanged.subscribe(e)}unsubscribeVisibleLogicalRangeChange(e){this._logicalRangeChanged.unsubscribe(e)}subscribeSizeChange(e){this._sizeChanged.subscribe(e)}unsubscribeSizeChange(e){this._sizeChanged.unsubscribe(e)}applyOptions(e){this._timeScale.applyOptions(e)}options(){return{...F(this._timeScale.options()),barSpacing:this._timeScale.barSpacing()}}_onVisibleBarsChanged(){this._timeRangeChanged.hasListeners()&&this._timeRangeChanged.fire(this.getVisibleRange())}_onVisibleLogicalRangeChanged(){this._logicalRangeChanged.hasListeners()&&this._logicalRangeChanged.fire(this.getVisibleLogicalRange())}_onSizeChanged(e){this._sizeChanged.fire(e.width,e.height)}}function Gn(s){if(s===void 0||s.type==="custom")return;const e=s;e.minMove!==void 0&&e.precision===void 0&&(e.precision=Ni(e.minMove))}function $n(s){if(Ce(s.handleScale)){const t=s.handleScale;s.handleScale={axisDoubleClickReset:{time:t,price:t},axisPressedMouseMove:{time:t,price:t},mouseWheel:t,pinch:t}}else if(s.handleScale!==void 0){const{axisPressedMouseMove:t,axisDoubleClickReset:i}=s.handleScale;Ce(t)&&(s.handleScale.axisPressedMouseMove={time:t,price:t}),Ce(i)&&(s.handleScale.axisDoubleClickReset={time:i,price:i})}const e=s.handleScroll;Ce(e)&&(s.handleScroll={horzTouchDrag:e,vertTouchDrag:e,mouseWheel:e,pressedMouseMove:e})}function oi(s){return $n(s),s}class jn{constructor(e,t,i){this._seriesMap=new Map,this._seriesMapReversed=new Map,this._clickedDelegate=new T,this._dblClickedDelegate=new T,this._crosshairMovedDelegate=new T,this._panes=new WeakMap,this._dataLayer=new Pn(t);const r=i===void 0?F(ri()):A(F(ri()),oi(i));this._horzScaleBehavior=t,this._chartWidget=new ln(e,r,t),this._chartWidget.clicked().subscribe(o=>{this._clickedDelegate.hasListeners()&&this._clickedDelegate.fire(this._convertMouseParams(o()))},this),this._chartWidget.dblClicked().subscribe(o=>{this._dblClickedDelegate.hasListeners()&&this._dblClickedDelegate.fire(this._convertMouseParams(o()))},this),this._chartWidget.crosshairMoved().subscribe(o=>{this._crosshairMovedDelegate.hasListeners()&&this._crosshairMovedDelegate.fire(this._convertMouseParams(o()))},this);const n=this._chartWidget.model();this._timeScaleApi=new Xn(n,this._chartWidget.timeAxisWidget(),this._horzScaleBehavior)}remove(){this._chartWidget.clicked().unsubscribeAll(this),this._chartWidget.dblClicked().unsubscribeAll(this),this._chartWidget.crosshairMoved().unsubscribeAll(this),this._timeScaleApi.destroy(),this._chartWidget.destroy(),this._seriesMap.clear(),this._seriesMapReversed.clear(),this._clickedDelegate.destroy(),this._dblClickedDelegate.destroy(),this._crosshairMovedDelegate.destroy(),this._dataLayer.destroy()}resize(e,t,i){this.autoSizeActive()||this._chartWidget.resize(e,t,i)}addCustomSeries(e,t={},i=0){const r=X(e),n=Rn(r);return this._addSeriesImpl(n,t,i)}addSeries(e,t={},i=0){return this._addSeriesImpl(e,t,i)}removeSeries(e){const t=V(this._seriesMap.get(e)),i=this._dataLayer.removeSeries(t);this._chartWidget.model().removeSeries(t),this._sendUpdateToChart(i),this._seriesMap.delete(e),this._seriesMapReversed.delete(t)}applyNewData(e,t){this._sendUpdateToChart(this._dataLayer.setSeriesData(e,t))}updateData(e,t,i){this._sendUpdateToChart(this._dataLayer.updateSeriesData(e,t,i))}subscribeClick(e){this._clickedDelegate.subscribe(e)}unsubscribeClick(e){this._clickedDelegate.unsubscribe(e)}subscribeCrosshairMove(e){this._crosshairMovedDelegate.subscribe(e)}unsubscribeCrosshairMove(e){this._crosshairMovedDelegate.unsubscribe(e)}subscribeDblClick(e){this._dblClickedDelegate.subscribe(e)}unsubscribeDblClick(e){this._dblClickedDelegate.unsubscribe(e)}priceScale(e,t=0){return new zi(this._chartWidget,e,t)}timeScale(){return this._timeScaleApi}applyOptions(e){this._chartWidget.applyOptions(oi(e))}options(){return this._chartWidget.options()}takeScreenshot(){return this._chartWidget.takeScreenshot()}addPane(e=!1){const t=this._chartWidget.model().addPane();return t.setPreserveEmptyPane(e),this._getPaneApi(t)}removePane(e){this._chartWidget.model().removePane(e)}swapPanes(e,t){this._chartWidget.model().swapPanes(e,t)}autoSizeActive(){return this._chartWidget.autoSizeActive()}chartElement(){return this._chartWidget.element()}panes(){return this._chartWidget.model().panes().map(e=>this._getPaneApi(e))}paneSize(e=0){const t=this._chartWidget.paneSize(e);return{height:t.height,width:t.width}}setCrosshairPosition(e,t,i){const r=this._seriesMap.get(i);if(r===void 0)return;const n=this._chartWidget.model().paneForSource(r);n!==null&&this._chartWidget.model().setAndSaveSyntheticPosition(e,t,n)}clearCrosshairPosition(){this._chartWidget.model().clearCurrentPosition(!0)}horzBehaviour(){return this._horzScaleBehavior}_addSeriesImpl(e,t={},i=0){k(Vn(e)),Gn(t.priceFormat),e.type==="Candlestick"&&Hi(t);const r=A(F(di),F(e.defaultOptions),t),n=e.createPaneView,o=new Oe(this._chartWidget.model(),e.type,r,n,e.customPaneView);this._chartWidget.model().addSeriesToPane(o,i);const a=new Yn(o,this,this,this,this._horzScaleBehavior,l=>this._getPaneApi(l));return this._seriesMap.set(a,o),this._seriesMapReversed.set(o,a),a}_sendUpdateToChart(e){const t=this._chartWidget.model();t.updateTimeScale(e.timeScale.baseIndex,e.timeScale.points,e.timeScale.firstChangedPointIndex),e.series.forEach((i,r)=>r.setData(i.data,i.info)),t.timeScale().recalculateIndicesWithData(),t.recalculateAllPanes()}_mapSeriesToApi(e){return V(this._seriesMapReversed.get(e))}_convertMouseParams(e){const t=new Map;e.seriesData.forEach((r,n)=>{const o=n.seriesType(),a=dt(o)(r);if(o!=="Custom")k(dn(a));else{const l=n.customSeriesWhitespaceCheck();k(!l||l(a)===!1)}t.set(this._mapSeriesToApi(n),a)});const i=e.hoveredSeries===void 0||!this._seriesMapReversed.has(e.hoveredSeries)?void 0:this._mapSeriesToApi(e.hoveredSeries);return{time:e.originalTime,logical:e.index,point:e.point,paneIndex:e.paneIndex,hoveredSeries:i,hoveredObjectId:e.hoveredObject,seriesData:t,sourceEvent:e.touchMouseEventData}}_getPaneApi(e){let t=this._panes.get(e);return t||(t=new Nn(this._chartWidget,i=>this._mapSeriesToApi(i),e,this),this._panes.set(e,t)),t}}function Kn(s){if(Se(s)){const e=document.getElementById(s);return k(e!==null,`Cannot find element in DOM with id=${s}`),e}return s}function qn(s,e,t){const i=Kn(s),r=new jn(i,e,t);return e.setOptions(r.options()),r}function vo(s,e){return qn(s,new Nt,Nt.applyDefaults(e))}class Pt extends Ai{constructor(e,t){super(e,t,!0)}_convertToCoordinates(e,t,i){t.indexesToCoordinates(this._items,ot(this._itemsVisibleRange)),e.pointsArrayToCoordinates(this._items,i,ot(this._itemsVisibleRange))}_createRawItemBase(e,t){return{time:e,price:t,x:NaN,y:NaN}}_fillRawPoints(){const e=this._series.barColorer();this._items=this._series.bars().rows().map(t=>{const i=t.value[C.Close];return this._createRawItem(t.index,i,e)})}}function Zn(s,e,t,i,r){if(i.to-i.from<=0)return;const{horizontalPixelRatio:n,verticalPixelRatio:o,context:a}=s;let l=null;const c=Math.max(1,Math.floor(n))%2/2,d=t*o+c;for(let u=i.to-1;u>=i.from;--u){const _=e[u];if(_){const p=r(s,_);p!==l&&(a.beginPath(),l!==null&&a.fill(),a.fillStyle=p,l=p);const f=Math.round(_.x*n)+c,g=_.y*o;a.moveTo(f,g),a.arc(f,g,d,0,Math.PI*2)}}a.fill()}function Di(s,e,t,i,r,n,o){if(e.length===0||i.from>=e.length||i.to<=0)return;const{context:a,horizontalPixelRatio:l,verticalPixelRatio:h}=s,c=e[i.from];let d=n(s,c),u=c;if(i.to-i.from<2){const _=r/2;a.beginPath();const p={x:c.x-_,y:c.y},f={x:c.x+_,y:c.y};a.moveTo(p.x*l,p.y*h),a.lineTo(f.x*l,f.y*h),o(s,d,p,f)}else{const _=(f,g)=>{o(s,d,u,g),a.beginPath(),d=f,u=g};let p=u;a.beginPath(),a.moveTo(c.x*l,c.y*h);for(let f=i.from+1;f<i.to;++f){p=e[f];const g=n(s,p);switch(t){case W.Simple:a.lineTo(p.x*l,p.y*h);break;case W.WithSteps:a.lineTo(p.x*l,e[f-1].y*h),g!==d&&(_(g,p),a.lineTo(p.x*l,e[f-1].y*h)),a.lineTo(p.x*l,p.y*h);break;case W.Curved:{const[S,v]=Jn(e,f-1,f);a.bezierCurveTo(S.x*l,S.y*h,v.x*l,v.y*h,p.x*l,p.y*h);break}}t!==W.WithSteps&&g!==d&&(_(g,p),a.moveTo(p.x*l,p.y*h))}(u!==p||u===p&&t===W.WithSteps)&&o(s,d,u,p)}}const ai=6;function nt(s,e){return{x:s.x-e.x,y:s.y-e.y}}function Qn(s,e){return{x:s.x+e.x,y:s.y+e.y}}function li(s,e){return{x:s.x/e,y:s.y/e}}function Jn(s,e,t){const i=Math.max(0,e-1),r=Math.min(s.length-1,t+1),n=Qn(s[e],li(nt(s[t],s[i]),ai)),o=nt(s[t],li(nt(s[r],s[e]),ai));return[n,o]}function eo(s,e){const t=s.context;t.strokeStyle=e,t.stroke()}class Ii extends Q{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}_drawImpl(e){if(this._data===null)return;const{items:t,visibleRange:i,barWidth:r,lineType:n,lineWidth:o,lineStyle:a,pointMarkersRadius:l}=this._data;if(i===null)return;const h=e.context;h.lineCap="butt",h.lineWidth=o*e.verticalPixelRatio,j(h,a),h.lineJoin="round";const c=this._strokeStyle.bind(this);n!==void 0&&Di(e,t,n,i,r,c,eo),l&&Zn(e,t,l,i,c)}}class Oi extends Ii{_strokeStyle(e,t){return t.lineColor}}class to extends Pt{constructor(){super(...arguments),this._renderer=new Oi}_createRawItem(e,t,i){return{...this._createRawItemBase(e,t),...i.barStyle(e)}}_prepareRendererData(){const e=this._series.options(),t={items:this._items,lineStyle:e.lineStyle,lineType:e.lineVisible?e.lineType:void 0,lineWidth:e.lineWidth,pointMarkersRadius:e.pointMarkersVisible?e.pointMarkersRadius||e.lineWidth/2+2:void 0,visibleRange:this._itemsVisibleRange,barWidth:this._model.timeScale().barSpacing()};this._renderer.setData(t)}}const io={color:"#2196f3",lineStyle:z.Solid,lineWidth:3,lineType:W.Simple,lineVisible:!0,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,crosshairMarkerBorderColor:"",crosshairMarkerBorderWidth:2,crosshairMarkerBackgroundColor:"",lastPriceAnimation:O.Disabled,pointMarkersVisible:!1},so=(s,e)=>new to(s,e),ro=()=>({type:"Line",isBuiltIn:!0,defaultOptions:io,createPaneView:so}),bo=ro();function no(s,e,t,i,r){const{context:n,horizontalPixelRatio:o,verticalPixelRatio:a}=e;n.lineTo(r.x*o,s*a),n.lineTo(i.x*o,s*a),n.closePath(),n.fillStyle=t,n.fill()}class Wi extends Q{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}_drawImpl(e){if(this._data===null)return;const{items:t,visibleRange:i,barWidth:r,lineWidth:n,lineStyle:o,lineType:a}=this._data,l=this._data.baseLevelCoordinate??(this._data.invertFilledArea?0:e.mediaSize.height);if(i===null)return;const h=e.context;h.lineCap="butt",h.lineJoin="round",h.lineWidth=n,j(h,o),h.lineWidth=1,Di(e,t,a,i,r,this._fillStyle.bind(this),no.bind(null,l))}}class wt{get(e,t){const i=this._params,{topColor1:r,topColor2:n,bottomColor1:o,bottomColor2:a,baseLevelCoordinate:l,topCoordinate:h,bottomCoordinate:c}=t;if(this._cachedValue===void 0||i===void 0||i.topColor1!==r||i.topColor2!==n||i.bottomColor1!==o||i.bottomColor2!==a||i.baseLevelCoordinate!==l||i.topCoordinate!==h||i.bottomCoordinate!==c){const{verticalPixelRatio:d}=e,u=l||h>0?d:1,_=h*u,p=c===e.bitmapSize.height?c:c*u,f=(l??0)*u,g=e.context.createLinearGradient(0,_,0,p);if(g.addColorStop(0,r),l!=null){const S=p-_,v=te((f-_)/S,0,1);g.addColorStop(v,n),g.addColorStop(v,o)}g.addColorStop(1,a),this._cachedValue=g,this._params=t}return this._cachedValue}}class oo extends Wi{constructor(){super(...arguments),this._fillCache=new wt}_fillStyle(e,t){const i=this._data;return this._fillCache.get(e,{topColor1:t.topFillColor1,topColor2:t.topFillColor2,bottomColor1:t.bottomFillColor1,bottomColor2:t.bottomFillColor2,baseLevelCoordinate:i.baseLevelCoordinate,topCoordinate:i.topCoordinate??0,bottomCoordinate:i.bottomCoordinate??e.bitmapSize.height})}}class ao extends Ii{constructor(){super(...arguments),this._strokeCache=new wt}_strokeStyle(e,t){const i=this._data;return this._strokeCache.get(e,{topColor1:t.topLineColor,topColor2:t.topLineColor,bottomColor1:t.bottomLineColor,bottomColor2:t.bottomLineColor,baseLevelCoordinate:i.baseLevelCoordinate,topCoordinate:i.topCoordinate??0,bottomCoordinate:i.bottomCoordinate??e.bitmapSize.height})}}class lo extends Pt{constructor(e,t){super(e,t),this._renderer=new _t,this._baselineAreaRenderer=new oo,this._baselineLineRenderer=new ao,this._renderer.setRenderers([this._baselineAreaRenderer,this._baselineLineRenderer])}_createRawItem(e,t,i){return{...this._createRawItemBase(e,t),...i.barStyle(e)}}_prepareRendererData(){const e=this._series.firstValue();if(e===null)return;const t=this._series.options(),i=this._series.priceScale().priceToCoordinate(t.baseValue.price,e.value),r=this._model.timeScale().barSpacing();if(this._itemsVisibleRange===null||this._items.length===0)return;let n,o;if(t.relativeGradient){n=this._items[this._itemsVisibleRange.from].y,o=this._items[this._itemsVisibleRange.from].y;for(let a=this._itemsVisibleRange.from;a<this._itemsVisibleRange.to;a++){const l=this._items[a];l.y<n&&(n=l.y),l.y>o&&(o=l.y)}}this._baselineAreaRenderer.setData({items:this._items,lineWidth:t.lineWidth,lineStyle:t.lineStyle,lineType:t.lineType,baseLevelCoordinate:i,topCoordinate:n,bottomCoordinate:o,invertFilledArea:!1,visibleRange:this._itemsVisibleRange,barWidth:r}),this._baselineLineRenderer.setData({items:this._items,lineWidth:t.lineWidth,lineStyle:t.lineStyle,lineType:t.lineVisible?t.lineType:void 0,pointMarkersRadius:t.pointMarkersVisible?t.pointMarkersRadius||t.lineWidth/2+2:void 0,baseLevelCoordinate:i,topCoordinate:n,bottomCoordinate:o,visibleRange:this._itemsVisibleRange,barWidth:r})}}const ho={baseValue:{type:"price",price:0},relativeGradient:!1,topFillColor1:"rgba(38, 166, 154, 0.28)",topFillColor2:"rgba(38, 166, 154, 0.05)",topLineColor:"rgba(38, 166, 154, 1)",bottomFillColor1:"rgba(239, 83, 80, 0.05)",bottomFillColor2:"rgba(239, 83, 80, 0.28)",bottomLineColor:"rgba(239, 83, 80, 1)",lineWidth:3,lineStyle:z.Solid,lineType:W.Simple,lineVisible:!0,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,crosshairMarkerBorderColor:"",crosshairMarkerBorderWidth:2,crosshairMarkerBackgroundColor:"",lastPriceAnimation:O.Disabled,pointMarkersVisible:!1},co=(s,e)=>new lo(s,e),uo=()=>({type:"Baseline",isBuiltIn:!0,defaultOptions:ho,createPaneView:co}),Co=uo();class _o extends Wi{constructor(){super(...arguments),this._fillCache=new wt}_fillStyle(e,t){var i;return this._fillCache.get(e,{topColor1:t.topColor,topColor2:"",bottomColor1:"",bottomColor2:t.bottomColor,topCoordinate:((i=this._data)==null?void 0:i.topCoordinate)??0,bottomCoordinate:e.bitmapSize.height})}}class po extends Pt{constructor(e,t){super(e,t),this._renderer=new _t,this._areaRenderer=new _o,this._lineRenderer=new Oi,this._renderer.setRenderers([this._areaRenderer,this._lineRenderer])}_createRawItem(e,t,i){return{...this._createRawItemBase(e,t),...i.barStyle(e)}}_prepareRendererData(){const e=this._series.options();if(this._itemsVisibleRange===null||this._items.length===0)return;let t;if(e.relativeGradient){t=this._items[this._itemsVisibleRange.from].y;for(let i=this._itemsVisibleRange.from;i<this._itemsVisibleRange.to;i++){const r=this._items[i];r.y<t&&(t=r.y)}}this._areaRenderer.setData({lineType:e.lineType,items:this._items,lineStyle:e.lineStyle,lineWidth:e.lineWidth,baseLevelCoordinate:null,topCoordinate:t,invertFilledArea:e.invertFilledArea,visibleRange:this._itemsVisibleRange,barWidth:this._model.timeScale().barSpacing()}),this._lineRenderer.setData({lineType:e.lineVisible?e.lineType:void 0,items:this._items,lineStyle:e.lineStyle,lineWidth:e.lineWidth,visibleRange:this._itemsVisibleRange,barWidth:this._model.timeScale().barSpacing(),pointMarkersRadius:e.pointMarkersVisible?e.pointMarkersRadius||e.lineWidth/2+2:void 0})}}const mo={topColor:"rgba( 46, 220, 135, 0.4)",bottomColor:"rgba( 40, 221, 100, 0)",invertFilledArea:!1,relativeGradient:!1,lineColor:"#33D778",lineStyle:z.Solid,lineWidth:3,lineType:W.Simple,lineVisible:!0,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,crosshairMarkerBorderColor:"",crosshairMarkerBorderWidth:2,crosshairMarkerBackgroundColor:"",lastPriceAnimation:O.Disabled,pointMarkersVisible:!1},fo=(s,e)=>new po(s,e),go=()=>({type:"Area",isBuiltIn:!0,defaultOptions:mo,createPaneView:fo}),Po=go(),wo={...di,...Xi};export{Q as B,N as C,O as L,ge as M,C as P,Ai as S,wo as a,Po as b,vo as c,pt as d,Co as e,Mi as f,So as g,z as h,gt as i,bo as l,ot as u};
